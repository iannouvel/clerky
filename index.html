<!DOCTYPE html>
<!-- Version: three-column-layout-v2 -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clerky</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="tiptap-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <!-- Cookie consent script -->
    <script src="cookie-consent.js" defer></script>
    
    <!-- Load TipTap dependencies -->
    <script src="https://unpkg.com/@tiptap/core@2.0.3/dist/tiptap-core.umd.min.js"></script>
    <script src="https://unpkg.com/@tiptap/starter-kit@2.0.3/dist/tiptap-starter-kit.umd.min.js"></script>
    <script src="https://unpkg.com/@tiptap/extension-placeholder@2.0.3/dist/tiptap-extension-placeholder.umd.min.js"></script>
    
    <style>
        /* Add this to your existing styles */
        .top-bar-center {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            margin: 0 5px;
        }

        /* Set minimum height for text areas */
        #summary {
            min-height: 300px;
        }

        #suggestedGuidelines {
            min-height: 200px;
        }

        /* Add styles for model toggle */
        .model-toggle {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            margin-left: 15px;
        }

        .model-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .model-toggle.active {
            background: rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Add spinner animation for model toggle */
        .model-toggle .spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
            margin-right: 5px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .model-toggle:disabled {
            opacity: 0.7;
            cursor: wait;
        }
        
        /* Critical three-column layout fixes */
        #threeColumnView {
            display: grid !important;
            grid-template-columns: 10fr 70fr 20fr !important;
            grid-template-areas: "history transcript issues" !important;
            width: 100% !important;
            gap: 16px !important;
        }
        
        #historyColumn {
            grid-area: history !important;
            width: 100% !important;
            min-width: 0 !important;
        }
        
        #transcriptColumn {
            grid-area: transcript !important;
            width: 100% !important;
            min-width: 0 !important;
        }
        
        #issuesColumn {
            grid-area: issues !important;
            width: 100% !important;
            min-width: 0 !important;
        }
        
        /* Responsive override for mobile */
        @media (max-width: 768px) {
            #threeColumnView {
                grid-template-columns: 1fr !important;
                grid-template-rows: auto auto auto !important;
                grid-template-areas: 
                    "transcript"
                    "history"
                    "issues" !important;
            }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">Loading...</div>
    
    <!-- Landing Page -->
    <div id="landingPage" class="landing-page hidden">
        <h1>clerky</h1>      
        <button id="googleSignInBtn">Sign in with Google</button>
    </div>
    
    <!-- Main Application -->
    <div id="mainContent" class="hidden">
        <div class="top-bar">
            <div class="top-bar-left">
                <a href="index.html" class="logo-link">
                    <div class="logo">clerky</div>
                </a>
                <button id="modelToggle" class="model-toggle">AI: DeepSeek (deepseek-chat)</button>
            </div>
            <div class="top-bar-center">
                <button id="testBtn" class="nav-btn">
                    <span id="testSpinner" class="spinner" style="display: none;">&#x21BB;</span>
                    <span id="testText">Test</span>
                </button>
                <button id="directFakeTranscriptBtn" class="nav-btn">
                    <span id="directFakeTranscriptSpinner" class="spinner" style="display: none;">&#x21BB;</span>
                    <span id="directFakeTranscriptText">Generate Transcript</span>
                </button>
                <button id="promptsBtn" class="nav-btn">Prompts</button>
                <button id="guidelinesBtn" class="nav-btn">Guidelines</button>
                <button id="recordBtn" class="nav-btn">
                    <span id="recordSymbol" class="record-symbol"></span>Record
                </button>
                <button id="actionBtn" class="nav-btn">
                    <span id="actionSpinner" class="spinner" style="display: none;">&#x21BB;</span>
                    <span id="actionText">Process</span>
                </button>
                <button id="generateClinicalNoteBtn" class="nav-btn">
                    <span id="spinner" class="spinner" style="display: none;">&#x21BB;</span>
                    <span id="generateText">Generate</span>
                </button>
                <button id="xCheckBtn" class="nav-btn">
                    <span id="xCheckSpinner" class="spinner" style="display: none;">&#x21BB;</span>
                    <span id="xCheckText">Verify</span>
                </button>
                <button id="devBtn" class="nav-btn">Dev</button>
            </div>
            <div class="right-content">
                <div class="far-right">
                    <div class="user-info">
                        <span id="userLabel">User:</span>
                        <span id="userName" class="user-name hidden">User Name</span>
                    </div>
                    <button id="signOutBtn">Sign Out</button>
                </div>
            </div>
        </div>
        <div id="mainSection" class="container">
            <!-- Workflows View (initially hidden) -->
            <div id="workflowsView" class="hidden">
                <div class="workflows-container">
                    <h2>GitHub Workflows</h2>
                    <div class="workflow-buttons">
                        <button id="processPdfBtn" class="workflow-btn">
                            <span id="processPdfSpinner" class="spinner" style="display: none;">&#x21BB;</span>
                            <span>Process PDF</span>
                        </button>
                        <button id="extractTermsBtn" class="workflow-btn">
                            <span id="extractTermsSpinner" class="spinner" style="display: none;">&#x21BB;</span>
                            <span>Extract Terms</span>
                        </button>
                        <button id="generateSummaryBtn" class="workflow-btn">
                            <span id="generateSummarySpinner" class="spinner" style="display: none;">&#x21BB;</span>
                            <span>Generate Summary</span>
                        </button>
                    </div>
                    <div id="workflowStatus" class="workflow-status"></div>
                </div>
            </div>
            <!-- Three Column View - clean version -->
            <div id="threeColumnView">
                <div id="historyColumn" class="column">
                    <div id="history" class="tiptap-editor" placeholder="Enter patient history here..."></div>
                </div>
                <div id="transcriptColumn" class="column">
                    <div class="transcript-tabs">
                        <div class="transcript-tab active" data-tab="1">
                            <span class="tab-close">&times;</span>
                        </div>
                        <div class="transcript-tab" data-tab="2">
                            <span class="tab-close">&times;</span>
                        </div>
                        <div class="transcript-tab" data-tab="3">
                            <span class="tab-close">&times;</span>
                        </div>
                        <div class="transcript-tab" data-tab="4">
                            <span class="tab-close">&times;</span>
                        </div>
                        <div class="transcript-tab" data-tab="5">
                            <span class="tab-close">&times;</span>
                        </div>
                        <div class="new-tab">+</div>
                    </div>
                    <div class="transcript-content">
                        <div id="summary1" class="transcript-pane active tiptap-editor" placeholder="Enter transcript here..."></div>
                        <div id="summary2" class="transcript-pane tiptap-editor" placeholder="Enter transcript here..."></div>
                        <div id="summary3" class="transcript-pane tiptap-editor" placeholder="Enter transcript here..."></div>
                        <div id="summary4" class="transcript-pane tiptap-editor" placeholder="Enter transcript here..."></div>
                        <div id="summary5" class="transcript-pane tiptap-editor" placeholder="Enter transcript here..."></div>
                    </div>
                    <!-- Hidden div to maintain compatibility with existing code -->
                    <div id="clinicalNoteOutput" class="tiptap-editor hidden" style="display: none;"></div>
                </div>
                <div id="issuesColumn" class="column">
                    <div class="column-header">Issues <button id="addIssueBtn" class="add-issue-btn">+</button></div>
                    <div id="suggestedGuidelines" class="accordion-container"></div>
                </div>
            </div>
            
            <!-- Proforma View (initially hidden) -->
            <div id="proformaView" class="hidden">
                <div class="left-column">
                    <div class="column-header">Transcript</div>
                    <textarea rows="20" id="proformaSummary"></textarea>
                </div>
                <div class="right-column">
                    <div class="column-header">
                        <div class="proforma-header">
                            <div class="proforma-toggle">
                                <button id="obsProformaBtn" class="proforma-toggle-btn active">Obstetric</button>
                                <button id="gynProformaBtn" class="proforma-toggle-btn">Gynaecology</button>
                            </div>
                            <button id="populateProformaBtn" class="populate-btn">
                                <span id="populateSpinner" class="spinner" style="display: none;">&#x21BB;</span>
                                <span id="populateText">Populate</span>
                            </button>
                        </div>
                    </div>
                    <div id="proformaContent">
                        <!-- Obstetric Proforma (default) -->
                        <div id="obsProforma" class="proforma-template">
                            <h3>Obstetric Assessment</h3>
                            <div class="proforma-section">
                                <h4>Demographics</h4>
                                <div class="form-row">
                                    <label for="obs-name">Name:</label>
                                    <input type="text" id="obs-name" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-age">Age:</label>
                                    <input type="text" id="obs-age" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-hospital-no">Hospital No:</label>
                                    <input type="text" id="obs-hospital-no" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-date">Date:</label>
                                    <input type="date" id="obs-date" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-time">Time:</label>
                                    <input type="time" id="obs-time" class="proforma-input">
                                </div>
                            </div>
                            <div class="proforma-section">
                                <h4>Obstetric History</h4>
                                <div class="form-row">
                                    <label for="obs-gravida">Gravida:</label>
                                    <input type="text" id="obs-gravida" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-para">Para:</label>
                                    <input type="text" id="obs-para" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-edd">EDD:</label>
                                    <input type="date" id="obs-edd" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-gestation">Gestation:</label>
                                    <input type="text" id="obs-gestation" class="proforma-input">
                                    <span>weeks</span>
                                </div>
                                <div class="form-row">
                                    <label for="obs-prev-deliveries">Previous Deliveries:</label>
                                    <textarea id="obs-prev-deliveries" class="proforma-input" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="proforma-section">
                                <h4>Current Pregnancy</h4>
                                <div class="form-row">
                                    <label for="obs-antenatal-care">Antenatal Care:</label>
                                    <select id="obs-antenatal-care" class="proforma-input">
                                        <option value="">Select...</option>
                                        <option value="regular">Regular</option>
                                        <option value="irregular">Irregular</option>
                                    </select>
                                </div>
                                <div class="form-row">
                                    <label for="obs-blood-group">Blood Group:</label>
                                    <input type="text" id="obs-blood-group" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-rhesus">Rhesus:</label>
                                    <input type="text" id="obs-rhesus" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-bmi">Booking BMI:</label>
                                    <input type="text" id="obs-bmi" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-complications">Complications:</label>
                                    <textarea id="obs-complications" class="proforma-input" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="proforma-section">
                                <h4>Current Assessment</h4>
                                <div class="form-row">
                                    <label for="obs-presenting-complaint">Presenting Complaint:</label>
                                    <textarea id="obs-presenting-complaint" class="proforma-input" rows="2"></textarea>
                                </div>
                                <div class="form-row">
                                    <label for="obs-contractions">Contractions:</label>
                                    <select id="obs-contractions" class="proforma-input">
                                        <option value="">Select...</option>
                                        <option value="true">Yes</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                                <div class="form-row">
                                    <label for="obs-fetal-movements">Fetal Movements:</label>
                                    <select id="obs-fetal-movements" class="proforma-input">
                                        <option value="">Select...</option>
                                        <option value="normal">Normal</option>
                                        <option value="reduced">Reduced</option>
                                    </select>
                                </div>
                                <div class="form-row">
                                    <label for="obs-vaginal-loss">Vaginal Loss:</label>
                                    <select id="obs-vaginal-loss" class="proforma-input">
                                        <option value="">Select...</option>
                                        <option value="none">None</option>
                                        <option value="show">Show</option>
                                        <option value="liquor">Liquor</option>
                                        <option value="blood">Blood</option>
                                    </select>
                                </div>
                            </div>
                            <div class="proforma-section">
                                <h4>Examination</h4>
                                <div class="form-row">
                                    <label for="obs-bp">BP:</label>
                                    <input type="text" id="obs-bp" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-pulse">Pulse:</label>
                                    <input type="text" id="obs-pulse" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-temp">Temp:</label>
                                    <input type="text" id="obs-temp" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-fundal-height">Fundal Height:</label>
                                    <input type="text" id="obs-fundal-height" class="proforma-input">
                                    <span>cm</span>
                                </div>
                                <div class="form-row">
                                    <label for="obs-lie">Lie:</label>
                                    <input type="text" id="obs-lie" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-presentation">Presentation:</label>
                                    <input type="text" id="obs-presentation" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-fh">FH:</label>
                                    <input type="text" id="obs-fh" class="proforma-input">
                                    <span>bpm</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Gynaecology Proforma (initially hidden) -->
                        <div id="gynProforma" class="proforma-template hidden">
                            <h3>Gynaecology Assessment</h3>
                            <div class="proforma-section">
                                <h4>Demographics</h4>
                                <div class="form-row">
                                    <label for="gyn-name">Name:</label>
                                    <input type="text" id="gyn-name" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="gyn-age">Age:</label>
                                    <input type="text" id="gyn-age" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="gyn-hospital-no">Hospital No:</label>
                                    <input type="text" id="gyn-hospital-no" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="gyn-date">Date:</label>
                                    <input type="date" id="gyn-date" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="gyn-time">Time:</label>
                                    <input type="time" id="gyn-time" class="proforma-input">
                                </div>
                            </div>
                            <div class="proforma-section">
                                <h4>Presenting Complaint</h4>
                                <textarea class="proforma-input" rows="2"></textarea>
                            </div>
                            <div class="proforma-section">
                                <h4>Gynaecological History</h4>
                                <p>LMP: ___/___/___</p>
                                <p>Menstrual Cycle: Regular □ Irregular □</p>
                                <p>Contraception: ________________</p>
                                <p>Previous Gynae Surgery:</p>
                                <textarea class="proforma-input" rows="2"></textarea>
                            </div>
                            <div class="proforma-section">
                                <h4>Obstetric History</h4>
                                <p>Gravida: _____ Para: _____</p>
                                <textarea class="proforma-input" rows="2"></textarea>
                            </div>
                            <div class="proforma-section">
                                <h4>Examination</h4>
                                <p>BP: _____ Pulse: _____ Temp: _____</p>
                                <p>Abdominal Examination:</p>
                                <textarea class="proforma-input" rows="2"></textarea>
                                <p>Vaginal Examination:</p>
                                <textarea class="proforma-input" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="promptsSection" class="container hidden">
            <div id="promptsContainer" class="prompts-container">
                <div class="prompt-group">
                    <label for="promptIssues">Prompt for issues:</label>
                    <textarea id="promptIssues">
        Please determine the significant clinical issues within this clinical scenario, ie if the patient has had as BMI of 45, return: 'Morbid obesity: BMI 45'. 
        Do not list risks, this will be done by the user. 
        Please provide the issues as a list from most clinically important to least.
                    </textarea>
                </div>
                <div class="prompt-group">
                    <label for="promptGuidelines">Prompt for guidelines:</label>
                    <textarea id="promptGuidelines">
        Please provide filenames of the 3 most relevant guidelines for the following clinical text. 
        Please only list the filenames, without prior or trailing text.
        The significant terms are listed line-by-line as filenames followed by their associated 
        significant terms:
                    </textarea>
                </div>
                <div class="prompt-group">
                    <label for="promptNoteGenerator">Prompt for note generator:</label>
                    <textarea id="promptNoteGenerator">
        The following is a transcript from a clinical consultation.
        Please write a concise clinical note using medical terminology 
        suitable for healthcare professionals. 
        Please write the note from the perspective of the clinician.
        Please use the following structure, without actually writing the headings: Situation, Issues and Plan.
        If the clinical context is a current pregnancy, please summarise the situation as follows:
        Age, Parity - Previous mode of delivery, Gestation, BMI, Rhesus Status, for example: "36yo, P2 - previous SVD followed by EMCS, 33+2 weeks, BMI 22, Rh+ve"
        Please summarise the issues as single line items with the associated discussion regarding the context, risks etc included.
        Please try to include all the information discussed, where necessary to demonstrate concision and avoid repetition.
        Thank you.
        Here follows the transcript:
                    </textarea>
                </div>
                <button id="savePromptsBtn">Save Prompts</button>
            </div>
        </div>
        <div id="guidelinesSection" class="container hidden">
            <div id="guidelinesContainer" class="guidelines-container">
                <h2>Guidelines</h2>
                <ul id="guidelinesList"></ul>
            </div>
        </div>
        <div id="devSection" class="container hidden">
            <div id="devContainer" class="dev-container">
                <h2>Development Tools</h2>
                <div class="dev-tools">
                    <div class="tool-group">
                        <h3>GitHub Permissions</h3>
                        <div id="githubPermissions"></div>
                    </div>
                    <div class="tool-group">
                        <h3>API Tests</h3>
                        <button id="testServerBtn" class="dev-btn">Test Server Connection</button>
                        <button id="testGitHubBtn" class="dev-btn">Test GitHub Access</button>
                        <button id="testOpenAIBtn" class="dev-btn">Test OpenAI Access</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="linksSection" class="container hidden">
            <div id="linksContainer" class="links-container">
                <h2>Links</h2>
                <ul id="linksList"></ul>
            </div>
        </div>
    </div>
    <!-- Include Firebase initialization -->
    <script type="module" src="firebase-init.js"></script>

    <!-- Replace TipTap ES module with inline script -->
    <script>
        // TipTap initialization - will be executed when DOM is loaded
        window.initializeTipTap = function(element, placeholder = 'Start typing...') {
            if (!element) {
                console.error('TipTap initialization failed: Element not found');
                return createFallbackEditor(null, placeholder);
            }
            
            // Check if element already has an editor initialized
            if (element._tiptapEditor) {
                console.log('Editor already initialized for element:', element.id);
                return element._tiptapEditor;
            }
            
            // Check if TipTap libraries are available
            if (!window.tiptap || !window.tiptap.Editor) {
                console.error('TipTap libraries not loaded properly, using fallback');
                return createFallbackEditor(element, placeholder);
            }
            
            try {
                // Get placeholder from element attribute or parameter
                const placeholderText = element.getAttribute('placeholder') || placeholder;
                
                // Safely prepare extensions array
                let extensions = [];
                try {
                    // Only add extensions that are actually available
                    if (window.tiptap.StarterKit) {
                        extensions.push(window.tiptap.StarterKit.configure({}));
                    }
                    
                    if (window.tiptap.Placeholder) {
                        extensions.push(window.tiptap.Placeholder.configure({
                            placeholder: placeholderText,
                        }));
                    }
                } catch (extensionError) {
                    console.error('Error configuring TipTap extensions:', extensionError);
                }
                
                // Store existing content
                const existingContent = element.innerHTML || '';
                
                // Create the editor with error handling
                let editor;
                try {
                    editor = new window.tiptap.Editor({
                        element: element,
                        extensions: extensions,
                        content: existingContent,
                        onUpdate: ({ editor }) => {
                            try {
                                // Dispatch a custom event
                                const event = new CustomEvent('tiptap-update', { 
                                    detail: { 
                                        html: editor.getHTML(),
                                        text: editor.getText() 
                                    } 
                                });
                                element.dispatchEvent(event);
                            } catch (updateError) {
                                console.error('Error in TipTap update handler:', updateError);
                            }
                        },
                    });
                    
                    // Store the editor on the element
                    element._tiptapEditor = editor;
                } catch (editorError) {
                    console.error('Failed to create TipTap editor, using fallback:', editorError);
                    return createFallbackEditor(element, placeholderText);
                }
                
                // Skip toolbar creation for summary and clinicalNoteOutput
                if (element.id === 'summary' || element.id === 'clinicalNoteOutput' || element.id === 'history' ||
                    element.classList.contains('transcript-pane')) {
                    return editor;
                }
                
                // Create toolbar container
                try {
                    const toolbar = document.createElement('div');
                    toolbar.className = 'tiptap-toolbar';
                    toolbar.setAttribute('data-for', element.id); // Add data attribute for CSS targeting
                    
                    // Create buttons
                    const buttons = [
                        { icon: '<i class="fas fa-bold"></i>', title: 'Bold', action: () => editor.chain().focus().toggleBold().run() },
                        { icon: '<i class="fas fa-italic"></i>', title: 'Italic', action: () => editor.chain().focus().toggleItalic().run() },
                        { icon: '<i class="fas fa-heading"></i><sup>1</sup>', title: 'Heading 1', action: () => editor.chain().focus().toggleHeading({ level: 1 }).run() },
                        { icon: '<i class="fas fa-heading"></i><sup>2</sup>', title: 'Heading 2', action: () => editor.chain().focus().toggleHeading({ level: 2 }).run() },
                        { icon: '<i class="fas fa-list-ul"></i>', title: 'Bullet List', action: () => editor.chain().focus().toggleBulletList().run() },
                        { icon: '<i class="fas fa-list-ol"></i>', title: 'Numbered List', action: () => editor.chain().focus().toggleOrderedList().run() },
                    ];
                    
                    // Add buttons to toolbar with error handling
                    const buttonElements = buttons.map(btnConfig => {
                        try {
                            const button = document.createElement('button');
                            button.type = 'button';
                            button.innerHTML = btnConfig.icon;
                            button.title = btnConfig.title;
                            button.addEventListener('click', function(e) {
                                e.preventDefault();
                                try {
                                    btnConfig.action();
                                } catch (actionError) {
                                    console.error('Error in button action:', actionError);
                                }
                            });
                            toolbar.appendChild(button);
                            return button;
                        } catch (buttonError) {
                            console.error('Error creating toolbar button:', buttonError);
                            return null;
                        }
                    }).filter(Boolean); // Remove any nulls from errors
                    
                    // Insert toolbar before the editor
                    element.parentNode.insertBefore(toolbar, element);
                    
                    // Update active states
                    try {
                        editor.on('selectionUpdate', () => {
                            buttonElements.forEach((button, index) => {
                                try {
                                    switch(index) {
                                        case 0: button.classList.toggle('is-active', editor.isActive('bold')); break;
                                        case 1: button.classList.toggle('is-active', editor.isActive('italic')); break;
                                        case 2: button.classList.toggle('is-active', editor.isActive('heading', { level: 1 })); break;
                                        case 3: button.classList.toggle('is-active', editor.isActive('heading', { level: 2 })); break;
                                        case 4: button.classList.toggle('is-active', editor.isActive('bulletList')); break;
                                        case 5: button.classList.toggle('is-active', editor.isActive('orderedList')); break;
                                    }
                                } catch (activeError) {
                                    console.error('Error updating button active state:', activeError);
                                }
                            });
                        });
                    } catch (selectionError) {
                        console.error('Error setting up TipTap selection handlers:', selectionError);
                    }
                } catch (toolbarError) {
                    console.error('Error creating toolbar:', toolbarError);
                }
                
                return editor;
            } catch (error) {
                console.error('Error initializing TipTap editor:', error);
                return createFallbackEditor(element, placeholder);
            }
        };
        
        // Helper function to create fallback editor
        function createFallbackEditor(element, placeholder) {
            console.log('Creating fallback editor for element:', element ? element.id : 'null');
            
            if (!element) {
                return {
                    commands: { setContent: function() {} },
                    getHTML: function() { return ''; },
                    getText: function() { return ''; },
                    chain: function() { return { focus: function() { return { 
                        toggleBold: function() { return { run: function() {} }; },
                        toggleItalic: function() { return { run: function() {} }; },
                        toggleHeading: function() { return { run: function() {} }; },
                        toggleBulletList: function() { return { run: function() {} }; },
                        toggleOrderedList: function() { return { run: function() {} }; }
                    }; } }; }
                };
            }
            
            const textarea = document.createElement('textarea');
            textarea.className = 'fallback-editor';
            textarea.placeholder = placeholder;
            
            // Preserve any existing content
            try {
                textarea.value = element.innerHTML || '';
            } catch (e) {
                console.error('Error setting textarea value:', e);
            }
            
            // Clear the element and append the textarea
            try {
                element.innerHTML = '';
                element.appendChild(textarea);
            } catch (e) {
                console.error('Error appending textarea to element:', e);
            }
            
            // Add event listener to mimic TipTap update events
            try {
                textarea.addEventListener('input', function() {
                    const event = new CustomEvent('tiptap-update', { 
                        detail: { 
                            html: textarea.value,
                            text: textarea.value 
                        } 
                    });
                    element.dispatchEvent(event);
                });
            } catch (e) {
                console.error('Error adding event listener to textarea:', e);
            }
            
            // Create a minimal API matching TipTap's
            const fallbackAPI = {
                getHTML: function() { return textarea.value; },
                getText: function() { return textarea.value; },
                commands: { 
                    setContent: function(content) { 
                        textarea.value = content; 
                    } 
                },
                chain: function() { 
                    return { 
                        focus: function() { 
                            return {
                                toggleBold: function() { return { run: function() {} }; },
                                toggleItalic: function() { return { run: function() {} }; },
                                toggleHeading: function() { return { run: function() {} }; },
                                toggleBulletList: function() { return { run: function() {} }; },
                                toggleOrderedList: function() { return { run: function() {} }; }
                            };
                        } 
                    }; 
                },
                on: function() {} // Stub for event handling
            };
            
            // Store the API on the element
            element._tiptapEditor = fallbackAPI;
            
            return fallbackAPI;
        }
        
        // Helper functions for getting/setting content
        window.getEditorContent = function(editor, format = 'html') {
            if (!editor) {
                console.warn('No editor provided to getEditorContent');
                return '';
            }
            
            try {
                // Handle both TipTap and fallback editors
                if (typeof editor.getHTML === 'function') {
                    return format === 'html' ? editor.getHTML() : editor.getText();
                } else if (editor.value !== undefined) {
                    // Might be a textarea fallback
                    return editor.value;
                }
            } catch (error) {
                console.error('Error in getEditorContent:', error);
            }
            
            return '';
        };
        
        window.setEditorContent = function(editor, content, format = 'html') {
            if (!editor) {
                console.warn('No editor provided to setEditorContent');
                return;
            }
            
            try {
                // Handle both TipTap and fallback editors
                if (editor.commands && typeof editor.commands.setContent === 'function') {
                    editor.commands.setContent(content);
                } else if (editor.value !== undefined) {
                    // Might be a textarea fallback
                    editor.value = content;
                }
            } catch (error) {
                console.error('Error in setEditorContent:', error);
            }
        };

        // Create namespaces for TipTap if not available
        if (typeof window.tiptap === 'undefined') {
            window.tiptap = {};
            // Add references to the libraries if they exist
            if (typeof tiptap !== 'undefined') window.tiptap = tiptap;
            if (typeof StarterKit !== 'undefined') window.tiptap.StarterKit = StarterKit;
            if (typeof Placeholder !== 'undefined') window.tiptap.Placeholder = Placeholder;
        }

        // Ensure TipTap is ready and available
        document.addEventListener('DOMContentLoaded', function() {
            if (!window.tiptap.Editor) {
                console.warn('TipTap Editor not loaded correctly, attempting to fix...');
                // Try to find TipTap objects in the global scope
                if (typeof tiptap !== 'undefined') window.tiptap = tiptap;
            }
            
            // Make sure the columns are properly positioned when the page loads
            const fixColumnLayout = () => {
                const threeColumnView = document.getElementById('threeColumnView');
                const historyColumn = document.getElementById('historyColumn');
                const transcriptColumn = document.getElementById('transcriptColumn');
                const issuesColumn = document.getElementById('issuesColumn');
                
                if (threeColumnView && historyColumn && transcriptColumn && issuesColumn) {
                    // Force layout recalculation in case something broke it
                    threeColumnView.style.display = 'grid';
                    const columnWidth = window.innerWidth > 768 
                        ? ['10fr', '70fr', '20fr']
                        : ['1fr'];
                    
                    if (window.innerWidth > 768) {
                        threeColumnView.style.gridTemplateColumns = columnWidth.join(' ');
                        threeColumnView.style.gridTemplateAreas = '"history transcript issues"';
                    } else {
                        threeColumnView.style.gridTemplateColumns = columnWidth[0];
                        threeColumnView.style.gridTemplateAreas = '"transcript" "history" "issues"';
                    }
                }
            };
            
            // Apply layout fixes when page loads
            fixColumnLayout();
            
            // Also fix layout on window resize
            window.addEventListener('resize', fixColumnLayout);
        });
    </script>

    <!-- Your main script -->
    <script type="module" src="script.js"></script>

    <!-- Add this right after the document is fully loaded to load clinical issues -->
    <script type="module">
        // Import from script.js
        import("./script.js").then(module => {
            // Once the script module is loaded, check if loadClinicalIssues is available
            if (typeof window.loadClinicalIssues === 'function') {
                window.loadClinicalIssues().then(() => {
                    console.log('Clinical issues loaded on page load');
                }).catch(error => {
                    console.error('Failed to load clinical issues on page load:', error);
                });
            } else {
                console.warn('loadClinicalIssues function not found in global scope');
            }
        });
    </script>

    <!-- Setup TipTap namespace -->
    <script>
        window.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('Initializing TipTap namespace...');
                
                // Create global tiptap namespace
                window.tiptap = window.tiptap || {};
                
                // Map UMD globals to our namespace
                if (typeof TiptapCore !== 'undefined') {
                    console.log('Found TiptapCore global object');
                    window.tiptap.Editor = TiptapCore.Editor;
                }
                
                if (typeof TiptapStarterKit !== 'undefined') {
                    console.log('Found TiptapStarterKit global object');
                    window.tiptap.StarterKit = TiptapStarterKit.StarterKit;
                }
                
                if (typeof TiptapExtensionPlaceholder !== 'undefined') {
                    console.log('Found TiptapExtensionPlaceholder global object');
                    window.tiptap.Placeholder = TiptapExtensionPlaceholder.Placeholder;
                }
                
                // Fallback checks for other possible global patterns
                if (!window.tiptap.Editor && typeof tiptap !== 'undefined') {
                    console.log('Trying fallback to lowercase tiptap global');
                    window.tiptap = tiptap;
                }
                
                // Make sure we have basic objects defined even if they don't work
                if (!window.tiptap.Editor) {
                    console.warn('TipTap Editor not found, creating stub...');
                    window.tiptap.Editor = function(config) { 
                        console.error('TipTap Editor stub called - libraries not properly loaded');
                        return createFallbackEditor(config.element, 
                            config.element.getAttribute('placeholder') || 'Start typing...');
                    };
                }
                
                if (!window.tiptap.StarterKit) {
                    console.warn('TipTap StarterKit not found, creating stub...');
                    window.tiptap.StarterKit = { configure: function() { return {}; } };
                }
                
                if (!window.tiptap.Placeholder) {
                    console.warn('TipTap Placeholder not found, creating stub...');
                    window.tiptap.Placeholder = { configure: function() { return {}; } };
                }
                
                console.log('TipTap namespace setup complete:', window.tiptap);
            } catch (error) {
                console.error('Error setting up TipTap namespace:', error);
            }
        });
    </script>
    <script>
        // Ensure generateFakeTranscript is available globally
        window.generateFakeTranscript = async function() {
            console.log('=== window.generateFakeTranscript START ===');
            try {
                // Get user token
                const user = auth.currentUser;
                if (!user) {
                    console.error('No user found');
                    return;
                }
                console.log('Got user token');

                // Generate random patient data inline
                console.log('Generating random patient data inline');
                const patientData = typeof generateRandomPatientData === 'function' ? 
                    generateRandomPatientData() : 
                    { chiefComplaint: "abnormal uterine bleeding" };
                console.log('Random patient data:', patientData);

                // Get prompts
                console.log('Fetching prompts');
                let prompts;
                try {
                    prompts = await getPrompts();
                    console.log('Prompts fetched:', prompts);
                } catch (promptError) {
                    console.error('Error fetching prompts:', promptError);
                    prompts = { transcriptPrompt: "Generate a medical transcript" };
                }

                // Create enhanced prompt
                console.log('Creating enhanced prompt');
                let enhancedPrompt;
                try {
                    enhancedPrompt = typeof enhancePrompt === 'function' ? 
                        enhancePrompt(prompts.transcriptPrompt, patientData) :
                        "Generate a medical transcript for a patient with " + (patientData.chiefComplaint || "abnormal uterine bleeding");
                    console.log('Enhanced prompt created:', enhancedPrompt);
                } catch (enhanceError) {
                    console.error('Error enhancing prompt:', enhanceError);
                    // Fallback to basic prompt
                    enhancedPrompt = "Generate a medical transcript for a patient with " + 
                                     (patientData.chiefComplaint || "abnormal uterine bleeding");
                    console.log('Using fallback prompt:', enhancedPrompt);
                }

                // Get token
                console.log('Getting auth token');
                const token = await user.getIdToken();
                if (!token) {
                    console.error('Failed to get token');
                    return;
                }
                console.log('Got auth token');

                // Make API request
                console.log('Making API request');
                const response = await fetch('https://clerky-uzni.onrender.com/generateTranscript', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        prompt: enhancedPrompt,
                        model: typeof getUserAIPreference === 'function' ? getUserAIPreference() : 'DeepSeek'
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status: ${response.status}`);
                }

                const data = await response.json();
                console.log('API response received:', data);

                // Check for valid response
                if (data.success && data.response && data.response.content) {
                    console.log('Data contains response content');
                    
                    // Set the content using setSummaryContent or directly
                    console.log('Setting transcript content');
                    try {
                        if (typeof setSummaryContent === 'function') {
                            setSummaryContent(data.response.content);
                            console.log('Content set via setSummaryContent');
                        } else {
                            // Try to set content directly to active pane
                            const activePane = document.querySelector('.transcript-pane.active');
                            if (activePane && activePane._tiptapEditor) {
                                console.log('Found active pane with TipTap editor');
                                setEditorContent(activePane._tiptapEditor, data.response.content);
                                console.log('Content set via TipTap editor API');
                            } else if (activePane) {
                                console.log('Found active pane without TipTap editor');
                                activePane.innerHTML = data.response.content;
                                console.log('Content set directly to pane HTML');
                                
                                // Try to initialize TipTap if needed
                                if (typeof initializeTipTap === 'function') {
                                    console.log('Attempting to initialize TipTap for pane');
                                    initializeTipTap(activePane);
                                }
                            } else {
                                console.error('No active transcript pane found');
                            }
                        }
                    } catch (setContentError) {
                        console.error('Error setting content:', setContentError);
                        
                        // Last resort - try to find any textarea directly
                        try {
                            const fallbackTextarea = document.querySelector('.transcript-pane.active .fallback-editor');
                            if (fallbackTextarea) {
                                console.log('Found fallback textarea');
                                fallbackTextarea.value = data.response.content;
                                console.log('Content set to fallback textarea');
                                
                                // Trigger input event to notify listeners
                                const inputEvent = new Event('input', {
                                    bubbles: true,
                                    cancelable: true,
                                });
                                fallbackTextarea.dispatchEvent(inputEvent);
                            } else {
                                console.error('No fallback textarea found');
                            }
                        } catch (fallbackError) {
                            console.error('Error with fallback content setting:', fallbackError);
                        }
                    }
                    
                    return data.response.content;
                } else {
                    console.error('Invalid response format:', data);
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.error('Error generating fake transcript:', error);
                throw error;
            } finally {
                console.log('=== window.generateFakeTranscript END ===');
            }
        };
        console.log('Global generateFakeTranscript function defined');
    </script>
</body>
</html>