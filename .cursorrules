# Cursor Rules for Clerky

## Commit Rules

### 1. NEVER Skip Git Hooks
- NEVER use `--no-verify` or `--no-gpg-sign` flags when committing
- NEVER skip commit hooks unless explicitly requested by the user

### 2. NEVER Commit Without User Permission
- NEVER commit changes unless the user explicitly asks you to
- It is CRITICAL to only commit when explicitly asked
- The user will feel you are being too proactive if you commit without permission

### 3. ALWAYS Increment Version Before Committing
- ALWAYS increment the version in `package.json` before committing changes
- Use the appropriate version increment based on the type of change (patch/minor/major)
- The only exception is if the commit is ONLY updating documentation or non-code files that don't affect functionality
- If unsure which version increment to use, ask the user

### 4. Dist Folder Inclusion
- The `dist/` folder MUST be included in commits
- This folder contains built/compiled assets that are deployed
- ALWAYS run `npm run build` before committing to ensure the `dist/` folder is up to date
- The ONLY exception is if the commit contains ONLY documentation or non-code files (e.g., README.md, .cursorrules)
- Before committing, verify the build completes successfully and changes in source files are reflected in the `dist/` folder

### 5. Force Push Protection
- NEVER run `git push --force` to `main` or `master` branches
- Warn the user if they request a force push to main/master branches

### 6. Git Config Protection
- NEVER update the git config unless explicitly requested

## Version Incrementing Rules

### 1. Version Location
- Version is stored in `package.json` (currently at version 4.9.33)
- The version follows semantic versioning: MAJOR.MINOR.PATCH

### 2. Version Increment Commands
Use npm's built-in version management commands:

- **Patch version** (bug fixes, small changes): `4.9.33 → 4.9.34`
  ```bash
  npm version patch
  ```

- **Minor version** (new features, backwards compatible): `4.9.33 → 4.10.0`
  ```bash
  npm version minor
  ```

- **Major version** (breaking changes): `4.9.33 → 5.0.0`
  ```bash
  npm version major
  ```

### 3. When to Increment Which Version

- **PATCH**: Bug fixes, documentation updates, minor improvements, security patches
- **MINOR**: New features, new endpoints, significant improvements (backwards compatible)
- **MAJOR**: Breaking changes, major refactors, API changes that break compatibility

### 4. Version Increment Workflow

When the user asks to increment the version:

1. Ask which type of version increment is appropriate (patch/minor/major) if not specified
2. Run the appropriate `npm version` command
3. The command will automatically:
   - Update `package.json`
   - Create a git commit with the version change
   - Create a git tag (unless `--no-git-tag-version` is used)
4. Inform the user that the version display on `index.html` will automatically update on next page load

### 5. Version Increment Without Git Tag

If the user prefers not to create git tags:
```bash
npm version patch --no-git-tag-version
```

Then manually commit the changes afterwards.

## Build Process Rules

### 1. Before Committing
- If source files have changed, run `npm run build` to update the `dist/` folder
- Verify the build completes successfully before committing

### 2. Build Commands
- Standard build: `npm run build`
- Bundle Libretto: `npm run bundle-libretto`

## Deployment Monitoring Rules

### 1. Checking Render Deployment Logs via MCP

When deployment issues occur or the user asks to check deployment status:

1. **List Services** first to get the service ID:
   ```
   mcp_render_list_services
   ```
   - Look for the service named "clerky" 
   - Note its `id` (e.g., `srv-ct27s4a3esus73d590b0`)

2. **Check Recent Deploys** to see deployment status:
   ```
   mcp_render_list_deploys with serviceId and limit: 5
   ```
   - Check the `status` field: `live`, `update_failed`, `build_failed`, etc.
   - Note the deploy `id` if you need detailed logs

3. **View Application Logs** to see runtime errors:
   ```
   mcp_render_list_logs with:
   - resource: [serviceId]
   - limit: 100
   - type: ["app"]
   - direction: "backward"
   - startTime: (recent timestamp, e.g., last hour)
   ```
   - Look for `level: "critical"` or `level: "error"` messages
   - Check for SyntaxError, ReferenceError, or other runtime errors
   - Look for stack traces to identify exact line numbers

4. **View Build Logs** if deployment failed during build:
   ```
   mcp_render_list_logs with:
   - resource: [serviceId]
   - limit: 100
   - type: ["build"]
   - direction: "backward"
   ```

### 2. Common Deployment Issues to Check For

- **SyntaxError**: Variable redeclaration, missing brackets, etc.
- **Module errors**: Missing dependencies, import issues
- **Environment variables**: Missing required env vars
- **Build failures**: npm install errors, compilation issues

### 3. After Fixing Deployment Issues

1. Fix the code issue identified in logs
2. Run `npm run build` to update dist folder
3. Increment version (patch for bug fixes)
4. Commit with descriptive message mentioning the fix
5. Push to trigger new deployment
6. Monitor logs again to verify successful deployment

## Best Practices

1. Always inform the user what files will be committed before committing
2. Use descriptive commit messages that follow conventional commits format when possible
3. When version incrementing, include relevant changes in the commit message
4. Remember: The user prefers British English spelling (analyse vs analyze, etc.)
5. Ask one question at a time when clarification is needed

