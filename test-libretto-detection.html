<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Libretto Detection</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        textarea {
            width: 100%;
            height: 200px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Test Libretto Library Detection</h1>
    
    <div class="test-section">
        <h2>Test Text (Sarah Ahmed Case)</h2>
        <textarea id="testText">Dictation: Clinical Interaction â€“ Twin Pregnancy with Obstetric Cholestasis
 Patient Details:
Name: [Fictional Name] Sarah Ahmed

Age: 32

BMI: 24.7 (weight 68 kg, height 1.66 m)

Gravida: 2, Para: 1 (previous spontaneous vaginal delivery at term)

Current Gestation: 32+2 weeks (DCDA twins confirmed on early scan)

Booking bloods and anomaly scans: Unremarkable

History of Presenting Complaint:
 Ms. Ahmed presents with a 10-day history of worsening pruritus, predominantly affecting her palms and soles, with associated sleep disturbance. She denies any new skin rashes or recent medication changes. No history of abdominal pain, dark urine, or pale stools. Fetal movements are reported as normal for both twins. No vaginal bleeding or uterine tightenings.</textarea>
        
        <button onclick="testLibrettoDetection()">Test Libretto Detection</button>
        <button onclick="testAnonymisation()">Test Full Anonymisation</button>
        
        <div id="results"></div>
    </div>

    <script src="dist/libretto-bundle.js"></script>
    <script src="anonymisation.js"></script>
    <script>
        let anonymiser;

        async function initAnonymiser() {
            if (!anonymiser) {
                anonymiser = new ClinicalDataAnonymiser();
                await anonymiser.initialize();
            }
        }

        async function testLibrettoDetection() {
            await initAnonymiser();
            
            const text = document.getElementById('testText').value;
            const resultsDiv = document.getElementById('results');
            
            resultsDiv.innerHTML = '<h3>Testing Libretto Detection...</h3>';
            
            try {
                // Test the library directly
                const redactPII = await loadRedactPII();
                if (redactPII) {
                    const libraryResult = redactPII(text);
                    const detectedItems = anonymiser.identifyLibraryDetections(text, libraryResult);
                    
                    // Show word-by-word comparison
                    const originalWords = text.split(/\s+/);
                    const anonymisedWords = libraryResult.split(/\s+/);
                    const changedWords = [];
                    
                    for (let i = 0; i < Math.min(originalWords.length, anonymisedWords.length); i++) {
                        if (originalWords[i] !== anonymisedWords[i]) {
                            changedWords.push({
                                original: originalWords[i],
                                anonymised: anonymisedWords[i],
                                index: i
                            });
                        }
                    }
                    
                    resultsDiv.innerHTML = `
                        <h3>Libretto Library Results:</h3>
                        <div class="result">
                            <strong>Original Text:</strong><br>
                            <pre>${text}</pre>
                        </div>
                        <div class="result">
                            <strong>Anonymised by Library:</strong><br>
                            <pre>${libraryResult}</pre>
                        </div>
                        <div class="result">
                            <strong>All Changed Words:</strong><br>
                            <pre>${JSON.stringify(changedWords, null, 2)}</pre>
                        </div>
                        <div class="result">
                            <strong>Filtered Detected Items:</strong><br>
                            <pre>${JSON.stringify(detectedItems, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = '<div class="result">Libretto library not available</div>';
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="result">Error: ${error.message}</div>`;
            }
        }

        async function testAnonymisation() {
            await initAnonymiser();
            
            const text = document.getElementById('testText').value;
            const resultsDiv = document.getElementById('results');
            
            resultsDiv.innerHTML = '<h3>Testing Full Anonymisation...</h3>';
            
            try {
                const piiAnalysis = await anonymiser.checkForPII(text);
                const consolidatedMatches = anonymiser.consolidatePIIMatches(piiAnalysis.matches);
                
                resultsDiv.innerHTML = `
                    <h3>PII Analysis Results:</h3>
                    <div class="result">
                        <strong>Contains PII:</strong> ${piiAnalysis.containsPII}<br>
                        <strong>Risk Level:</strong> ${piiAnalysis.riskLevel}<br>
                        <strong>PII Types:</strong><br>
                        <pre>${JSON.stringify(piiAnalysis.piiTypes, null, 2)}</pre>
                    </div>
                    <div class="result">
                        <strong>Raw Matches:</strong><br>
                        <pre>${JSON.stringify(piiAnalysis.matches, null, 2)}</pre>
                    </div>
                    <div class="result">
                        <strong>Consolidated Matches:</strong><br>
                        <pre>${JSON.stringify(consolidatedMatches, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="result">Error: ${error.message}</div>`;
            }
        }

        // Initialize on page load
        window.addEventListener('load', initAnonymiser);
    </script>
</body>
</html> 