<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSOTs - Live Triage Board</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="BSOTs.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body class="bsots-page">

    <!-- Prototype Banner -->
    <div class="bsots-prototype-banner">
        PROTOTYPE - Birmingham Symptom-specific Obstetric Triage System (BSOTs) - Not for clinical use
    </div>

    <!-- Header -->
    <header class="bsots-header">
        <div class="bsots-header-left">
            <h1>BSOTs Triage Board</h1>
            <a href="BSOTs-admin.html" class="bsots-link">Admin</a>
        </div>
        <div class="bsots-header-center">
            <div class="bsots-site-tabs" id="siteTabs"></div>
        </div>
        <div class="bsots-header-right">
            <div class="bsots-stats" id="statsBar"></div>
        </div>
    </header>

    <!-- Filters -->
    <div class="bsots-filters">
        <select id="filterUrgency">
            <option value="">All urgencies</option>
            <option value="RED">RED - Immediate</option>
            <option value="ORANGE">ORANGE - 15 min</option>
            <option value="YELLOW">YELLOW - 60 min</option>
            <option value="GREEN">GREEN - 240 min</option>
        </select>
        <select id="filterReason">
            <option value="">All reasons</option>
        </select>
        <div class="bsots-filters-spacer"></div>
        <button class="bsots-btn bsots-btn-primary" id="addPatientBtn">+ Add Patient</button>
    </div>

    <!-- Board -->
    <div class="bsots-board-container">
        <div id="loadingState" class="bsots-loading">
            <div class="bsots-spinner"></div>
            Loading triage board...
        </div>
        <table class="bsots-board" id="boardTable" style="display:none;">
            <thead>
                <tr>
                    <th>Initials</th>
                    <th>Hosp #</th>
                    <th>Site</th>
                    <th>Arrival</th>
                    <th>Reason</th>
                    <th>Urgency</th>
                    <th>Due</th>
                    <th>Countdown</th>
                    <th>Tasks</th>
                    <th>Notes</th>
                    <th>Clinician</th>
                    <th>MEOWS</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="boardBody"></tbody>
        </table>
        <div id="emptyState" class="bsots-empty" style="display:none;">
            <p>No pending patients at this site.</p>
            <p style="font-size:13px;">Click <strong>+ Add Patient</strong> to begin.</p>
        </div>
        <div id="errorState" class="bsots-empty" style="display:none;">
            <p>Could not load episodes.</p>
            <p id="errorMessage" style="font-size:12px; color: var(--color-error);"></p>
            <p style="font-size:12px;">This query may require a Firestore composite index. Check the browser console for a link to create it.</p>
        </div>
    </div>

    <!-- Add Patient Modal -->
    <div class="bsots-modal-overlay" id="addPatientModal" style="display:none;">
        <div class="bsots-modal">
            <div class="bsots-modal-header">
                <h2>Add Patient to Triage</h2>
                <button class="bsots-modal-close" id="closeAddModal">&times;</button>
            </div>
            <div class="bsots-modal-body">
                <form id="addPatientForm">
                    <div class="bsots-form-row">
                        <div class="bsots-form-group">
                            <label for="patientInitials">Initials *</label>
                            <input type="text" id="patientInitials" required maxlength="4"
                                   placeholder="e.g. JS" autocomplete="off" style="text-transform:uppercase;">
                        </div>
                        <div class="bsots-form-group">
                            <label for="patientHospNum">Hospital Number *</label>
                            <input type="text" id="patientHospNum" required
                                   placeholder="e.g. H123456" autocomplete="off">
                        </div>
                    </div>

                    <div class="bsots-form-group">
                        <label for="patientSite">Site</label>
                        <select id="patientSite"></select>
                    </div>

                    <div class="bsots-form-group">
                        <label for="patientReason">Presenting Reason *</label>
                        <select id="patientReason" required>
                            <option value="">Select reason...</option>
                        </select>
                    </div>

                    <div class="bsots-form-group">
                        <label>Urgency Category *</label>
                        <div class="bsots-urgency-options" id="urgencyOptions">
                            <div class="bsots-urgency-option" data-urgency="RED">
                                <span class="bsots-urgency-label">RED</span>
                                <span class="bsots-urgency-desc">Immediate</span>
                            </div>
                            <div class="bsots-urgency-option" data-urgency="ORANGE">
                                <span class="bsots-urgency-label">ORANGE</span>
                                <span class="bsots-urgency-desc">15 min</span>
                            </div>
                            <div class="bsots-urgency-option" data-urgency="YELLOW">
                                <span class="bsots-urgency-label">YELLOW</span>
                                <span class="bsots-urgency-desc">60 min</span>
                            </div>
                            <div class="bsots-urgency-option" data-urgency="GREEN">
                                <span class="bsots-urgency-label">GREEN</span>
                                <span class="bsots-urgency-desc">240 min</span>
                            </div>
                        </div>
                        <input type="hidden" id="patientUrgency" required>
                    </div>

                    <div class="bsots-form-group">
                        <label>Tasks (select applicable)</label>
                        <div class="bsots-form-tasks" id="taskChips"></div>
                    </div>

                    <div class="bsots-form-group">
                        <label for="patientNote">Initial Note (optional)</label>
                        <textarea id="patientNote" rows="2" placeholder="Brief note..."></textarea>
                    </div>
                </form>
            </div>
            <div class="bsots-modal-footer">
                <button class="bsots-btn" id="cancelAddBtn">Cancel</button>
                <button class="bsots-btn bsots-btn-primary" id="submitAddBtn">Add Patient</button>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div class="bsots-modal-overlay" id="notesModal" style="display:none;">
        <div class="bsots-modal">
            <div class="bsots-modal-header">
                <h2>Notes - <span id="notesPatientLabel"></span></h2>
                <button class="bsots-modal-close" id="closeNotesModal">&times;</button>
            </div>
            <div class="bsots-modal-body">
                <div class="bsots-notes-list" id="notesList"></div>
                <div class="bsots-form-group" style="margin-bottom:0;">
                    <textarea id="newNoteText" rows="2" placeholder="Add a note..."></textarea>
                </div>
            </div>
            <div class="bsots-modal-footer">
                <button class="bsots-btn" id="cancelNotesBtn">Close</button>
                <button class="bsots-btn bsots-btn-primary" id="submitNoteBtn">Add Note</button>
            </div>
        </div>
    </div>

    <!-- Urgency Change Dropdown (appended dynamically) -->

    <!-- Firebase SDK -->
    <script type="module" src="firebase-init.js"></script>

    <!-- Board Logic -->
    <script type="module">
        import {
            URGENCY_CATEGORIES, PRESENTING_REASONS, DEFAULT_SITES, DEFAULT_TASKS
        } from './js/bsots/constants.js';

        import {
            subscribeToEpisodes, addEpisode, updateEpisode,
            changeUrgency, toggleTask, addNote,
            startTriage, completeTriage, completeReview, setOutcome,
            checkAndUpdateBreaches, seedSites, seedTestEpisodes,
            toDate
        } from './js/bsots/firestore.js';

        import {
            formatCountdown, formatTime, formatDateTime, getCountdownClass
        } from './js/bsots/countdown.js';

        // ─── State ──────────────────────────────────────────────────────────
        let currentSiteId = localStorage.getItem('bsots_site') || DEFAULT_SITES[0].id;
        let episodes = [];
        let unsubscribe = null;
        let countdownInterval = null;
        let breachCheckInterval = null;
        let filterUrgency = '';
        let filterReason = '';

        // ─── DOM References ─────────────────────────────────────────────────
        const $siteTabs = document.getElementById('siteTabs');
        const $statsBar = document.getElementById('statsBar');
        const $boardTable = document.getElementById('boardTable');
        const $boardBody = document.getElementById('boardBody');
        const $loadingState = document.getElementById('loadingState');
        const $emptyState = document.getElementById('emptyState');
        const $errorState = document.getElementById('errorState');
        const $errorMessage = document.getElementById('errorMessage');
        const $filterUrgency = document.getElementById('filterUrgency');
        const $filterReason = document.getElementById('filterReason');
        const $addPatientBtn = document.getElementById('addPatientBtn');
        const $addPatientModal = document.getElementById('addPatientModal');
        const $addPatientForm = document.getElementById('addPatientForm');
        const $notesModal = document.getElementById('notesModal');

        // ─── Initialise ─────────────────────────────────────────────────────
        function init() {
            renderSiteTabs();
            populateReasonFilter();
            populateFormSelects();
            setupFormListeners();
            setupFilterListeners();
            subscribeSite(currentSiteId);
            startCountdownTicker();
            startBreachChecker();
        }

        // ─── Site Tabs ──────────────────────────────────────────────────────
        function renderSiteTabs() {
            $siteTabs.innerHTML = DEFAULT_SITES.map(s =>
                `<button class="bsots-site-tab ${s.id === currentSiteId ? 'active' : ''}"
                         data-site="${s.id}">${s.shortName}</button>`
            ).join('');

            $siteTabs.querySelectorAll('.bsots-site-tab').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentSiteId = btn.dataset.site;
                    localStorage.setItem('bsots_site', currentSiteId);
                    renderSiteTabs();
                    subscribeSite(currentSiteId);
                });
            });
        }

        // ─── Subscribe to Episodes ──────────────────────────────────────────
        function subscribeSite(siteId) {
            if (unsubscribe) unsubscribe();
            showLoading();

            unsubscribe = subscribeToEpisodes(siteId, 'pending', (data) => {
                episodes = data;
                renderBoard();
                renderStats();
                hideLoading();
            }, (error) => {
                showError(error.message || 'Unknown error');
            });
        }

        // ─── Render Board ───────────────────────────────────────────────────
        function renderBoard() {
            let filtered = episodes;

            if (filterUrgency) {
                filtered = filtered.filter(e => e.urgencyCategory === filterUrgency);
            }
            if (filterReason) {
                filtered = filtered.filter(e => e.presentingReason === filterReason);
            }

            // Sort: nextDueAt ascending (most urgent first)
            filtered.sort((a, b) => {
                const aMs = a.nextDueAt?.toMillis ? a.nextDueAt.toMillis() : 0;
                const bMs = b.nextDueAt?.toMillis ? b.nextDueAt.toMillis() : 0;
                return aMs - bMs;
            });

            if (filtered.length === 0) {
                $boardTable.style.display = 'none';
                $emptyState.style.display = 'block';
                return;
            }

            $boardTable.style.display = 'table';
            $emptyState.style.display = 'none';

            $boardBody.innerHTML = filtered.map(ep => renderRow(ep)).join('');
            attachRowListeners();
        }

        function renderRow(ep) {
            const urgency = ep.urgencyCategory || 'GREEN';
            const countdown = formatCountdown(ep.nextDueAt);
            const isOverdue = countdown.isOverdue;
            const rowClass = `bsots-row-${urgency}${isOverdue ? ' bsots-row-overdue' : ''}`;
            const countdownClass = getCountdownClass(ep.nextDueAt);

            const breachDots = [];
            if (ep.breachFlags?.triageDelay) breachDots.push('<span class="bsots-breach-indicator" title="Triage delay breach"></span>');
            if (ep.breachFlags?.overdue) breachDots.push('<span class="bsots-breach-indicator" title="Overdue breach"></span>');

            const tasks = (ep.tasks || []).map(t =>
                `<label class="bsots-task ${t.status === 'completed' ? 'bsots-task-completed' : ''}"
                        data-episode="${ep.id}" data-task="${t.id}">
                    <input type="checkbox" ${t.status === 'completed' ? 'checked' : ''}>
                    ${escapeHtml(t.label)}
                </label>`
            ).join('');

            const latestNote = (ep.notes || []).length > 0
                ? ep.notes[ep.notes.length - 1]
                : null;

            const notePreview = latestNote
                ? `<span class="bsots-note-preview" data-episode="${ep.id}" title="Click to view all notes">${escapeHtml(latestNote.text)}</span>
                   <span class="bsots-note-count">(${ep.notes.length})</span>`
                : `<span class="bsots-note-preview" data-episode="${ep.id}" style="color:var(--text-muted);">Add note</span>`;

            return `<tr class="${rowClass}" data-episode-id="${ep.id}">
                <td><strong>${escapeHtml(ep.initials || '--')}</strong> ${breachDots.join('')}</td>
                <td>${escapeHtml(ep.hospitalNumber || '--')}</td>
                <td>${escapeHtml(getSiteShortName(ep.siteId))}</td>
                <td>${formatTime(ep.arrivalAt)}</td>
                <td>${escapeHtml(ep.presentingReason || '--')}</td>
                <td><span class="bsots-urgency-badge bsots-urgency-${urgency}">${urgency}</span></td>
                <td>${formatTime(ep.nextDueAt)}</td>
                <td>
                    <span class="bsots-countdown ${countdownClass}" data-next-due="${ep.nextDueAt?.toMillis ? ep.nextDueAt.toMillis() : ''}" data-ep-id="${ep.id}">
                        ${countdown.text}
                    </span>
                    ${isOverdue ? '<span class="bsots-overdue-label">OVERDUE</span>' : ''}
                </td>
                <td><div class="bsots-tasks">${tasks || '<span style="color:var(--text-muted);font-size:12px;">--</span>'}</div></td>
                <td>${notePreview}</td>
                <td style="font-size:12px;color:var(--text-muted);">${escapeHtml(ep.assignedClinician || '--')}</td>
                <td style="font-size:12px;color:var(--text-muted);">${ep.meows || '--'}</td>
                <td>
                    <div class="bsots-actions">
                        <button class="bsots-btn bsots-btn-sm" data-action="change-urgency" data-episode="${ep.id}" title="Change urgency">Urgency</button>
                        <button class="bsots-btn bsots-btn-sm" data-action="review" data-episode="${ep.id}" title="Record review">Review</button>
                        <button class="bsots-btn bsots-btn-sm" data-action="outcome" data-episode="${ep.id}" title="Set outcome">Outcome</button>
                    </div>
                </td>
            </tr>`;
        }

        // ─── Row Event Listeners ────────────────────────────────────────────
        function attachRowListeners() {
            // Task toggles
            $boardBody.querySelectorAll('.bsots-task input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', async (e) => {
                    const label = e.target.closest('.bsots-task');
                    const episodeId = label.dataset.episode;
                    const taskId = label.dataset.task;
                    const episode = episodes.find(ep => ep.id === episodeId);
                    if (episode) {
                        try {
                            await toggleTask(episodeId, episode, taskId, '');
                        } catch (err) {
                            showToast('Failed to update task', 'error');
                        }
                    }
                });
            });

            // Note preview clicks -> open notes modal
            $boardBody.querySelectorAll('.bsots-note-preview').forEach(el => {
                el.addEventListener('click', () => openNotesModal(el.dataset.episode));
            });

            // Action buttons
            $boardBody.querySelectorAll('[data-action="change-urgency"]').forEach(btn => {
                btn.addEventListener('click', (e) => showUrgencyDropdown(e, btn.dataset.episode));
            });

            $boardBody.querySelectorAll('[data-action="review"]').forEach(btn => {
                btn.addEventListener('click', () => handleReview(btn.dataset.episode));
            });

            $boardBody.querySelectorAll('[data-action="outcome"]').forEach(btn => {
                btn.addEventListener('click', (e) => showOutcomeDropdown(e, btn.dataset.episode));
            });
        }

        // ─── Countdown Ticker ───────────────────────────────────────────────
        function startCountdownTicker() {
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                document.querySelectorAll('.bsots-countdown[data-next-due]').forEach(el => {
                    const dueMs = parseInt(el.dataset.nextDue);
                    if (!dueMs) return;

                    // Create a mock timestamp-like object for formatCountdown
                    const mockTs = { toMillis: () => dueMs };
                    const cd = formatCountdown(mockTs);
                    const cdClass = getCountdownClass(mockTs);

                    el.textContent = cd.text;
                    el.className = `bsots-countdown ${cdClass}`;

                    // Update overdue label
                    const row = el.closest('tr');
                    if (row) {
                        const existingLabel = row.querySelector('.bsots-overdue-label');
                        if (cd.isOverdue && !existingLabel) {
                            el.insertAdjacentHTML('afterend', '<span class="bsots-overdue-label">OVERDUE</span>');
                            row.classList.add('bsots-row-overdue');
                        }
                    }
                });
            }, 1000);
        }

        // ─── Breach Checker ─────────────────────────────────────────────────
        function startBreachChecker() {
            if (breachCheckInterval) clearInterval(breachCheckInterval);
            breachCheckInterval = setInterval(() => {
                episodes.forEach(ep => {
                    if (ep.status === 'pending') {
                        checkAndUpdateBreaches(ep.id, ep).catch(() => {});
                    }
                });
            }, 30000); // Check every 30 seconds
        }

        // ─── Stats Bar ─────────────────────────────────────────────────────
        function renderStats() {
            const counts = { RED: 0, ORANGE: 0, YELLOW: 0, GREEN: 0 };
            episodes.forEach(ep => {
                if (counts.hasOwnProperty(ep.urgencyCategory)) {
                    counts[ep.urgencyCategory]++;
                }
            });

            $statsBar.innerHTML = Object.entries(counts).map(([cat, count]) =>
                `<span class="bsots-stat bsots-stat-${cat.toLowerCase()}">${cat}: ${count}</span>`
            ).join('');
        }

        // ─── Filter Listeners ───────────────────────────────────────────────
        function populateReasonFilter() {
            PRESENTING_REASONS.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r;
                opt.textContent = r;
                $filterReason.appendChild(opt);
            });
        }

        function setupFilterListeners() {
            $filterUrgency.addEventListener('change', () => {
                filterUrgency = $filterUrgency.value;
                renderBoard();
            });
            $filterReason.addEventListener('change', () => {
                filterReason = $filterReason.value;
                renderBoard();
            });
        }

        // ─── Add Patient ────────────────────────────────────────────────────
        function populateFormSelects() {
            // Sites
            const $patientSite = document.getElementById('patientSite');
            DEFAULT_SITES.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = s.shortName + ' - ' + s.name;
                if (s.id === currentSiteId) opt.selected = true;
                $patientSite.appendChild(opt);
            });

            // Reasons
            const $patientReason = document.getElementById('patientReason');
            PRESENTING_REASONS.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r;
                opt.textContent = r;
                $patientReason.appendChild(opt);
            });

            // Task chips
            const $taskChips = document.getElementById('taskChips');
            DEFAULT_TASKS.forEach((t, i) => {
                const chip = document.createElement('div');
                chip.className = 'bsots-form-task-chip selected';
                chip.dataset.label = t.label;
                chip.textContent = t.label;
                chip.addEventListener('click', () => chip.classList.toggle('selected'));
                $taskChips.appendChild(chip);
            });
        }

        function setupFormListeners() {
            // Urgency selector buttons
            document.querySelectorAll('.bsots-urgency-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    document.querySelectorAll('.bsots-urgency-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    document.getElementById('patientUrgency').value = opt.dataset.urgency;
                });
            });

            // Open modal
            $addPatientBtn.addEventListener('click', () => {
                $addPatientModal.style.display = 'flex';
                // Default site to current
                document.getElementById('patientSite').value = currentSiteId;
                document.getElementById('patientInitials').focus();
            });

            // Close modal
            document.getElementById('closeAddModal').addEventListener('click', closeAddModal);
            document.getElementById('cancelAddBtn').addEventListener('click', closeAddModal);
            $addPatientModal.addEventListener('click', (e) => {
                if (e.target === $addPatientModal) closeAddModal();
            });

            // Submit
            document.getElementById('submitAddBtn').addEventListener('click', handleAddPatient);
        }

        function closeAddModal() {
            $addPatientModal.style.display = 'none';
            $addPatientForm.reset();
            document.querySelectorAll('.bsots-urgency-option').forEach(o => o.classList.remove('selected'));
            document.getElementById('patientUrgency').value = '';
        }

        async function handleAddPatient() {
            const initials = document.getElementById('patientInitials').value.trim();
            const hospitalNumber = document.getElementById('patientHospNum').value.trim();
            const siteId = document.getElementById('patientSite').value;
            const presentingReason = document.getElementById('patientReason').value;
            const urgencyCategory = document.getElementById('patientUrgency').value;
            const initialNote = document.getElementById('patientNote').value.trim();

            if (!initials || !hospitalNumber || !presentingReason || !urgencyCategory) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            const selectedTasks = [];
            document.querySelectorAll('.bsots-form-task-chip.selected').forEach(chip => {
                selectedTasks.push({ label: chip.dataset.label });
            });

            try {
                await addEpisode({
                    siteId,
                    initials,
                    hospitalNumber,
                    presentingReason,
                    urgencyCategory,
                    tasks: selectedTasks,
                    initialNote: initialNote || null
                });
                closeAddModal();
                showToast('Patient added to triage board', 'success');
            } catch (err) {
                console.error('[BSOTs] Add patient error:', err);
                showToast('Failed to add patient: ' + err.message, 'error');
            }
        }

        // ─── Change Urgency ─────────────────────────────────────────────────
        function showUrgencyDropdown(event, episodeId) {
            // Remove any existing dropdown
            removeDropdowns();

            const episode = episodes.find(ep => ep.id === episodeId);
            if (!episode) return;

            const dropdown = document.createElement('div');
            dropdown.className = 'bsots-urgency-dropdown';
            dropdown.id = 'urgencyDropdown';

            Object.entries(URGENCY_CATEGORIES).forEach(([key, cfg]) => {
                if (key === episode.urgencyCategory) return; // Skip current
                const item = document.createElement('div');
                item.className = 'bsots-urgency-dropdown-item';
                item.innerHTML = `<span class="bsots-urgency-dot" style="background:${cfg.color}"></span> ${key} (${cfg.description})`;
                item.addEventListener('click', async () => {
                    try {
                        await changeUrgency(episodeId, episode, key, '');
                        showToast(`Urgency changed to ${key}`, 'success');
                    } catch (err) {
                        showToast('Failed to change urgency', 'error');
                    }
                    removeDropdowns();
                });
                dropdown.appendChild(item);
            });

            // Position near button
            const rect = event.target.getBoundingClientRect();
            dropdown.style.position = 'fixed';
            dropdown.style.top = (rect.bottom + 4) + 'px';
            dropdown.style.left = rect.left + 'px';
            document.body.appendChild(dropdown);

            // Close on outside click
            setTimeout(() => {
                document.addEventListener('click', handleDropdownClose, { once: true });
            }, 0);
        }

        function showOutcomeDropdown(event, episodeId) {
            removeDropdowns();

            const episode = episodes.find(ep => ep.id === episodeId);
            if (!episode) return;

            const dropdown = document.createElement('div');
            dropdown.className = 'bsots-urgency-dropdown';
            dropdown.id = 'outcomeDropdown';

            [
                { value: 'admitted', label: 'Admit', color: '#fd7e14' },
                { value: 'discharged', label: 'Discharge Home', color: '#28a745' },
                { value: 'transferred', label: 'Transfer', color: '#17a2b8' }
            ].forEach(opt => {
                const item = document.createElement('div');
                item.className = 'bsots-urgency-dropdown-item';
                item.innerHTML = `<span class="bsots-urgency-dot" style="background:${opt.color}"></span> ${opt.label}`;
                item.addEventListener('click', async () => {
                    if (confirm(`Set outcome to "${opt.label}" for ${episode.initials}? This will remove them from the board.`)) {
                        try {
                            await setOutcome(episodeId, episode, opt.value);
                            showToast(`${episode.initials} - ${opt.label}`, 'success');
                        } catch (err) {
                            showToast('Failed to set outcome', 'error');
                        }
                    }
                    removeDropdowns();
                });
                dropdown.appendChild(item);
            });

            const rect = event.target.getBoundingClientRect();
            dropdown.style.position = 'fixed';
            dropdown.style.top = (rect.bottom + 4) + 'px';
            dropdown.style.left = rect.left + 'px';
            document.body.appendChild(dropdown);

            setTimeout(() => {
                document.addEventListener('click', handleDropdownClose, { once: true });
            }, 0);
        }

        function handleDropdownClose(e) {
            const dd = document.querySelector('.bsots-urgency-dropdown');
            if (dd && !dd.contains(e.target)) {
                removeDropdowns();
            }
        }

        function removeDropdowns() {
            document.querySelectorAll('.bsots-urgency-dropdown').forEach(el => el.remove());
        }

        // ─── Review ─────────────────────────────────────────────────────────
        async function handleReview(episodeId) {
            const episode = episodes.find(ep => ep.id === episodeId);
            if (!episode) return;

            const actions = [];
            if (!episode.triageStartedAt) actions.push('Start Triage');
            if (episode.triageStartedAt && !episode.triageCompletedAt) actions.push('Complete Triage');
            if (!episode.medicalReviewedAt) actions.push('Medical Review Done');

            if (actions.length === 0) {
                showToast('All reviews already completed for this patient', 'success');
                return;
            }

            const action = actions.length === 1
                ? actions[0]
                : prompt(`Select action:\n${actions.map((a, i) => `${i + 1}. ${a}`).join('\n')}\n\nEnter number:`);

            if (!action) return;

            const selected = typeof action === 'string' && /^\d+$/.test(action.trim())
                ? actions[parseInt(action.trim()) - 1]
                : action;

            try {
                if (selected === 'Start Triage') {
                    await startTriage(episodeId, episode);
                    showToast('Triage started', 'success');
                } else if (selected === 'Complete Triage') {
                    await completeTriage(episodeId, episode);
                    showToast('Triage completed', 'success');
                } else if (selected === 'Medical Review Done') {
                    await completeReview(episodeId, episode);
                    showToast('Medical review recorded', 'success');
                }
            } catch (err) {
                showToast('Failed to record review', 'error');
            }
        }

        // ─── Notes Modal ────────────────────────────────────────────────────
        let currentNotesEpisodeId = null;

        function openNotesModal(episodeId) {
            currentNotesEpisodeId = episodeId;
            const episode = episodes.find(ep => ep.id === episodeId);
            if (!episode) return;

            document.getElementById('notesPatientLabel').textContent =
                `${episode.initials} (${episode.hospitalNumber})`;

            const $list = document.getElementById('notesList');
            const notes = episode.notes || [];
            if (notes.length === 0) {
                $list.innerHTML = '<p style="color:var(--text-muted);font-size:13px;">No notes yet.</p>';
            } else {
                $list.innerHTML = notes.map(n =>
                    `<div class="bsots-note-item">
                        <p>${escapeHtml(n.text)}</p>
                        <div class="bsots-note-meta">${formatDateTime(n.createdAt)}${n.createdBy ? ' - ' + escapeHtml(n.createdBy) : ''}</div>
                    </div>`
                ).join('');
            }

            document.getElementById('newNoteText').value = '';
            $notesModal.style.display = 'flex';
        }

        function closeNotesModal() {
            $notesModal.style.display = 'none';
            currentNotesEpisodeId = null;
        }

        document.getElementById('closeNotesModal').addEventListener('click', closeNotesModal);
        document.getElementById('cancelNotesBtn').addEventListener('click', closeNotesModal);
        $notesModal.addEventListener('click', (e) => {
            if (e.target === $notesModal) closeNotesModal();
        });

        document.getElementById('submitNoteBtn').addEventListener('click', async () => {
            const text = document.getElementById('newNoteText').value.trim();
            if (!text || !currentNotesEpisodeId) return;

            const episode = episodes.find(ep => ep.id === currentNotesEpisodeId);
            if (!episode) return;

            try {
                await addNote(currentNotesEpisodeId, episode, text, '');
                showToast('Note added', 'success');
                openNotesModal(currentNotesEpisodeId); // Refresh
            } catch (err) {
                showToast('Failed to add note', 'error');
            }
        });

        // ─── UI Helpers ─────────────────────────────────────────────────────
        function showLoading() {
            $loadingState.style.display = 'flex';
            $boardTable.style.display = 'none';
            $emptyState.style.display = 'none';
            $errorState.style.display = 'none';
        }

        function hideLoading() {
            $loadingState.style.display = 'none';
            $errorState.style.display = 'none';
        }

        function showError(msg) {
            $loadingState.style.display = 'none';
            $boardTable.style.display = 'none';
            $emptyState.style.display = 'none';
            $errorState.style.display = 'block';
            $errorMessage.textContent = msg;
        }

        function getSiteShortName(siteId) {
            const site = DEFAULT_SITES.find(s => s.id === siteId);
            return site ? site.shortName : siteId || '--';
        }

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `bsots-toast bsots-toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ─── Start ──────────────────────────────────────────────────────────
        init();
    </script>
</body>
</html>
