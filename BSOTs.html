<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSOTs - Live Triage Board</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="BSOTs.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body class="bsots-page">

    <div class="bsots-prototype-banner">
        PROTOTYPE - BSOTs Triage System (UHSussex) - Not for clinical use
    </div>

    <header class="bsots-header">
        <div class="bsots-header-left">
            <h1>BSOTs Triage Board</h1>
            <a href="BSOTs-admin.html" class="bsots-link">Admin</a>
        </div>
        <div class="bsots-header-center">
            <div class="bsots-site-tabs" id="siteTabs"></div>
        </div>
        <div class="bsots-header-right">
            <div class="bsots-stats" id="statsBar"></div>
        </div>
    </header>

    <div class="bsots-filters">
        <select id="filterUrgency">
            <option value="">All urgencies</option>
            <option value="RED">RED - Immediate</option>
            <option value="ORANGE">ORANGE - 15 min</option>
            <option value="YELLOW">YELLOW - 60 min</option>
            <option value="GREEN">GREEN - 240 min</option>
        </select>
        <select id="filterReason">
            <option value="">All reasons</option>
        </select>
        <div class="bsots-filters-spacer"></div>
        <button class="bsots-btn bsots-btn-primary" id="addPatientBtn">+ Add Patient</button>
    </div>

    <div class="bsots-board-container">
        <div id="loadingState" class="bsots-loading">
            <div class="bsots-spinner"></div>
            Loading triage board...
        </div>
        <table class="bsots-board" id="boardTable" style="display:none;">
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Patient</th>
                    <th>Hosp #</th>
                    <th>Arrival / Due</th>
                    <th>In Unit</th>
                    <th>Reason</th>
                    <th>Urgency</th>
                    <th>Countdown</th>
                    <th>Tasks</th>
                    <th>Notes</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="boardBody"></tbody>
        </table>
        <div id="emptyState" class="bsots-empty" style="display:none;">
            <p>No pending patients at this site.</p>
            <p style="font-size:13px;">Click <strong>+ Add Patient</strong> to begin.</p>
        </div>
        <div id="errorState" class="bsots-empty" style="display:none;">
            <p>Could not load episodes.</p>
            <p id="errorMessage" style="font-size:12px; color: var(--color-error);"></p>
            <p style="font-size:12px;">This query may require a Firestore composite index. Check the browser console for a link to create it.</p>
        </div>
    </div>

    <!-- Add Patient Modal -->
    <div class="bsots-modal-overlay" id="addPatientModal" style="display:none;">
        <div class="bsots-modal bsots-modal-wide">
            <div class="bsots-modal-header">
                <h2>Add Patient to Triage</h2>
                <button class="bsots-modal-close" id="closeAddModal">&times;</button>
            </div>
            <div class="bsots-modal-body">
                <form id="addPatientForm">
                    <div class="bsots-form-row">
                        <div class="bsots-form-group">
                            <label for="patientInitials">Initials *</label>
                            <input type="text" id="patientInitials" required maxlength="4"
                                   placeholder="e.g. JS" autocomplete="off" style="text-transform:uppercase;">
                        </div>
                        <div class="bsots-form-group">
                            <label for="patientHospNum">Hospital Number *</label>
                            <input type="text" id="patientHospNum" required placeholder="e.g. H123456" autocomplete="off">
                        </div>
                        <div class="bsots-form-group">
                            <label for="patientSite">Site</label>
                            <select id="patientSite"></select>
                        </div>
                    </div>
                    <div class="bsots-form-group">
                        <label for="patientReason">Presenting Reason (if known)</label>
                        <select id="patientReason"><option value="">Select reason...</option></select>
                    </div>

                    <!-- Algorithm Panel: appears after reason is selected -->
                    <div id="algorithmPanel" class="bsots-algo-panel" style="display:none;">
                        <div class="bsots-algo-header">
                            <span class="bsots-algo-title">Select the matching criteria to assign urgency</span>
                            <span class="bsots-algo-hint">Click any criterion below — urgency &amp; tasks will auto-populate</span>
                        </div>
                        <div id="algorithmGrid" class="bsots-algo-grid"></div>
                    </div>

                    <!-- Selected urgency display -->
                    <div id="selectedUrgencyBar" class="bsots-selected-urgency" style="display:none;">
                        <span id="selectedUrgencyLabel"></span>
                        <button type="button" class="bsots-btn bsots-btn-sm" id="clearUrgencyBtn">Change</button>
                        <input type="hidden" id="patientUrgency">
                    </div>

                    <!-- Immediate actions as tasks -->
                    <div id="actionsSection" class="bsots-form-group" style="display:none;">
                        <label>Immediate Actions / Tasks</label>
                        <div class="bsots-form-tasks" id="taskChips"></div>
                    </div>

                    <div class="bsots-form-group">
                        <label for="patientNote">Initial Note (optional)</label>
                        <textarea id="patientNote" rows="2" placeholder="Brief note..."></textarea>
                    </div>
                </form>
            </div>
            <div class="bsots-modal-footer">
                <button class="bsots-btn" id="cancelAddBtn">Cancel</button>
                <button class="bsots-btn bsots-btn-primary" id="submitAddBtn">Add Patient</button>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div class="bsots-modal-overlay" id="notesModal" style="display:none;">
        <div class="bsots-modal">
            <div class="bsots-modal-header">
                <h2>Notes - <span id="notesPatientLabel"></span></h2>
                <button class="bsots-modal-close" id="closeNotesModal">&times;</button>
            </div>
            <div class="bsots-modal-body">
                <div class="bsots-form-group" style="margin-bottom:0;">
                    <textarea id="noteText" rows="8" placeholder="Type notes here..." style="font-family:monospace;"></textarea>
                </div>
            </div>
            <div class="bsots-modal-footer">
                <button class="bsots-btn" id="cancelNotesBtn">Close</button>
                <button class="bsots-btn bsots-btn-primary" id="saveNoteBtn">Save</button>
                <button class="bsots-btn bsots-btn-danger" id="clearNoteBtn">Clear</button>
            </div>
        </div>
    </div>

    <!-- Time Entry Modal -->
    <div class="bsots-modal-overlay" id="timeEntryModal" style="display:none;">
        <div class="bsots-modal" style="max-width:400px;">
            <div class="bsots-modal-header">
                <h2 id="timeEntryTitle">Enter Time</h2>
                <button class="bsots-modal-close" id="closeTimeEntryModal">&times;</button>
            </div>
            <div class="bsots-modal-body">
                <div class="bsots-form-group">
                    <label id="timeEntryLabel">Time:</label>
                    <input type="time" id="timeEntryInput" step="60" style="font-size:16px;padding:8px;">
                    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
                        <button class="bsots-btn" id="timeNowBtn">Now</button>
                        <button class="bsots-btn" id="timeMinus1Btn">-1 min</button>
                        <button class="bsots-btn" id="timeMinus5Btn">-5 mins</button>
                        <button class="bsots-btn" id="timeMinus10Btn">-10 mins</button>
                    </div>
                </div>
            </div>
            <div class="bsots-modal-footer">
                <button class="bsots-btn" id="cancelTimeEntryBtn">Cancel</button>
                <button class="bsots-btn bsots-btn-primary" id="saveTimeEntryBtn">Save</button>
            </div>
        </div>
    </div>

    <!-- Disclaimer Splash Modal -->
    <div class="bsots-modal-overlay" id="disclaimerModal" style="display:flex;">
        <div class="bsots-modal" style="max-width:600px;">
            <div class="bsots-modal-header">
                <h2>⚠️ Prototype - Not For Clinical Use</h2>
            </div>
            <div class="bsots-modal-body">
                <p style="font-size:15px;line-height:1.6;margin-bottom:16px;">
                    <strong>This is a prototype demonstration system.</strong>
                </p>
                <p style="font-size:14px;line-height:1.6;margin-bottom:12px;">
                    This BSOTs (Birmingham Symptom-specific Obstetric Triage System) triage board is
                    <strong>NOT approved for clinical use</strong> and should not be used for patient care decisions.
                </p>
                <p style="font-size:14px;line-height:1.6;margin-bottom:12px;">
                    It is intended for demonstration, testing, and development purposes only.
                </p>
                <p style="font-size:13px;color:var(--text-muted);margin-bottom:0;">
                    By continuing, you acknowledge that this is a prototype system not suitable for clinical decision-making.
                </p>
            </div>
            <div class="bsots-modal-footer">
                <button class="bsots-btn bsots-btn-primary" id="acceptDisclaimerBtn" style="min-width:150px;">I Understand - Continue</button>
            </div>
        </div>
    </div>

    <script type="module" src="firebase-init.js"></script>

    <script type="module">
        import {
            URGENCY_CATEGORIES, PRESENTING_REASONS, DEFAULT_SITES, DEFAULT_TASKS,
            BSOTS_ALGORITHMS
        } from './js/bsots/constants.js';

        import {
            subscribeToEpisodes, addEpisode, updateEpisode,
            changeUrgency, toggleTask, addNote, addTaskToEpisode,
            startTriage, completeTriage, completeReview, setOutcome,
            checkAndUpdateBreaches, toDate
        } from './js/bsots/firestore.js';

        import { Timestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

        import {
            formatCountdown, formatTime, formatDateTime, formatTimeInUnit,
            getCountdownClass, getRemainingMs
        } from './js/bsots/countdown.js';

        // ─── State ──────────────────────────────────────────────────────────
        let currentSiteId = localStorage.getItem('bsots_site') || DEFAULT_SITES[0].id;
        let episodes = [];
        let previousEpisodeIds = new Set();
        let newEpisodeIds = new Map(); // id -> timestamp when first seen
        let unsubscribe = null;
        let tickInterval = null;
        let breachInterval = null;
        let filterUrgency = '';
        let filterReason = '';
        let activeStatFilter = ''; // urgency filter from clicking stats

        // ─── DOM ────────────────────────────────────────────────────────────
        const $ = id => document.getElementById(id);
        const $siteTabs = $('siteTabs');
        const $statsBar = $('statsBar');
        const $boardTable = $('boardTable');
        const $boardBody = $('boardBody');
        const $loadingState = $('loadingState');
        const $emptyState = $('emptyState');
        const $errorState = $('errorState');
        const $errorMessage = $('errorMessage');
        const $filterUrgency = $('filterUrgency');
        const $filterReason = $('filterReason');
        const $addPatientModal = $('addPatientModal');
        const $notesModal = $('notesModal');

        // ─── Helpers ────────────────────────────────────────────────────────
        function esc(str) {
            if (!str) return '';
            const d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML;
        }

        function showToast(msg, type = 'success') {
            const t = document.createElement('div');
            t.className = `bsots-toast bsots-toast-${type}`;
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        const URGENCY_ORDER = { RED: 3, ORANGE: 2, YELLOW: 1, GREEN: 0 };

        function getStatusTag(ep) {
            if (!ep.triageStartedAt) return { label: 'Awaiting Triage', cls: 'awaiting-triage' };
            if (!ep.triageCompletedAt) return { label: 'In Triage', cls: 'in-triage' };
            if (ep.investigationsRequestedAt && !ep.medicalReviewedAt) return { label: 'Awaiting Investigation', cls: 'awaiting-investigation' };
            if (!ep.medicalReviewedAt) return { label: 'Awaiting Review', cls: 'awaiting-review' };
            return { label: 'Awaiting Decision', cls: 'awaiting-decision' };
        }

        function getEscalationInfo(ep) {
            const history = ep.urgencyHistory || [];
            if (history.length === 0) return null;
            const last = history[history.length - 1];
            if ((URGENCY_ORDER[last.to] || 0) > (URGENCY_ORDER[last.from] || 0)) {
                const time = last.changedAt ? formatTime(last.changedAt) : '';
                return { from: last.from, time };
            }
            return null;
        }

        function isNewEpisode(epId) {
            const firstSeen = newEpisodeIds.get(epId);
            if (!firstSeen) return false;
            return (Date.now() - firstSeen) < 30000;
        }

        // ─── Init ───────────────────────────────────────────────────────────
        function init() {
            renderSiteTabs();
            populateReasonFilter();
            populateFormSelects();
            setupFormListeners();
            setupFilterListeners();
            subscribeSite(currentSiteId);
            startTick();
            startBreachChecker();
        }

        // ─── Site Tabs ──────────────────────────────────────────────────────
        function renderSiteTabs() {
            $siteTabs.innerHTML = DEFAULT_SITES.map(s =>
                `<button class="bsots-site-tab ${s.id === currentSiteId ? 'active' : ''}" data-site="${s.id}">${s.shortName}</button>`
            ).join('');
            $siteTabs.querySelectorAll('.bsots-site-tab').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentSiteId = btn.dataset.site;
                    localStorage.setItem('bsots_site', currentSiteId);
                    renderSiteTabs();
                    subscribeSite(currentSiteId);
                });
            });
        }

        // ─── Subscribe ──────────────────────────────────────────────────────
        function subscribeSite(siteId) {
            if (unsubscribe) unsubscribe();
            showLoading();
            unsubscribe = subscribeToEpisodes(siteId, 'pending', (data) => {
                // Detect new arrivals
                const currentIds = new Set(data.map(e => e.id));
                data.forEach(ep => {
                    if (!previousEpisodeIds.has(ep.id) && previousEpisodeIds.size > 0) {
                        newEpisodeIds.set(ep.id, Date.now());
                    }
                });
                previousEpisodeIds = currentIds;
                episodes = data;
                renderBoard();
                renderStats();
                hideLoading();
            }, (error) => {
                showError(error.message || 'Unknown error');
            });
        }

        // ─── Render Board ───────────────────────────────────────────────────
        function renderBoard() {
            let filtered = episodes;
            const effectiveUrgencyFilter = activeStatFilter || filterUrgency;
            if (effectiveUrgencyFilter) filtered = filtered.filter(e => e.urgencyCategory === effectiveUrgencyFilter);
            if (filterReason) filtered = filtered.filter(e => e.presentingReason === filterReason);

            filtered.sort((a, b) => {
                const aMs = a.nextDueAt?.toMillis ? a.nextDueAt.toMillis() : 0;
                const bMs = b.nextDueAt?.toMillis ? b.nextDueAt.toMillis() : 0;
                return aMs - bMs;
            });

            if (filtered.length === 0) {
                $boardTable.style.display = 'none';
                $emptyState.style.display = 'block';
                return;
            }

            $boardTable.style.display = 'table';
            $emptyState.style.display = 'none';

            const mostUrgentId = filtered[0]?.id;
            $boardBody.innerHTML = filtered.map((ep, i) => renderRow(ep, i === 0, mostUrgentId)).join('');
            attachRowListeners();
        }

        function renderRow(ep, isMostUrgent) {
            const urgency = ep.urgencyCategory || 'GREEN';
            const countdown = formatCountdown(ep.nextDueAt);
            const isOverdue = countdown.isOverdue;
            const cdClass = getCountdownClass(ep.nextDueAt);
            const status = getStatusTag(ep);
            const escalation = getEscalationInfo(ep);
            const isNew = isNewEpisode(ep.id);

            let rowClasses = `bsots-row-${urgency}`;
            if (isOverdue) rowClasses += ' bsots-row-overdue';
            if (isMostUrgent) rowClasses += ' bsots-row-next-review';
            if (isNew) rowClasses += ' bsots-row-new';

            // Breach dots - removed as per user request
            // const breachDots = [];
            // if (ep.breachFlags?.triageDelay) breachDots.push('<span class="bsots-breach-dot" title="Triage delay breach"></span>');
            // if (ep.breachFlags?.overdue) breachDots.push('<span class="bsots-breach-dot" title="Overdue breach"></span>');

            // Tasks
            const tasks = ep.tasks || [];
            const allDone = tasks.length > 0 && tasks.every(t => t.status === 'completed');

            // Special triage tasks at top
            const triageStarted = !!ep.triageStartedAt;
            const triageCompleted = !!ep.triageCompletedAt;
            const medicalReviewed = !!ep.medicalReviewedAt;

            let specialTasksHtml = '';
            // Task 1: Start triage (within 15 mins of arrival)
            specialTasksHtml += `<div class="bsots-task bsots-task-special ${triageStarted ? 'bsots-task-completed' : ''}" data-ep="${ep.id}" data-action="start-triage">
                <input type="checkbox" ${triageStarted ? 'checked' : ''} class="bsots-task-checkbox" disabled>
                <span class="bsots-task-label" style="font-weight:600;">${triageStarted ? 'Triage started' : 'Start triage'}</span>
            </div>`;

            // Task 2: Complete triage (determines urgency and reason)
            if (triageStarted) {
                specialTasksHtml += `<div class="bsots-task bsots-task-special ${triageCompleted ? 'bsots-task-completed' : ''}" data-ep="${ep.id}" data-action="complete-triage">
                    <input type="checkbox" ${triageCompleted ? 'checked' : ''} class="bsots-task-checkbox" disabled>
                    <span class="bsots-task-label" style="font-weight:600;">${triageCompleted ? 'Triage completed' : 'Complete triage'}</span>
                </div>`;
            }

            // Task 3: Medical review (starts within timeframe after triage completion)
            if (triageCompleted) {
                specialTasksHtml += `<div class="bsots-task bsots-task-special ${medicalReviewed ? 'bsots-task-completed' : ''}" data-ep="${ep.id}" data-action="medical-review">
                    <input type="checkbox" ${medicalReviewed ? 'checked' : ''} class="bsots-task-checkbox" disabled>
                    <span class="bsots-task-label" style="font-weight:600;">${medicalReviewed ? 'Medical review done' : 'Medical review done'}</span>
                </div>`;
            }

            const taskHtml = specialTasksHtml + tasks.map(t =>
                `<div class="bsots-task ${t.status === 'completed' ? 'bsots-task-completed' : ''}" data-ep="${ep.id}" data-task="${t.id}">
                    <input type="checkbox" ${t.status === 'completed' ? 'checked' : ''} class="bsots-task-checkbox">
                    <span class="bsots-task-label" contenteditable="false">${esc(t.label)}</span>
                </div>`
            ).join('') +
            `<span class="bsots-task-add" data-ep="${ep.id}">+ add</span>` +
            (allDone ? '<span class="bsots-tasks-done" title="All tasks complete">&#10003;</span>' : '');

            // Note
            const note = ep.note || '';
            // Truncate to 50 chars, preserve newlines as <br> for display
            const notePreview = note.length > 0 ? note.substring(0, 50) + (note.length > 50 ? '...' : '') : '';
            const noteHtml = note
                ? `<span class="bsots-note-preview" data-ep="${ep.id}" title="${esc(note)}">${esc(notePreview).replace(/\n/g, '<br>')}</span>`
                : `<span class="bsots-note-add" data-ep="${ep.id}">+ note</span>`;

            // Escalation arrow
            const escHtml = escalation ? `<span class="bsots-escalation" title="Escalated from ${escalation.from} at ${escalation.time}">&uarr;</span>` : '';

            return `<tr class="${rowClasses}" data-episode-id="${ep.id}">
                <td><span class="bsots-status-tag bsots-status-${status.cls}">${status.label}</span></td>
                <td>
                    <strong>${esc(ep.initials || '--')}</strong>${isMostUrgent ? '<span class="bsots-next-badge">Next</span>' : ''}${isNew ? '<span class="bsots-new-badge">NEW</span>' : ''}
                </td>
                <td>${esc(ep.hospitalNumber || '--')}</td>
                <td>
                    <div class="bsots-time-stacked">
                        <div><span class="bsots-time-label">Arr</span> <span class="bsots-time-value">${formatTime(ep.arrivalAt)}</span></div>
                        <div><span class="bsots-time-label">Due</span> <span class="bsots-time-value">${formatTime(ep.nextDueAt)}</span></div>
                    </div>
                </td>
                <td><span class="bsots-tiu" data-arrival="${ep.arrivalAt?.toMillis ? ep.arrivalAt.toMillis() : ''}">${formatTimeInUnit(ep.arrivalAt)}</span></td>
                <td>${esc(ep.presentingReason || '--')}</td>
                <td>
                    <span class="bsots-urgency-badge bsots-urgency-${urgency}" data-ep="${ep.id}" title="Click to change urgency">${urgency}</span>
                    ${escHtml}
                </td>
                <td>
                    <span class="bsots-countdown ${cdClass}" data-next-due="${ep.nextDueAt?.toMillis ? ep.nextDueAt.toMillis() : ''}" data-ep="${ep.id}" title="Click to record review">
                        ${countdown.text}
                    </span>
                    ${isOverdue ? '<span class="bsots-overdue-badge">OVERDUE</span>' : ''}
                </td>
                <td><div class="bsots-tasks">${taskHtml}</div></td>
                <td class="bsots-note-cell">${noteHtml}</td>
                <td><button class="bsots-menu-trigger" data-ep="${ep.id}" title="Actions">&bull;&bull;&bull;</button></td>
            </tr>`;
        }

        // ─── Row Listeners ──────────────────────────────────────────────────
        function attachRowListeners() {
            // Task checkbox toggles
            $boardBody.querySelectorAll('.bsots-task-checkbox').forEach(cb => {
                cb.addEventListener('change', async (e) => {
                    e.stopPropagation();
                    const taskDiv = e.target.closest('.bsots-task');
                    const ep = episodes.find(x => x.id === taskDiv.dataset.ep);
                    if (ep) {
                        try { await toggleTask(taskDiv.dataset.ep, ep, taskDiv.dataset.task, ''); }
                        catch { showToast('Failed to update task', 'error'); }
                    }
                });
            });

            // Task label editing
            $boardBody.querySelectorAll('.bsots-task-label').forEach(label => {
                label.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Skip special tasks (they're handled separately)
                    if (label.closest('.bsots-task-special')) return;
                    if (label.getAttribute('contenteditable') === 'true') return; // Already editing
                    const originalText = label.textContent.trim();
                    label.setAttribute('contenteditable', 'true');
                    label.focus();

                    // Select all text
                    const range = document.createRange();
                    range.selectNodeContents(label);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);

                    const saveEdit = async () => {
                        const newText = label.textContent.trim();
                        label.setAttribute('contenteditable', 'false');
                        if (newText && newText !== originalText) {
                            const taskDiv = label.closest('.bsots-task');
                            const ep = episodes.find(x => x.id === taskDiv.dataset.ep);
                            if (ep) {
                                const task = ep.tasks.find(t => t.id === taskDiv.dataset.task);
                                if (task) {
                                    try {
                                        const updatedTasks = ep.tasks.map(t =>
                                            t.id === taskDiv.dataset.task ? { ...t, label: newText } : t
                                        );
                                        await updateEpisode(taskDiv.dataset.ep, { tasks: updatedTasks });
                                        showToast('Task updated', 'success');
                                    } catch {
                                        label.textContent = originalText;
                                        showToast('Failed to update task', 'error');
                                    }
                                }
                            }
                        } else {
                            label.textContent = originalText;
                        }
                    };

                    label.addEventListener('blur', saveEdit, { once: true });
                    label.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            label.blur();
                        }
                        if (e.key === 'Escape') {
                            label.textContent = originalText;
                            label.setAttribute('contenteditable', 'false');
                            label.blur();
                        }
                    }, { once: true });
                });
            });

            // Special task clicks (triage and medical review)
            $boardBody.querySelectorAll('.bsots-task-special').forEach(taskDiv => {
                const action = taskDiv.dataset.action;
                const isCompleted = taskDiv.classList.contains('bsots-task-completed');

                if (!isCompleted) {
                    taskDiv.style.cursor = 'pointer';
                    taskDiv.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const epId = taskDiv.dataset.ep;
                        const ep = episodes.find(x => x.id === epId);
                        if (ep) {
                            if (action === 'start-triage') {
                                openTimeEntryModal('Start Triage', 'When did triage start?', async (time) => {
                                    try {
                                        await updateEpisode(epId, { triageStartedAt: time });
                                        showToast('Triage started recorded', 'success');
                                    } catch {
                                        showToast('Failed to record triage start', 'error');
                                    }
                                });
                            } else if (action === 'complete-triage') {
                                openTimeEntryModal('Complete Triage', 'When was triage completed?', async (time) => {
                                    try {
                                        // Calculate nextDueAt from triage completion time + urgency
                                        const urgency = ep.urgencyCategory || 'GREEN';
                                        const nextDueAt = computeNextDueAt(time, urgency);
                                        await updateEpisode(epId, {
                                            triageCompletedAt: time,
                                            nextDueAt
                                        });
                                        showToast('Triage completed recorded', 'success');
                                    } catch {
                                        showToast('Failed to record triage completion', 'error');
                                    }
                                });
                            } else if (action === 'medical-review') {
                                openTimeEntryModal('Medical Review Done', 'When was medical review completed?', async (time) => {
                                    try {
                                        await updateEpisode(epId, {
                                            medicalReviewedAt: time,
                                            reviewRequestedAt: ep.reviewRequestedAt || time
                                        });
                                        showToast('Medical review recorded', 'success');
                                    } catch {
                                        showToast('Failed to record medical review', 'error');
                                    }
                                });
                            }
                        }
                    });
                }
            });

            // Inline task add
            $boardBody.querySelectorAll('.bsots-task-add').forEach(el => {
                el.addEventListener('click', (e) => {
                    if (el.querySelector('input')) return;
                    const input = document.createElement('input');
                    input.className = 'bsots-task-add-input';
                    input.placeholder = 'Task name';
                    input.addEventListener('keydown', async (ev) => {
                        if (ev.key === 'Enter' && input.value.trim()) {
                            const ep = episodes.find(x => x.id === el.dataset.ep);
                            if (ep) {
                                try { await addTaskToEpisode(el.dataset.ep, ep, input.value.trim(), ''); showToast('Task added', 'success'); }
                                catch { showToast('Failed to add task', 'error'); }
                            }
                        }
                        if (ev.key === 'Escape') input.remove();
                    });
                    input.addEventListener('blur', () => setTimeout(() => input.remove(), 200));
                    el.textContent = '';
                    el.appendChild(input);
                    input.focus();
                });
            });

            // Note clicks -> open modal
            $boardBody.querySelectorAll('.bsots-note-preview, .bsots-note-add').forEach(el => {
                el.addEventListener('click', () => openNotesModal(el.dataset.ep));
            });

            // Urgency badge click -> dropdown
            $boardBody.querySelectorAll('.bsots-urgency-badge').forEach(badge => {
                badge.addEventListener('click', (e) => showUrgencyDropdown(e, badge.dataset.ep));
            });

            // Countdown click -> review action
            $boardBody.querySelectorAll('.bsots-countdown').forEach(el => {
                el.addEventListener('click', () => handleReview(el.dataset.ep));
            });

            // ••• menu
            $boardBody.querySelectorAll('.bsots-menu-trigger').forEach(btn => {
                btn.addEventListener('click', (e) => showContextMenu(e, btn.dataset.ep));
            });
        }

        // ─── Tick (countdown + time-in-unit) ────────────────────────────────
        function startTick() {
            if (tickInterval) clearInterval(tickInterval);
            tickInterval = setInterval(() => {
                // Countdowns
                document.querySelectorAll('.bsots-countdown[data-next-due]').forEach(el => {
                    const dueMs = parseInt(el.dataset.nextDue);
                    if (!dueMs) return;
                    const mock = { toMillis: () => dueMs };
                    const cd = formatCountdown(mock);
                    el.textContent = cd.text;
                    el.className = `bsots-countdown ${getCountdownClass(mock)}`;
                    const row = el.closest('tr');
                    if (row) {
                        const badge = row.querySelector('.bsots-overdue-badge');
                        if (cd.isOverdue && !badge) {
                            el.insertAdjacentHTML('afterend', '<span class="bsots-overdue-badge">OVERDUE</span>');
                            row.classList.add('bsots-row-overdue');
                        }
                    }
                });
                // Time in unit
                document.querySelectorAll('.bsots-tiu[data-arrival]').forEach(el => {
                    const arrMs = parseInt(el.dataset.arrival);
                    if (!arrMs) return;
                    const mock = { toMillis: () => arrMs };
                    el.textContent = formatTimeInUnit(mock);
                });
                // Clean up expired NEW badges
                for (const [id, ts] of newEpisodeIds) {
                    if (Date.now() - ts > 30000) newEpisodeIds.delete(id);
                }
            }, 1000);
        }

        // ─── Breach Checker ─────────────────────────────────────────────────
        function startBreachChecker() {
            if (breachInterval) clearInterval(breachInterval);
            breachInterval = setInterval(() => {
                episodes.forEach(ep => {
                    if (ep.status === 'pending') checkAndUpdateBreaches(ep.id, ep).catch(() => {});
                });
            }, 30000);
        }

        // ─── Stats (clickable) ──────────────────────────────────────────────
        function renderStats() {
            const counts = { RED: 0, ORANGE: 0, YELLOW: 0, GREEN: 0 };
            let overdueCount = 0;
            episodes.forEach(ep => {
                if (counts.hasOwnProperty(ep.urgencyCategory)) counts[ep.urgencyCategory]++;
                if (getRemainingMs(ep.nextDueAt) <= 0) overdueCount++;
            });

            let html = Object.entries(counts).map(([cat, count]) => {
                const isActive = activeStatFilter === cat;
                return `<span class="bsots-stat bsots-stat-${cat.toLowerCase()} ${isActive ? 'active' : ''}" data-filter="${cat}">${cat}: ${count}</span>`;
            }).join('');

            if (overdueCount > 0) {
                const isActive = activeStatFilter === 'OVERDUE';
                html += `<span class="bsots-stat bsots-stat-overdue ${isActive ? 'active' : ''}" data-filter="OVERDUE">OVERDUE: ${overdueCount}</span>`;
            }

            $statsBar.innerHTML = html;

            $statsBar.querySelectorAll('.bsots-stat').forEach(stat => {
                stat.addEventListener('click', () => {
                    const f = stat.dataset.filter;
                    if (activeStatFilter === f) {
                        activeStatFilter = '';
                    } else {
                        activeStatFilter = f;
                    }
                    $filterUrgency.value = '';
                    filterUrgency = '';
                    renderBoard();
                    renderStats();
                });
            });
        }

        // ─── Filters ────────────────────────────────────────────────────────
        function populateReasonFilter() {
            PRESENTING_REASONS.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r; opt.textContent = r;
                $filterReason.appendChild(opt);
            });
        }

        function setupFilterListeners() {
            $filterUrgency.addEventListener('change', () => {
                filterUrgency = $filterUrgency.value;
                activeStatFilter = '';
                renderBoard();
                renderStats();
            });
            $filterReason.addEventListener('change', () => {
                filterReason = $filterReason.value;
                renderBoard();
            });
        }

        // ─── Add Patient ────────────────────────────────────────────────────
        function populateFormSelects() {
            const $site = $('patientSite');
            DEFAULT_SITES.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = s.shortName + ' - ' + s.name;
                if (s.id === currentSiteId) opt.selected = true;
                $site.appendChild(opt);
            });
            const $reason = $('patientReason');
            PRESENTING_REASONS.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r; opt.textContent = r;
                $reason.appendChild(opt);
            });
        }

        // ─── Algorithm Panel ─────────────────────────────────────────────────
        function renderAlgorithmPanel(reason) {
            const algo = BSOTS_ALGORITHMS[reason];
            const $panel = $('algorithmPanel');
            const $grid = $('algorithmGrid');
            if (!algo) { $panel.style.display = 'none'; return; }

            const categories = ['RED', 'ORANGE', 'YELLOW', 'GREEN'];
            $grid.innerHTML = categories.map(cat => {
                const data = algo[cat];
                if (!data) return '';
                const cfg = URGENCY_CATEGORIES[cat];
                return `
                    <div class="bsots-algo-category" data-urgency="${cat}">
                        <div class="bsots-algo-cat-header" style="background:${cfg.color}; color:${cat === 'YELLOW' ? '#333' : '#fff'};">
                            <strong>${cat}</strong> — ${cfg.description}
                        </div>
                        <div class="bsots-algo-criteria">
                            ${data.criteria.map((c, i) => `
                                <div class="bsots-algo-criterion" data-urgency="${cat}" data-idx="${i}">
                                    <span class="bsots-algo-bullet" style="background:${cfg.color};"></span>
                                    ${esc(c)}
                                </div>
                            `).join('')}
                        </div>
                        <div class="bsots-algo-actions-preview">
                            <div class="bsots-algo-actions-label">Immediate actions:</div>
                            ${data.actions.map(a => `<div class="bsots-algo-action-item">${esc(a)}</div>`).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            // Attach click handlers to criteria
            $grid.querySelectorAll('.bsots-algo-criterion').forEach(el => {
                el.addEventListener('click', () => {
                    const urgency = el.dataset.urgency;
                    const criterionText = el.textContent.trim();
                    selectUrgencyFromAlgorithm(reason, urgency, criterionText);
                });
            });

            // Also allow clicking the category header to select
            $grid.querySelectorAll('.bsots-algo-cat-header').forEach(el => {
                const cat = el.closest('.bsots-algo-category');
                el.style.cursor = 'pointer';
                el.addEventListener('click', () => {
                    selectUrgencyFromAlgorithm(reason, cat.dataset.urgency, null);
                });
            });

            $panel.style.display = 'block';
        }

        function selectUrgencyFromAlgorithm(reason, urgency, criterionText) {
            const algo = BSOTS_ALGORITHMS[reason];
            const cfg = URGENCY_CATEGORIES[urgency];
            if (!algo || !cfg) return;

            // Set urgency
            $('patientUrgency').value = urgency;

            // Show selected urgency bar with criterion
            const $bar = $('selectedUrgencyBar');
            const $label = $('selectedUrgencyLabel');
            let labelHtml = `<span class="bsots-urgency-badge bsots-urgency-${urgency}" style="font-size:13px;">${urgency}</span> — ${cfg.description}`;
            if (criterionText) {
                labelHtml += `<div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Selected: ${esc(criterionText)}</div>`;
            }
            $label.innerHTML = labelHtml;
            $bar.style.display = 'flex';

            // Collapse algorithm panel
            $('algorithmPanel').style.display = 'none';

            // Populate tasks from algorithm actions
            const $chips = $('taskChips');
            $chips.innerHTML = '';
            const actions = algo[urgency].actions;
            actions.forEach(a => {
                const chip = document.createElement('div');
                chip.className = 'bsots-form-task-chip selected';
                chip.dataset.label = a;
                chip.textContent = a;
                chip.addEventListener('click', () => chip.classList.toggle('selected'));
                $chips.appendChild(chip);
            });
            // Also add standard tasks (Observations, CTG, Bloods, Urinalysis) if not already covered
            DEFAULT_TASKS.forEach(t => {
                if (!actions.some(a => a.toLowerCase().includes(t.label.toLowerCase()))) {
                    const chip = document.createElement('div');
                    chip.className = 'bsots-form-task-chip';
                    chip.dataset.label = t.label;
                    chip.textContent = t.label;
                    chip.addEventListener('click', () => chip.classList.toggle('selected'));
                    $chips.appendChild(chip);
                }
            });
            $('actionsSection').style.display = 'block';
        }

        function clearUrgencySelection() {
            $('patientUrgency').value = '';
            $('selectedUrgencyBar').style.display = 'none';
            $('actionsSection').style.display = 'none';
            $('taskChips').innerHTML = '';
            const reason = $('patientReason').value;
            if (reason) renderAlgorithmPanel(reason);
        }

        function setupFormListeners() {
            // Reason change → show algorithm
            $('patientReason').addEventListener('change', (e) => {
                clearUrgencySelection();
                if (e.target.value) {
                    renderAlgorithmPanel(e.target.value);
                } else {
                    $('algorithmPanel').style.display = 'none';
                }
            });

            $('clearUrgencyBtn').addEventListener('click', (e) => {
                e.preventDefault();
                clearUrgencySelection();
            });

            $('addPatientBtn').addEventListener('click', () => {
                $addPatientModal.style.display = 'flex';
                $('patientSite').value = currentSiteId;
                $('patientInitials').focus();
            });
            $('closeAddModal').addEventListener('click', closeAddModal);
            $('cancelAddBtn').addEventListener('click', closeAddModal);
            $addPatientModal.addEventListener('click', e => { if (e.target === $addPatientModal) closeAddModal(); });
            $('submitAddBtn').addEventListener('click', handleAddPatient);
        }

        function closeAddModal() {
            $addPatientModal.style.display = 'none';
            $('addPatientForm').reset();
            $('patientUrgency').value = '';
            $('algorithmPanel').style.display = 'none';
            $('selectedUrgencyBar').style.display = 'none';
            $('actionsSection').style.display = 'none';
            $('taskChips').innerHTML = '';
        }

        async function handleAddPatient() {
            const initials = $('patientInitials').value.trim();
            const hospitalNumber = $('patientHospNum').value.trim();
            const siteId = $('patientSite').value;
            const presentingReason = $('patientReason').value || 'Awaiting triage';
            const urgencyCategory = $('patientUrgency').value || 'GREEN';
            const initialNote = $('patientNote').value.trim();
            if (!initials || !hospitalNumber) {
                showToast('Please enter patient initials and hospital number', 'error'); return;
            }
            const selectedTasks = [];
            document.querySelectorAll('.bsots-form-task-chip.selected').forEach(c => selectedTasks.push({ label: c.dataset.label }));
            try {
                await addEpisode({ siteId, initials, hospitalNumber, presentingReason, urgencyCategory, tasks: selectedTasks, initialNote: initialNote || null });
                closeAddModal();
                showToast('Patient added to triage board', 'success');
            } catch (err) {
                showToast('Failed to add patient: ' + err.message, 'error');
            }
        }

        // ─── Urgency Dropdown ───────────────────────────────────────────────
        function showUrgencyDropdown(event, episodeId) {
            removeMenus();
            const episode = episodes.find(e => e.id === episodeId);
            if (!episode) return;
            const dd = document.createElement('div');
            dd.className = 'bsots-urgency-dropdown';
            Object.entries(URGENCY_CATEGORIES).forEach(([key, cfg]) => {
                if (key === episode.urgencyCategory) return;
                const item = document.createElement('div');
                item.className = 'bsots-urgency-dropdown-item';
                item.innerHTML = `<span class="bsots-urgency-dot" style="background:${cfg.color}"></span> ${key} (${cfg.description})`;
                item.addEventListener('click', async () => {
                    try { await changeUrgency(episodeId, episode, key, ''); showToast(`Urgency changed to ${key}`, 'success'); }
                    catch { showToast('Failed to change urgency', 'error'); }
                    removeMenus();
                });
                dd.appendChild(item);
            });
            positionMenu(dd, event.target);
            document.body.appendChild(dd);
            setTimeout(() => document.addEventListener('click', onOutsideClick, { once: true }), 0);
        }

        // ─── Context Menu (•••) ─────────────────────────────────────────────
        function showContextMenu(event, episodeId) {
            removeMenus();
            const ep = episodes.find(e => e.id === episodeId);
            if (!ep) return;
            const menu = document.createElement('div');
            menu.className = 'bsots-context-menu';

            // Outcome
            menu.innerHTML += '<div class="bsots-context-menu-sub">Outcome</div>';
            [
                { value: 'admitted', label: 'Admit', color: '#fd7e14' },
                { value: 'discharged', label: 'Discharge Home', color: '#28a745' },
                { value: 'transferred', label: 'Transfer', color: '#17a2b8' }
            ].forEach(o => {
                const item = document.createElement('div');
                item.className = 'bsots-context-menu-item';
                item.innerHTML = `<span class="bsots-urgency-dot" style="background:${o.color}"></span> ${o.label}`;
                item.addEventListener('click', async () => {
                    if (confirm(`Set outcome to "${o.label}" for ${ep.initials}?`)) {
                        try { await setOutcome(episodeId, ep, o.value); showToast(`${ep.initials} - ${o.label}`, 'success'); }
                        catch { showToast('Failed to set outcome', 'error'); }
                    }
                    removeMenus();
                });
                menu.appendChild(item);
            });

            positionMenu(menu, event.target);
            document.body.appendChild(menu);
            setTimeout(() => document.addEventListener('click', onOutsideClick, { once: true }), 0);
        }

        // ─── Review (countdown click) ───────────────────────────────────────
        async function handleReview(episodeId) {
            const ep = episodes.find(e => e.id === episodeId);
            if (!ep) return;
            let action, label;
            if (!ep.triageStartedAt) { action = () => startTriage(episodeId, ep); label = 'Triage started'; }
            else if (!ep.triageCompletedAt) { action = () => completeTriage(episodeId, ep); label = 'Triage completed'; }
            else if (!ep.medicalReviewedAt) { action = () => completeReview(episodeId, ep); label = 'Medical review recorded'; }
            else { showToast('All reviews completed', 'success'); return; }
            try { await action(); showToast(label, 'success'); }
            catch { showToast('Failed to record review', 'error'); }
        }

        // ─── Notes Modal ────────────────────────────────────────────────────
        let currentNotesEpId = null;

        function openNotesModal(epId) {
            currentNotesEpId = epId;
            const ep = episodes.find(e => e.id === epId);
            if (!ep) return;
            $('notesPatientLabel').textContent = `${ep.initials} (${ep.hospitalNumber})`;
            $('noteText').value = ep.note || '';
            $notesModal.style.display = 'flex';
            $('noteText').focus();
        }

        function closeNotesModal() {
            $notesModal.style.display = 'none';
            currentNotesEpId = null;
        }

        $('closeNotesModal').addEventListener('click', closeNotesModal);
        $('cancelNotesBtn').addEventListener('click', closeNotesModal);
        $notesModal.addEventListener('click', e => { if (e.target === $notesModal) closeNotesModal(); });

        $('saveNoteBtn').addEventListener('click', async () => {
            if (!currentNotesEpId) return;
            const text = $('noteText').value.trim();
            try {
                await updateEpisode(currentNotesEpId, { note: text });
                showToast('Note saved', 'success');
                closeNotesModal();
            }
            catch { showToast('Failed to save note', 'error'); }
        });

        $('clearNoteBtn').addEventListener('click', async () => {
            if (!currentNotesEpId) return;
            if (!confirm('Clear all notes for this patient?')) return;
            try {
                await updateEpisode(currentNotesEpId, { note: '' });
                $('noteText').value = '';
                showToast('Note cleared', 'success');
            }
            catch { showToast('Failed to clear note', 'error'); }
        });

        // ─── Time Entry Modal ───────────────────────────────────────────────
        const $timeEntryModal = document.getElementById('timeEntryModal');
        const $timeEntryInput = document.getElementById('timeEntryInput');
        let timeEntryCallback = null;

        function openTimeEntryModal(title, label, callback) {
            document.getElementById('timeEntryTitle').textContent = title;
            document.getElementById('timeEntryLabel').textContent = label;
            timeEntryCallback = callback;

            // Set default to now
            const now = new Date();
            $timeEntryInput.value = now.toTimeString().substring(0, 5);
            $timeEntryModal.style.display = 'flex';
            $timeEntryInput.focus();
        }

        function closeTimeEntryModal() {
            $timeEntryModal.style.display = 'none';
            timeEntryCallback = null;
        }

        document.getElementById('closeTimeEntryModal').addEventListener('click', closeTimeEntryModal);
        document.getElementById('cancelTimeEntryBtn').addEventListener('click', closeTimeEntryModal);

        document.getElementById('saveTimeEntryBtn').addEventListener('click', async () => {
            if (!timeEntryCallback || !$timeEntryInput.value) return;

            // Parse time input and convert to Timestamp
            const [hours, minutes] = $timeEntryInput.value.split(':').map(Number);
            const selectedTime = new Date();
            selectedTime.setHours(hours, minutes, 0, 0);

            const timestamp = toTimestamp(selectedTime);
            await timeEntryCallback(timestamp);
            closeTimeEntryModal();
        });

        // Time adjustment buttons
        document.getElementById('timeNowBtn').addEventListener('click', () => {
            const now = new Date();
            $timeEntryInput.value = now.toTimeString().substring(0, 5);
        });

        document.getElementById('timeMinus1Btn').addEventListener('click', () => {
            adjustTime(-1);
        });

        document.getElementById('timeMinus5Btn').addEventListener('click', () => {
            adjustTime(-5);
        });

        document.getElementById('timeMinus10Btn').addEventListener('click', () => {
            adjustTime(-10);
        });

        function adjustTime(minutesDelta) {
            if (!$timeEntryInput.value) return;
            const [hours, minutes] = $timeEntryInput.value.split(':').map(Number);
            const time = new Date();
            time.setHours(hours, minutes, 0, 0);
            time.setMinutes(time.getMinutes() + minutesDelta);
            $timeEntryInput.value = time.toTimeString().substring(0, 5);
        }

        // ─── Disclaimer Modal ───────────────────────────────────────────────
        const $disclaimerModal = document.getElementById('disclaimerModal');

        document.getElementById('acceptDisclaimerBtn').addEventListener('click', () => {
            $disclaimerModal.style.display = 'none';
        });

        // ─── Menu Helpers ───────────────────────────────────────────────────
        function positionMenu(menu, target) {
            const rect = target.getBoundingClientRect();
            menu.style.top = (rect.bottom + 4) + 'px';
            menu.style.left = Math.min(rect.left, window.innerWidth - 200) + 'px';
        }

        function removeMenus() {
            document.querySelectorAll('.bsots-urgency-dropdown, .bsots-context-menu').forEach(el => el.remove());
        }

        function onOutsideClick(e) {
            const m = document.querySelector('.bsots-urgency-dropdown, .bsots-context-menu');
            if (m && !m.contains(e.target)) removeMenus();
        }

        // ─── UI State ───────────────────────────────────────────────────────
        function showLoading() { $loadingState.style.display = 'flex'; $boardTable.style.display = 'none'; $emptyState.style.display = 'none'; $errorState.style.display = 'none'; }
        function hideLoading() { $loadingState.style.display = 'none'; $errorState.style.display = 'none'; }
        function showError(msg) { $loadingState.style.display = 'none'; $boardTable.style.display = 'none'; $emptyState.style.display = 'none'; $errorState.style.display = 'block'; $errorMessage.textContent = msg; }

        // ─── Start ──────────────────────────────────────────────────────────
        init();
    </script>
</body>
</html>
