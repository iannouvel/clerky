<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: server/utils/aiLogger.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: server/utils/aiLogger.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { db, admin } = require('../config/firebase');
const { debugLog } = require('../config/logger');
const fs = require('fs');
const path = require('path');

/**
 * Log AI interaction to Firestore or file system as fallback
 * @param {string|object} prompt - The prompt sent to AI
 * @param {string|object} response - The response received from AI
 * @param {string} endpoint - The endpoint or operation name
 * @param {string} userId - The user ID initiating the request
 * @returns {Promise&lt;boolean>} - Success status
 */
async function logAIInteraction(prompt, response, endpoint, userId = null) {
    try {
        // OPTIMISATION: Only log important interactions to reduce noise
        const importantEndpoints = [
            'submit', 'reply', 'findRelevantGuidelines', 'checkAgainstGuidelines',
            'generateClinicalNote', 'error', 'failure', 'handleAction', 'handleIssues',
            'analyzeNoteAgainstGuideline'
        ];

        const shouldLog = importantEndpoints.some(important => endpoint.includes(important)) ||
            (response &amp;&amp; response.error) ||
            (response &amp;&amp; response.critical);

        if (!shouldLog) {
            // Skipping non-critical endpoint logging to reduce noise
            return true;
        }

        // Get current timestamp
        const timestamp = new Date().toISOString();

        // Clean prompt for logging
        let cleanedPrompt = prompt;
        if (typeof prompt === 'object') {
            cleanedPrompt = JSON.stringify(prompt, null, 2);
        }

        // Clean response for logging
        let cleanedResponse = '';
        let ai_provider = 'DeepSeek'; // Default to DeepSeek
        let ai_model = 'deepseek-chat'; // Default model
        let token_usage = null; // Initialize token usage

        // Extract AI information if it exists in the response
        if (response &amp;&amp; typeof response === 'object') {
            // Extract token usage if available
            if (response.token_usage) {
                token_usage = response.token_usage;
            } else if (response.response &amp;&amp; response.response.token_usage) {
                token_usage = response.response.token_usage;
            }

            // If response has ai_provider and ai_model directly
            if (response.ai_provider) {
                ai_provider = response.ai_provider;
                ai_model = response.ai_model || (ai_provider === 'OpenAI' ? 'gpt-3.5-turbo' : 'deepseek-chat');
            }
            // If response has nested response property with ai info
            else if (response.response &amp;&amp; typeof response.response === 'object') {
                if (response.response.ai_provider) {
                    ai_provider = response.response.ai_provider;
                    ai_model = response.response.ai_model || (ai_provider === 'OpenAI' ? 'gpt-3.5-turbo' : 'deepseek-chat');
                }
            }

            // Extract the actual content from the response structure
            if (endpoint === 'handleGuidelines' || endpoint === 'handleIssues') {
                if (response.success === true &amp;&amp; response.response) {
                    if (typeof response.response === 'string') {
                        cleanedResponse = response.response;
                    } else if (Array.isArray(response.response)) {
                        cleanedResponse = response.response.join('\n');
                    } else if (typeof response.response === 'object') {
                        if ('content' in response.response) {
                            cleanedResponse = response.response.content;
                        } else if ('text' in response.response) {
                            cleanedResponse = response.response.text;
                        } else if ('message' in response.response) {
                            cleanedResponse = response.response.message;
                        } else {
                            cleanedResponse = JSON.stringify(response.response, null, 2);
                        }
                    }
                }
            } else {
                if (response.content) {
                    cleanedResponse = response.content;
                } else if (response.response &amp;&amp; typeof response.response === 'string') {
                    cleanedResponse = response.response;
                } else if (response.response &amp;&amp; response.response.content) {
                    cleanedResponse = response.response.content;
                } else if (response.text) {
                    cleanedResponse = response.text;
                } else if (typeof response === 'string') {
                    cleanedResponse = response;
                } else if (typeof response === 'object') {
                    cleanedResponse = JSON.stringify(response, null, 2);
                }
            }
        }

        if (!cleanedResponse || cleanedResponse.trim() === '') {
            cleanedResponse = '[Empty response or response extraction failed]';
        }

        // Prepare data for Firestore
        const isError = endpoint.includes('error') || endpoint.includes('failure') || (response &amp;&amp; response.error);

        // Save to Firestore if available
        if (db) {
            try {
                const MAX_CONTENT_LENGTH = 50000;
                await db.collection('aiInteractions').add({
                    timestamp: admin.firestore.FieldValue.serverTimestamp(),
                    userId: userId || 'system',
                    endpoint: endpoint,
                    provider: ai_provider,
                    model: ai_model,
                    success: !isError,
                    promptLength: cleanedPrompt.length,
                    responseLength: cleanedResponse.length,
                    fullPrompt: cleanedPrompt.length > MAX_CONTENT_LENGTH
                        ? cleanedPrompt.substring(0, MAX_CONTENT_LENGTH) + '\n\n[TRUNCATED]'
                        : cleanedPrompt,
                    fullResponse: cleanedResponse.length > MAX_CONTENT_LENGTH
                        ? cleanedResponse.substring(0, MAX_CONTENT_LENGTH) + '\n\n[TRUNCATED]'
                        : cleanedResponse,
                    tokenUsage: token_usage,
                    critical: isError
                });

                debugLog(`Successfully logged AI interaction to Firestore for endpoint: ${endpoint}`);
                return true;
            } catch (firestoreError) {
                console.error('Error saving to Firestore in logAIInteraction:', firestoreError);
            }
        }

        // Fallback: emergency local save
        try {
            const localLogsDir = path.join(__dirname, '../../logs/emergency-logs');
            if (!fs.existsSync(localLogsDir)) {
                fs.mkdirSync(localLogsDir, { recursive: true });
            }

            const fileTimestamp = timestamp.replace(/[:.]/g, '-');
            const emergencyLogPath = path.join(localLogsDir, `${fileTimestamp}-${endpoint}-emergency.json`);

            fs.writeFileSync(emergencyLogPath, JSON.stringify({
                timestamp,
                userId: userId || 'system',
                endpoint,
                prompt: cleanedPrompt,
                response: cleanedResponse,
                ai_provider,
                ai_model,
                token_usage,
                isError
            }, null, 2));

            return true;
        } catch (emergencyError) {
            console.error('Failed to save emergency logs:', emergencyError);
            return false;
        }
    } catch (error) {
        console.error('Unexpected error in logAIInteraction:', error);
        return false;
    }
}

module.exports = {
    logAIInteraction
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-server_services_ai.html">server/services/ai</a></li><li><a href="module-server_services_pdf.html">server/services/pdf</a></li></ul><h3>Classes</h3><ul><li><a href="ClinicalDataAnonymiser.html">ClinicalDataAnonymiser</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Logger">Logger</a></li><li><a href="global.html#admin">admin</a></li><li><a href="global.html#analyzeNoteAgainstGuideline">analyzeNoteAgainstGuideline</a></li><li><a href="global.html#applyColoredReplacements">applyColoredReplacements</a></li><li><a href="global.html#applyMobileLayout">applyMobileLayout</a></li><li><a href="global.html#arbitrateCGPDisagreements">arbitrateCGPDisagreements</a></li><li><a href="global.html#assessClinicalImpact">assessClinicalImpact</a></li><li><a href="global.html#assessGuidanceFailureRisk">assessGuidanceFailureRisk</a></li><li><a href="global.html#assessRisks">assessRisks</a></li><li><a href="global.html#autoInitializeMobile">autoInitializeMobile</a></li><li><a href="global.html#autoInitializeVersion">autoInitializeVersion</a></li><li><a href="global.html#automatedGuidanceAssessment">automatedGuidanceAssessment</a></li><li><a href="global.html#batchAutomatedAssessment">batchAutomatedAssessment</a></li><li><a href="global.html#batchEvaluateGuidance">batchEvaluateGuidance</a></li><li><a href="global.html#calculateNextReviewDate">calculateNextReviewDate</a></li><li><a href="global.html#calculateOverallScore">calculateOverallScore</a></li><li><a href="global.html#calculatePassRate">calculatePassRate</a></li><li><a href="global.html#calculateRiskLevel">calculateRiskLevel</a></li><li><a href="global.html#calculateTestCoverage">calculateTestCoverage</a></li><li><a href="global.html#calculateTestCoveragePercentage">calculateTestCoveragePercentage</a></li><li><a href="global.html#categoriseByScore">categoriseByScore</a></li><li><a href="global.html#checkDisclaimerAcceptance">checkDisclaimerAcceptance</a></li><li><a href="global.html#chunkText">chunkText</a></li><li><a href="global.html#clearHighlightInEditor">clearHighlightInEditor</a></li><li><a href="global.html#clearJobQueue">clearJobQueue</a></li><li><a href="global.html#closeMobileSettingsOverlay">closeMobileSettingsOverlay</a></li><li><a href="global.html#countFailedTests">countFailedTests</a></li><li><a href="global.html#countPassedTests">countPassedTests</a></li><li><a href="global.html#createVariationPrompt">createVariationPrompt</a></li><li><a href="global.html#crossValidateClinicalGuidancePoints">crossValidateClinicalGuidancePoints</a></li><li><a href="global.html#deleteDocuments">deleteDocuments</a></li><li><a href="global.html#deleteGuidelineChunks">deleteGuidelineChunks</a></li><li><a href="global.html#detectMobile">detectMobile</a></li><li><a href="global.html#determineFailureProbability">determineFailureProbability</a></li><li><a href="global.html#determineFailureSeverity">determineFailureSeverity</a></li><li><a href="global.html#determinePriority">determinePriority</a></li><li><a href="global.html#determineSeverity">determineSeverity</a></li><li><a href="global.html#determineTestStatus">determineTestStatus</a></li><li><a href="global.html#ensureAnonymisedForOutbound">ensureAnonymisedForOutbound</a></li><li><a href="global.html#evaluateAccuracy">evaluateAccuracy</a></li><li><a href="global.html#evaluateCompleteness">evaluateCompleteness</a></li><li><a href="global.html#evaluateContextualAppropriateness">evaluateContextualAppropriateness</a></li><li><a href="global.html#evaluateGuidance">evaluateGuidance</a></li><li><a href="global.html#evaluatePrecision">evaluatePrecision</a></li><li><a href="global.html#extractClinicalGuidancePoints">extractClinicalGuidancePoints</a></li><li><a href="global.html#extractElementCount">extractElementCount</a></li><li><a href="global.html#extractIssues">extractIssues</a></li><li><a href="global.html#extractMetadata">extractMetadata</a></li><li><a href="global.html#extractOrganisationFromTitle">extractOrganisationFromTitle</a></li><li><a href="global.html#extractRelevanceScore">extractRelevanceScore</a></li><li><a href="global.html#fetchContent">fetchContent</a></li><li><a href="global.html#formatExecutionRecords">formatExecutionRecords</a></li><li><a href="global.html#formatRelevanceScore">formatRelevanceScore</a></li><li><a href="global.html#formatTestResults">formatTestResults</a></li><li><a href="global.html#fs">fs</a></li><li><a href="global.html#generateAuditScenarios">generateAuditScenarios</a></li><li><a href="global.html#generateBaseScenario">generateBaseScenario</a></li><li><a href="global.html#generateChunkId">generateChunkId</a></li><li><a href="global.html#generateDetailedFindings">generateDetailedFindings</a></li><li><a href="global.html#generateEdgeCaseVariations">generateEdgeCaseVariations</a></li><li><a href="global.html#generateElementCoverage">generateElementCoverage</a></li><li><a href="global.html#generateISOCompliantReport">generateISOCompliantReport</a></li><li><a href="global.html#generateMitigationStrategies">generateMitigationStrategies</a></li><li><a href="global.html#generateRecommendations">generateRecommendations</a></li><li><a href="global.html#generateReportId">generateReportId</a></li><li><a href="global.html#generateScenarioVariations">generateScenarioVariations</a></li><li><a href="global.html#generateScenariosForElements">generateScenariosForElements</a></li><li><a href="global.html#generateSimpleDisplayName">generateSimpleDisplayName</a></li><li><a href="global.html#generateTraceabilityMatrix">generateTraceabilityMatrix</a></li><li><a href="global.html#generateTraceabilityReport">generateTraceabilityReport</a></li><li><a href="global.html#generateTrustAcronym">generateTrustAcronym</a></li><li><a href="global.html#generateVariationTranscript">generateVariationTranscript</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getAllPrompts">getAllPrompts</a></li><li><a href="global.html#getAuditInteractions">getAuditInteractions</a></li><li><a href="global.html#getAuditInteractionsForTest">getAuditInteractionsForTest</a></li><li><a href="global.html#getAuditResultsForTest">getAuditResultsForTest</a></li><li><a href="global.html#getAuditStatistics">getAuditStatistics</a></li><li><a href="global.html#getAuditTest">getAuditTest</a></li><li><a href="global.html#getAuditTests">getAuditTests</a></li><li><a href="global.html#getElementMapping">getElementMapping</a></li><li><a href="global.html#getGuidanceForThreshold">getGuidanceForThreshold</a></li><li><a href="global.html#getIdToken">getIdToken</a></li><li><a href="global.html#getIndexStats">getIndexStats</a></li><li><a href="global.html#getIngestionStatus">getIngestionStatus</a></li><li><a href="global.html#getInteractionStatistics">getInteractionStatistics</a></li><li><a href="global.html#getMaximumValue">getMaximumValue</a></li><li><a href="global.html#getMinimumValue">getMinimumValue</a></li><li><a href="global.html#getNextLLMProvider">getNextLLMProvider</a></li><li><a href="global.html#getPromptText">getPromptText</a></li><li><a href="global.html#getRelevanceCategory">getRelevanceCategory</a></li><li><a href="global.html#getShortHospitalTrust">getShortHospitalTrust</a></li><li><a href="global.html#getTraceabilityChain">getTraceabilityChain</a></li><li><a href="global.html#getTraceabilityMatrix">getTraceabilityMatrix</a></li><li><a href="global.html#getValueAboveThreshold">getValueAboveThreshold</a></li><li><a href="global.html#getValueBelowThreshold">getValueBelowThreshold</a></li><li><a href="global.html#hideSelectionButtons">hideSelectionButtons</a></li><li><a href="global.html#highlightTextInEditor">highlightTextInEditor</a></li><li><a href="global.html#ingestFromFirestore">ingestFromFirestore</a></li><li><a href="global.html#initializeConnectivityMonitoring">initializeConnectivityMonitoring</a></li><li><a href="global.html#initializeMarked">initializeMarked</a></li><li><a href="global.html#initializeMobileDetection">initializeMobileDetection</a></li><li><a href="global.html#initializeMobileSettingsOverlay">initializeMobileSettingsOverlay</a></li><li><a href="global.html#initializePinecone">initializePinecone</a></li><li><a href="global.html#initializeSuggestionWizard">initializeSuggestionWizard</a></li><li><a href="global.html#injectParameterModification">injectParameterModification</a></li><li><a href="global.html#isOnline">isOnline</a></li><li><a href="global.html#isVectorDBAvailable">isVectorDBAvailable</a></li><li><a href="global.html#linkAuditResult">linkAuditResult</a></li><li><a href="global.html#loadHospitalTrustMappings">loadHospitalTrustMappings</a></li><li><a href="global.html#loadVersionNumber">loadVersionNumber</a></li><li><a href="global.html#logAIInteraction">logAIInteraction</a></li><li><a href="global.html#logAuditInteraction">logAuditInteraction</a></li><li><a href="global.html#logStatusChange">logStatusChange</a></li><li><a href="global.html#mapElementsToGuideline">mapElementsToGuideline</a></li><li><a href="global.html#modifyScenarioParameter">modifyScenarioParameter</a></li><li><a href="global.html#openMobileSettingsOverlay">openMobileSettingsOverlay</a></li><li><a href="global.html#parseCitationsToLinks">parseCitationsToLinks</a></li><li><a href="global.html#parseJSONSafely">parseJSONSafely</a></li><li><a href="global.html#parseThresholdValue">parseThresholdValue</a></li><li><a href="global.html#postAuthenticated">postAuthenticated</a></li><li><a href="global.html#processAllGuidelines">processAllGuidelines</a></li><li><a href="global.html#processBatchGeneration">processBatchGeneration</a></li><li><a href="global.html#processFirestoreGuideline">processFirestoreGuideline</a></li><li><a href="global.html#processGuidelineFile">processGuidelineFile</a></li><li><a href="global.html#processJob">processJob</a></li><li><a href="global.html#processJobQueue">processJobQueue</a></li><li><a href="global.html#queryDocuments">queryDocuments</a></li><li><a href="global.html#queueJob">queueJob</a></li><li><a href="global.html#registerJobHandler">registerJobHandler</a></li><li><a href="global.html#reingestGuideline">reingestGuideline</a></li><li><a href="global.html#removeScenarioParameter">removeScenarioParameter</a></li><li><a href="global.html#repairGuidelineContent">repairGuidelineContent</a></li><li><a href="global.html#repairJSON">repairJSON</a></li><li><a href="global.html#scrollTextIntoView">scrollTextIntoView</a></li><li><a href="global.html#setButtonLoading">setButtonLoading</a></li><li><a href="global.html#showMainContent">showMainContent</a></li><li><a href="global.html#showPIIReviewInterface">showPIIReviewInterface</a></li><li><a href="global.html#showSelectionButtons">showSelectionButtons</a></li><li><a href="global.html#storeAuditInteraction">storeAuditInteraction</a></li><li><a href="global.html#storeAuditResult">storeAuditResult</a></li><li><a href="global.html#storeAuditTest">storeAuditTest</a></li><li><a href="global.html#storeAuditTrace">storeAuditTrace</a></li><li><a href="global.html#storeElementMapping">storeElementMapping</a></li><li><a href="global.html#storeTraceabilityMatrix">storeTraceabilityMatrix</a></li><li><a href="global.html#switchMobileView">switchMobileView</a></li><li><a href="global.html#syncGuidelinesInBatches">syncGuidelinesInBatches</a></li><li><a href="global.html#trackRiskResolution">trackRiskResolution</a></li><li><a href="global.html#updateAnalyseAndResetButtons">updateAnalyseAndResetButtons</a></li><li><a href="global.html#updateAuditTestStatus">updateAuditTestStatus</a></li><li><a href="global.html#updateClearFormattingButton">updateClearFormattingButton</a></li><li><a href="global.html#updatePromptsCache">updatePromptsCache</a></li><li><a href="global.html#updateUser">updateUser</a></li><li><a href="global.html#upsertDocuments">upsertDocuments</a></li><li><a href="global.html#validateScenario">validateScenario</a></li><li><a href="global.html#validateTraceability">validateTraceability</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
