<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: modules/traceability-matrix.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: modules/traceability-matrix.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// Traceability matrix system for ISO 13485 compliance
// Maps guidelines → elements → scenarios → interactions → results

import { getTraceabilityChain } from './audit-storage.js';

/**
 * Generates complete traceability matrix for a guideline
 * @param {string} guidelineId - Guideline ID
 * @returns {Promise&lt;Object>} - Complete traceability matrix
 */
export async function generateTraceabilityMatrix(guidelineId) {
    console.log(`[TRACEABILITY] Generating traceability matrix for guideline: ${guidelineId}`);

    // Get traceability chain
    const chain = await getTraceabilityChain(guidelineId);

    // Build matrix structure
    const matrix = {
        guidelineId,
        generatedAt: new Date().toISOString(),
        
        // Level 1: Guideline → Elements
        elements: chain.elements.map(element => ({
            elementId: element.elementId,
            elementName: element.name || element.elementId,
            traceability: {
                guidelineId,
                elementId: element.elementId
            }
        })),
        
        // Level 2: Elements → Test Scenarios
        testScenarios: [],
        
        // Level 3: Scenarios → Interactions
        interactions: [],
        
        // Level 4: Interactions → Results
        results: [],
        
        // Summary
        summary: {
            totalElements: chain.elements.length,
            totalTests: chain.tests.length,
            totalScenarios: chain.scenarios.length,
            totalInteractions: chain.interactions.length,
            totalResults: chain.results.length,
            traceabilityComplete: chain.traceabilityComplete
        }
    };

    // Build test scenarios mapping
    for (const test of chain.tests) {
        if (test.scenarios) {
            for (const scenario of test.scenarios) {
                matrix.testScenarios.push({
                    scenarioId: scenario.variationId || scenario.id,
                    elementId: test.elementId,
                    testId: test.id,
                    scenarioType: scenario.type,
                    traceability: {
                        guidelineId,
                        elementId: test.elementId,
                        testId: test.id,
                        scenarioId: scenario.variationId
                    }
                });
            }
        }
    }

    // Build interactions mapping
    for (const interaction of chain.interactions) {
        const scenario = chain.scenarios.find(s => s.id === interaction.scenarioId || s.variationId === interaction.scenarioId);
        const test = chain.tests.find(t => t.id === interaction.testId);
        
        matrix.interactions.push({
            interactionId: interaction.interactionId || interaction.id,
            testId: interaction.testId,
            scenarioId: scenario?.variationId || interaction.scenarioId,
            elementId: test?.elementId || interaction.elementId,
            timestamp: interaction.timestamp,
            traceability: {
                guidelineId,
                elementId: test?.elementId,
                testId: interaction.testId,
                scenarioId: scenario?.variationId,
                interactionId: interaction.interactionId || interaction.id
            }
        });
    }

    // Build results mapping
    for (const result of chain.results) {
        const interaction = chain.interactions.find(i => i.id === result.interactionId || i.interactionId === result.interactionId);
        const test = chain.tests.find(t => t.id === result.testId);
        
        matrix.results.push({
            resultId: result.resultId || result.id,
            testId: result.testId,
            interactionId: result.interactionId,
            elementId: test?.elementId || result.elementId,
            overallScore: result.overallScore,
            traceability: {
                guidelineId,
                elementId: test?.elementId,
                testId: result.testId,
                interactionId: result.interactionId,
                resultId: result.resultId || result.id
            }
        });
    }

    // Store matrix in Firestore
    await storeTraceabilityMatrix(matrix);

    return matrix;
}

/**
 * Stores traceability matrix in Firestore
 */
async function storeTraceabilityMatrix(matrix) {
    const admin = await import('firebase-admin');
    const db = admin.firestore();

    await db.collection('traceabilityMatrix').doc(matrix.guidelineId).set({
        ...matrix,
        updatedAt: admin.firestore.FieldValue.serverTimestamp()
    });

    console.log(`[TRACEABILITY] Stored traceability matrix for guideline: ${matrix.guidelineId}`);
}

/**
 * Retrieves traceability matrix for a guideline
 */
export async function getTraceabilityMatrix(guidelineId) {
    const admin = await import('firebase-admin');
    const db = admin.firestore();

    const doc = await db.collection('traceabilityMatrix').doc(guidelineId).get();
    
    if (!doc.exists) {
        // Generate if doesn't exist
        return await generateTraceabilityMatrix(guidelineId);
    }

    return { id: doc.id, ...doc.data() };
}

/**
 * Validates traceability completeness
 */
export async function validateTraceability(guidelineId) {
    const matrix = await getTraceabilityMatrix(guidelineId);
    
    const validation = {
        isValid: true,
        issues: [],
        completeness: {
            elements: 0,
            tests: 0,
            scenarios: 0,
            interactions: 0,
            results: 0
        }
    };

    // Check each level
    if (matrix.elements.length === 0) {
        validation.isValid = false;
        validation.issues.push('No auditable elements found');
    }

    if (matrix.testScenarios.length === 0) {
        validation.isValid = false;
        validation.issues.push('No test scenarios found');
    }

    // Check if each element has tests
    for (const element of matrix.elements) {
        const elementTests = matrix.testScenarios.filter(ts => ts.elementId === element.elementId);
        if (elementTests.length === 0) {
            validation.isValid = false;
            validation.issues.push(`Element ${element.elementId} has no test scenarios`);
        }
    }

    // Check if each scenario has interactions
    for (const scenario of matrix.testScenarios) {
        const scenarioInteractions = matrix.interactions.filter(i => i.scenarioId === scenario.scenarioId);
        if (scenarioInteractions.length === 0) {
            validation.isValid = false;
            validation.issues.push(`Scenario ${scenario.scenarioId} has no interactions`);
        }
    }

    // Check if each interaction has results
    for (const interaction of matrix.interactions) {
        const interactionResults = matrix.results.filter(r => r.interactionId === interaction.interactionId);
        if (interactionResults.length === 0) {
            validation.isValid = false;
            validation.issues.push(`Interaction ${interaction.interactionId} has no results`);
        }
    }

    // Calculate completeness percentages
    validation.completeness = {
        elements: matrix.summary.totalElements > 0 ? 100 : 0,
        tests: matrix.summary.totalTests > 0 ? 100 : 0,
        scenarios: matrix.summary.totalScenarios > 0 ? 100 : 0,
        interactions: matrix.summary.totalInteractions > 0 ? 100 : 0,
        results: matrix.summary.totalResults > 0 ? 100 : 0
    };

    return validation;
}

/**
 * Generates traceability report for ISO 13485 compliance
 */
export async function generateTraceabilityReport(guidelineId) {
    const matrix = await getTraceabilityMatrix(guidelineId);
    const validation = await validateTraceability(guidelineId);

    return {
        guidelineId,
        reportDate: new Date().toISOString(),
        matrix,
        validation,
        complianceStatus: validation.isValid ? 'COMPLIANT' : 'NON-COMPLIANT',
        recommendations: validation.isValid ? [] : [
            'Complete traceability chain is required for ISO 13485 compliance',
            ...validation.issues.map(issue => `Fix: ${issue}`)
        ]
    };
}

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-server_services_ai.html">server/services/ai</a></li><li><a href="module-server_services_pdf.html">server/services/pdf</a></li></ul><h3>Classes</h3><ul><li><a href="ClinicalDataAnonymiser.html">ClinicalDataAnonymiser</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Logger">Logger</a></li><li><a href="global.html#admin">admin</a></li><li><a href="global.html#analyzeNoteAgainstGuideline">analyzeNoteAgainstGuideline</a></li><li><a href="global.html#applyColoredReplacements">applyColoredReplacements</a></li><li><a href="global.html#applyMobileLayout">applyMobileLayout</a></li><li><a href="global.html#arbitrateCGPDisagreements">arbitrateCGPDisagreements</a></li><li><a href="global.html#assessClinicalImpact">assessClinicalImpact</a></li><li><a href="global.html#assessGuidanceFailureRisk">assessGuidanceFailureRisk</a></li><li><a href="global.html#assessRisks">assessRisks</a></li><li><a href="global.html#autoInitializeMobile">autoInitializeMobile</a></li><li><a href="global.html#autoInitializeVersion">autoInitializeVersion</a></li><li><a href="global.html#automatedGuidanceAssessment">automatedGuidanceAssessment</a></li><li><a href="global.html#batchAutomatedAssessment">batchAutomatedAssessment</a></li><li><a href="global.html#batchEvaluateGuidance">batchEvaluateGuidance</a></li><li><a href="global.html#calculateNextReviewDate">calculateNextReviewDate</a></li><li><a href="global.html#calculateOverallScore">calculateOverallScore</a></li><li><a href="global.html#calculatePassRate">calculatePassRate</a></li><li><a href="global.html#calculateRiskLevel">calculateRiskLevel</a></li><li><a href="global.html#calculateTestCoverage">calculateTestCoverage</a></li><li><a href="global.html#calculateTestCoveragePercentage">calculateTestCoveragePercentage</a></li><li><a href="global.html#categoriseByScore">categoriseByScore</a></li><li><a href="global.html#checkDisclaimerAcceptance">checkDisclaimerAcceptance</a></li><li><a href="global.html#chunkText">chunkText</a></li><li><a href="global.html#clearHighlightInEditor">clearHighlightInEditor</a></li><li><a href="global.html#clearJobQueue">clearJobQueue</a></li><li><a href="global.html#closeMobileSettingsOverlay">closeMobileSettingsOverlay</a></li><li><a href="global.html#countFailedTests">countFailedTests</a></li><li><a href="global.html#countPassedTests">countPassedTests</a></li><li><a href="global.html#createVariationPrompt">createVariationPrompt</a></li><li><a href="global.html#crossValidateClinicalGuidancePoints">crossValidateClinicalGuidancePoints</a></li><li><a href="global.html#deleteDocuments">deleteDocuments</a></li><li><a href="global.html#deleteGuidelineChunks">deleteGuidelineChunks</a></li><li><a href="global.html#detectMobile">detectMobile</a></li><li><a href="global.html#determineFailureProbability">determineFailureProbability</a></li><li><a href="global.html#determineFailureSeverity">determineFailureSeverity</a></li><li><a href="global.html#determinePriority">determinePriority</a></li><li><a href="global.html#determineSeverity">determineSeverity</a></li><li><a href="global.html#determineTestStatus">determineTestStatus</a></li><li><a href="global.html#ensureAnonymisedForOutbound">ensureAnonymisedForOutbound</a></li><li><a href="global.html#evaluateAccuracy">evaluateAccuracy</a></li><li><a href="global.html#evaluateCompleteness">evaluateCompleteness</a></li><li><a href="global.html#evaluateContextualAppropriateness">evaluateContextualAppropriateness</a></li><li><a href="global.html#evaluateGuidance">evaluateGuidance</a></li><li><a href="global.html#evaluatePrecision">evaluatePrecision</a></li><li><a href="global.html#extractClinicalGuidancePoints">extractClinicalGuidancePoints</a></li><li><a href="global.html#extractElementCount">extractElementCount</a></li><li><a href="global.html#extractIssues">extractIssues</a></li><li><a href="global.html#extractMetadata">extractMetadata</a></li><li><a href="global.html#extractOrganisationFromTitle">extractOrganisationFromTitle</a></li><li><a href="global.html#extractRelevanceScore">extractRelevanceScore</a></li><li><a href="global.html#fetchContent">fetchContent</a></li><li><a href="global.html#formatExecutionRecords">formatExecutionRecords</a></li><li><a href="global.html#formatRelevanceScore">formatRelevanceScore</a></li><li><a href="global.html#formatTestResults">formatTestResults</a></li><li><a href="global.html#fs">fs</a></li><li><a href="global.html#generateAuditScenarios">generateAuditScenarios</a></li><li><a href="global.html#generateBaseScenario">generateBaseScenario</a></li><li><a href="global.html#generateChunkId">generateChunkId</a></li><li><a href="global.html#generateDetailedFindings">generateDetailedFindings</a></li><li><a href="global.html#generateEdgeCaseVariations">generateEdgeCaseVariations</a></li><li><a href="global.html#generateElementCoverage">generateElementCoverage</a></li><li><a href="global.html#generateISOCompliantReport">generateISOCompliantReport</a></li><li><a href="global.html#generateMitigationStrategies">generateMitigationStrategies</a></li><li><a href="global.html#generateRecommendations">generateRecommendations</a></li><li><a href="global.html#generateReportId">generateReportId</a></li><li><a href="global.html#generateScenarioVariations">generateScenarioVariations</a></li><li><a href="global.html#generateScenariosForElements">generateScenariosForElements</a></li><li><a href="global.html#generateSimpleDisplayName">generateSimpleDisplayName</a></li><li><a href="global.html#generateTraceabilityMatrix">generateTraceabilityMatrix</a></li><li><a href="global.html#generateTraceabilityReport">generateTraceabilityReport</a></li><li><a href="global.html#generateTrustAcronym">generateTrustAcronym</a></li><li><a href="global.html#generateVariationTranscript">generateVariationTranscript</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getAllPrompts">getAllPrompts</a></li><li><a href="global.html#getAuditInteractions">getAuditInteractions</a></li><li><a href="global.html#getAuditInteractionsForTest">getAuditInteractionsForTest</a></li><li><a href="global.html#getAuditResultsForTest">getAuditResultsForTest</a></li><li><a href="global.html#getAuditStatistics">getAuditStatistics</a></li><li><a href="global.html#getAuditTest">getAuditTest</a></li><li><a href="global.html#getAuditTests">getAuditTests</a></li><li><a href="global.html#getElementMapping">getElementMapping</a></li><li><a href="global.html#getGuidanceForThreshold">getGuidanceForThreshold</a></li><li><a href="global.html#getIdToken">getIdToken</a></li><li><a href="global.html#getIndexStats">getIndexStats</a></li><li><a href="global.html#getIngestionStatus">getIngestionStatus</a></li><li><a href="global.html#getInteractionStatistics">getInteractionStatistics</a></li><li><a href="global.html#getMaximumValue">getMaximumValue</a></li><li><a href="global.html#getMinimumValue">getMinimumValue</a></li><li><a href="global.html#getNextLLMProvider">getNextLLMProvider</a></li><li><a href="global.html#getPromptText">getPromptText</a></li><li><a href="global.html#getRelevanceCategory">getRelevanceCategory</a></li><li><a href="global.html#getShortHospitalTrust">getShortHospitalTrust</a></li><li><a href="global.html#getTraceabilityChain">getTraceabilityChain</a></li><li><a href="global.html#getTraceabilityMatrix">getTraceabilityMatrix</a></li><li><a href="global.html#getValueAboveThreshold">getValueAboveThreshold</a></li><li><a href="global.html#getValueBelowThreshold">getValueBelowThreshold</a></li><li><a href="global.html#hideSelectionButtons">hideSelectionButtons</a></li><li><a href="global.html#highlightTextInEditor">highlightTextInEditor</a></li><li><a href="global.html#ingestFromFirestore">ingestFromFirestore</a></li><li><a href="global.html#initializeConnectivityMonitoring">initializeConnectivityMonitoring</a></li><li><a href="global.html#initializeMarked">initializeMarked</a></li><li><a href="global.html#initializeMobileDetection">initializeMobileDetection</a></li><li><a href="global.html#initializeMobileSettingsOverlay">initializeMobileSettingsOverlay</a></li><li><a href="global.html#initializePinecone">initializePinecone</a></li><li><a href="global.html#initializeSuggestionWizard">initializeSuggestionWizard</a></li><li><a href="global.html#injectParameterModification">injectParameterModification</a></li><li><a href="global.html#isOnline">isOnline</a></li><li><a href="global.html#isVectorDBAvailable">isVectorDBAvailable</a></li><li><a href="global.html#linkAuditResult">linkAuditResult</a></li><li><a href="global.html#loadHospitalTrustMappings">loadHospitalTrustMappings</a></li><li><a href="global.html#loadVersionNumber">loadVersionNumber</a></li><li><a href="global.html#logAIInteraction">logAIInteraction</a></li><li><a href="global.html#logAuditInteraction">logAuditInteraction</a></li><li><a href="global.html#logStatusChange">logStatusChange</a></li><li><a href="global.html#mapElementsToGuideline">mapElementsToGuideline</a></li><li><a href="global.html#modifyScenarioParameter">modifyScenarioParameter</a></li><li><a href="global.html#openMobileSettingsOverlay">openMobileSettingsOverlay</a></li><li><a href="global.html#parseCitationsToLinks">parseCitationsToLinks</a></li><li><a href="global.html#parseJSONSafely">parseJSONSafely</a></li><li><a href="global.html#parseThresholdValue">parseThresholdValue</a></li><li><a href="global.html#postAuthenticated">postAuthenticated</a></li><li><a href="global.html#processAllGuidelines">processAllGuidelines</a></li><li><a href="global.html#processBatchGeneration">processBatchGeneration</a></li><li><a href="global.html#processFirestoreGuideline">processFirestoreGuideline</a></li><li><a href="global.html#processGuidelineFile">processGuidelineFile</a></li><li><a href="global.html#processJob">processJob</a></li><li><a href="global.html#processJobQueue">processJobQueue</a></li><li><a href="global.html#queryDocuments">queryDocuments</a></li><li><a href="global.html#queueJob">queueJob</a></li><li><a href="global.html#registerJobHandler">registerJobHandler</a></li><li><a href="global.html#reingestGuideline">reingestGuideline</a></li><li><a href="global.html#removeScenarioParameter">removeScenarioParameter</a></li><li><a href="global.html#repairGuidelineContent">repairGuidelineContent</a></li><li><a href="global.html#repairJSON">repairJSON</a></li><li><a href="global.html#scrollTextIntoView">scrollTextIntoView</a></li><li><a href="global.html#setButtonLoading">setButtonLoading</a></li><li><a href="global.html#showMainContent">showMainContent</a></li><li><a href="global.html#showPIIReviewInterface">showPIIReviewInterface</a></li><li><a href="global.html#showSelectionButtons">showSelectionButtons</a></li><li><a href="global.html#storeAuditInteraction">storeAuditInteraction</a></li><li><a href="global.html#storeAuditResult">storeAuditResult</a></li><li><a href="global.html#storeAuditTest">storeAuditTest</a></li><li><a href="global.html#storeAuditTrace">storeAuditTrace</a></li><li><a href="global.html#storeElementMapping">storeElementMapping</a></li><li><a href="global.html#storeTraceabilityMatrix">storeTraceabilityMatrix</a></li><li><a href="global.html#switchMobileView">switchMobileView</a></li><li><a href="global.html#syncGuidelinesInBatches">syncGuidelinesInBatches</a></li><li><a href="global.html#trackRiskResolution">trackRiskResolution</a></li><li><a href="global.html#updateAnalyseAndResetButtons">updateAnalyseAndResetButtons</a></li><li><a href="global.html#updateAuditTestStatus">updateAuditTestStatus</a></li><li><a href="global.html#updateClearFormattingButton">updateClearFormattingButton</a></li><li><a href="global.html#updatePromptsCache">updatePromptsCache</a></li><li><a href="global.html#updateUser">updateUser</a></li><li><a href="global.html#upsertDocuments">upsertDocuments</a></li><li><a href="global.html#validateScenario">validateScenario</a></li><li><a href="global.html#validateTraceability">validateTraceability</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
