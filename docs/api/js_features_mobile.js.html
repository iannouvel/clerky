<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: js/features/mobile.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: js/features/mobile.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Mobile Detection &amp; Layout Management
 * Handles responsive layout changes for mobile devices
 */

// ===== Module State =====
let mobileSettingsInitialized = false;
let mobileSettingsOverlayOpen = false;
let userPreferencesOriginalParent = null;
let userPreferencesOriginalNextSibling = null;

// Initialize global mobile state on window
if (typeof window !== 'undefined') {
    window.isMobile = false;
    window.mobileView = 'userInput'; // 'userInput' or 'summary1'
}

// ===== Settings Overlay Functions =====

/**
 * Opens the mobile settings overlay panel
 */
export function openMobileSettingsOverlay() {
    if (!window.isMobile) return;

    const overlay = document.getElementById('mobileSettingsOverlay');
    const bodyContainer = document.getElementById('mobileSettingsBody');
    const panel = document.getElementById('userPreferencesPanel');

    if (!overlay || !bodyContainer || !panel) {
        console.warn('[MOBILE] Mobile settings elements not found');
        return;
    }

    // Remember original placement on first open
    if (!userPreferencesOriginalParent) {
        userPreferencesOriginalParent = panel.parentElement;
        userPreferencesOriginalNextSibling = panel.nextSibling;
    }

    // Move preferences panel into the overlay body
    if (panel.parentElement !== bodyContainer) {
        bodyContainer.appendChild(panel);
    }

    overlay.classList.remove('hidden');
    document.body.classList.add('mobile-settings-open');
    mobileSettingsOverlayOpen = true;
}

/**
 * Closes the mobile settings overlay panel
 */
export function closeMobileSettingsOverlay() {
    const overlay = document.getElementById('mobileSettingsOverlay');
    const panel = document.getElementById('userPreferencesPanel');

    if (overlay) {
        overlay.classList.add('hidden');
    }

    // Move the panel back to its original location so desktop layout is unchanged
    if (panel &amp;&amp; userPreferencesOriginalParent) {
        if (userPreferencesOriginalNextSibling &amp;&amp; userPreferencesOriginalNextSibling.parentElement === userPreferencesOriginalParent) {
            userPreferencesOriginalParent.insertBefore(panel, userPreferencesOriginalNextSibling);
        } else {
            userPreferencesOriginalParent.appendChild(panel);
        }
    }

    document.body.classList.remove('mobile-settings-open');
    mobileSettingsOverlayOpen = false;
}

/**
 * Initializes the mobile settings overlay event listeners
 */
export function initializeMobileSettingsOverlay() {
    if (mobileSettingsInitialized) return;

    const toggleBtn = document.getElementById('mobileSettingsToggleBtn');
    const overlay = document.getElementById('mobileSettingsOverlay');
    const closeBtn = document.getElementById('mobileSettingsCloseBtn');

    if (!toggleBtn || !overlay) {
        // Elements may not be ready yet
        return;
    }

    toggleBtn.addEventListener('click', () => {
        if (mobileSettingsOverlayOpen) {
            closeMobileSettingsOverlay();
        } else {
            openMobileSettingsOverlay();
        }
    });

    if (closeBtn) {
        closeBtn.addEventListener('click', () => {
            closeMobileSettingsOverlay();
        });
    }

    // Close when clicking outside the dialog
    overlay.addEventListener('click', (event) => {
        if (event.target === overlay) {
            closeMobileSettingsOverlay();
        }
    });

    // Close on Escape key
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' &amp;&amp; mobileSettingsOverlayOpen) {
            closeMobileSettingsOverlay();
        }
    });

    mobileSettingsInitialized = true;
}

// ===== Mobile Detection Functions =====

/**
 * Detect if device is mobile based on viewport width and user agent
 * @returns {boolean} Whether the device is in mobile mode
 */
export function detectMobile() {
    const viewportWidth = window.innerWidth || document.documentElement.clientWidth;
    const isMobileWidth = viewportWidth &lt;= 768;

    // User agent detection for additional mobile device detection
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;
    const isMobileUA = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent.toLowerCase());

    const wasMobile = window.isMobile;
    window.isMobile = isMobileWidth || (isMobileUA &amp;&amp; viewportWidth &lt;= 1024);

    // If mobile state changed, update layout
    if (wasMobile !== window.isMobile) {
        applyMobileLayout();
    }

    return window.isMobile;
}

/**
 * Apply mobile layout changes to the DOM
 */
export function applyMobileLayout() {
    const body = document.body;
    const mainContent = document.getElementById('mainContent');
    const chatbotLayout = document.getElementById('chatbotLayout');
    const mobileToggleContainer = document.getElementById('mobileViewToggle');
    const mobileSettingsToggleBtn = document.getElementById('mobileSettingsToggleBtn');

    // If mainContent doesn't exist yet, try again after a short delay
    if (!mainContent) {
        // Retry after a short delay if elements aren't ready
        setTimeout(() => {
            if (document.getElementById('mainContent')) {
                applyMobileLayout();
            }
        }, 100);
        return;
    }

    if (window.isMobile) {
        body.classList.add('mobile-mode');
        mainContent.classList.add('mobile-mode');
        initializeMobileSettingsOverlay();

        // Hide mobile toggle buttons (not needed with chatbot layout)
        if (mobileToggleContainer) {
            mobileToggleContainer.classList.add('hidden');
        }

        if (mobileSettingsToggleBtn) {
            mobileSettingsToggleBtn.classList.remove('hidden');
        }
    } else {
        // Ensure any open mobile settings overlay is closed when leaving mobile mode
        if (mobileSettingsOverlayOpen) {
            closeMobileSettingsOverlay();
        }

        body.classList.remove('mobile-mode');
        mainContent.classList.remove('mobile-mode');

        // Hide mobile toggle buttons
        if (mobileToggleContainer) {
            mobileToggleContainer.classList.add('hidden');
        }

        if (mobileSettingsToggleBtn) {
            mobileSettingsToggleBtn.classList.add('hidden');
        }
    }
}

/**
 * Switch between userInput and summary1 views on mobile
 * @param {string} view - Either 'userInput' or 'summary1'
 */
export function switchMobileView(view) {
    if (!window.isMobile) return;

    const userInputCol = document.querySelector('.user-input-col');
    const summaryCol = document.querySelector('.summary-col');
    const userInputBtn = document.getElementById('mobileViewUserInputBtn');
    const summaryBtn = document.getElementById('mobileViewSummaryBtn');

    window.mobileView = view;
    sessionStorage.setItem('mobileView', view);

    if (view === 'userInput') {
        if (userInputCol) {
            userInputCol.style.display = 'flex';
            // Ensure TipTap editor is properly visible when switching to userInput
            const editorElement = userInputCol.querySelector('.tiptap-editor');
            if (editorElement &amp;&amp; window.editors &amp;&amp; window.editors.userInput) {
                // Small delay to ensure DOM update completes
                setTimeout(() => {
                    try {
                        window.editors.userInput.commands.focus();
                    } catch (e) {
                        // Editor might not be ready, ignore
                    }
                }, 100);
            }
        }
        if (summaryCol) summaryCol.style.display = 'none';
        if (userInputBtn) userInputBtn.classList.add('active');
        if (summaryBtn) summaryBtn.classList.remove('active');
    } else {
        if (userInputCol) userInputCol.style.display = 'none';
        if (summaryCol) {
            summaryCol.style.display = 'flex';
            // Scroll to top of summary when switching to it
            const summaryPane = summaryCol.querySelector('#summary1');
            if (summaryPane) {
                setTimeout(() => {
                    summaryPane.scrollTop = 0;
                }, 50);
            }
        }
        if (userInputBtn) userInputBtn.classList.remove('active');
        if (summaryBtn) summaryBtn.classList.add('active');
    }
}

/**
 * Initialize mobile detection on page load and resize
 */
export function initializeMobileDetection() {
    detectMobile();

    // Listen for window resize
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            detectMobile();
        }, 150);
    });

    // Set up mobile view toggle buttons
    const userInputBtn = document.getElementById('mobileViewUserInputBtn');
    const summaryBtn = document.getElementById('mobileViewSummaryBtn');

    if (userInputBtn) {
        userInputBtn.addEventListener('click', () => switchMobileView('userInput'));
    }

    if (summaryBtn) {
        summaryBtn.addEventListener('click', () => switchMobileView('summary1'));
    }
}

/**
 * Auto-initialize mobile detection when DOM is ready
 */
export function autoInitializeMobile() {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeMobileDetection);
    } else {
        initializeMobileDetection();
    }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-server_services_ai.html">server/services/ai</a></li><li><a href="module-server_services_pdf.html">server/services/pdf</a></li></ul><h3>Classes</h3><ul><li><a href="ClinicalDataAnonymiser.html">ClinicalDataAnonymiser</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Logger">Logger</a></li><li><a href="global.html#admin">admin</a></li><li><a href="global.html#analyzeNoteAgainstGuideline">analyzeNoteAgainstGuideline</a></li><li><a href="global.html#applyColoredReplacements">applyColoredReplacements</a></li><li><a href="global.html#applyMobileLayout">applyMobileLayout</a></li><li><a href="global.html#arbitrateCGPDisagreements">arbitrateCGPDisagreements</a></li><li><a href="global.html#assessClinicalImpact">assessClinicalImpact</a></li><li><a href="global.html#assessGuidanceFailureRisk">assessGuidanceFailureRisk</a></li><li><a href="global.html#assessRisks">assessRisks</a></li><li><a href="global.html#autoInitializeMobile">autoInitializeMobile</a></li><li><a href="global.html#autoInitializeVersion">autoInitializeVersion</a></li><li><a href="global.html#automatedGuidanceAssessment">automatedGuidanceAssessment</a></li><li><a href="global.html#batchAutomatedAssessment">batchAutomatedAssessment</a></li><li><a href="global.html#batchEvaluateGuidance">batchEvaluateGuidance</a></li><li><a href="global.html#calculateNextReviewDate">calculateNextReviewDate</a></li><li><a href="global.html#calculateOverallScore">calculateOverallScore</a></li><li><a href="global.html#calculatePassRate">calculatePassRate</a></li><li><a href="global.html#calculateRiskLevel">calculateRiskLevel</a></li><li><a href="global.html#calculateTestCoverage">calculateTestCoverage</a></li><li><a href="global.html#calculateTestCoveragePercentage">calculateTestCoveragePercentage</a></li><li><a href="global.html#categoriseByScore">categoriseByScore</a></li><li><a href="global.html#checkDisclaimerAcceptance">checkDisclaimerAcceptance</a></li><li><a href="global.html#chunkText">chunkText</a></li><li><a href="global.html#clearHighlightInEditor">clearHighlightInEditor</a></li><li><a href="global.html#clearJobQueue">clearJobQueue</a></li><li><a href="global.html#closeMobileSettingsOverlay">closeMobileSettingsOverlay</a></li><li><a href="global.html#countFailedTests">countFailedTests</a></li><li><a href="global.html#countPassedTests">countPassedTests</a></li><li><a href="global.html#createVariationPrompt">createVariationPrompt</a></li><li><a href="global.html#crossValidateClinicalGuidancePoints">crossValidateClinicalGuidancePoints</a></li><li><a href="global.html#deleteDocuments">deleteDocuments</a></li><li><a href="global.html#deleteGuidelineChunks">deleteGuidelineChunks</a></li><li><a href="global.html#detectMobile">detectMobile</a></li><li><a href="global.html#determineFailureProbability">determineFailureProbability</a></li><li><a href="global.html#determineFailureSeverity">determineFailureSeverity</a></li><li><a href="global.html#determinePriority">determinePriority</a></li><li><a href="global.html#determineSeverity">determineSeverity</a></li><li><a href="global.html#determineTestStatus">determineTestStatus</a></li><li><a href="global.html#ensureAnonymisedForOutbound">ensureAnonymisedForOutbound</a></li><li><a href="global.html#evaluateAccuracy">evaluateAccuracy</a></li><li><a href="global.html#evaluateCompleteness">evaluateCompleteness</a></li><li><a href="global.html#evaluateContextualAppropriateness">evaluateContextualAppropriateness</a></li><li><a href="global.html#evaluateGuidance">evaluateGuidance</a></li><li><a href="global.html#evaluatePrecision">evaluatePrecision</a></li><li><a href="global.html#extractClinicalGuidancePoints">extractClinicalGuidancePoints</a></li><li><a href="global.html#extractElementCount">extractElementCount</a></li><li><a href="global.html#extractIssues">extractIssues</a></li><li><a href="global.html#extractMetadata">extractMetadata</a></li><li><a href="global.html#extractOrganisationFromTitle">extractOrganisationFromTitle</a></li><li><a href="global.html#extractRelevanceScore">extractRelevanceScore</a></li><li><a href="global.html#fetchContent">fetchContent</a></li><li><a href="global.html#formatExecutionRecords">formatExecutionRecords</a></li><li><a href="global.html#formatRelevanceScore">formatRelevanceScore</a></li><li><a href="global.html#formatTestResults">formatTestResults</a></li><li><a href="global.html#fs">fs</a></li><li><a href="global.html#generateAuditScenarios">generateAuditScenarios</a></li><li><a href="global.html#generateBaseScenario">generateBaseScenario</a></li><li><a href="global.html#generateChunkId">generateChunkId</a></li><li><a href="global.html#generateDetailedFindings">generateDetailedFindings</a></li><li><a href="global.html#generateEdgeCaseVariations">generateEdgeCaseVariations</a></li><li><a href="global.html#generateElementCoverage">generateElementCoverage</a></li><li><a href="global.html#generateISOCompliantReport">generateISOCompliantReport</a></li><li><a href="global.html#generateMitigationStrategies">generateMitigationStrategies</a></li><li><a href="global.html#generateRecommendations">generateRecommendations</a></li><li><a href="global.html#generateReportId">generateReportId</a></li><li><a href="global.html#generateScenarioVariations">generateScenarioVariations</a></li><li><a href="global.html#generateScenariosForElements">generateScenariosForElements</a></li><li><a href="global.html#generateSimpleDisplayName">generateSimpleDisplayName</a></li><li><a href="global.html#generateTraceabilityMatrix">generateTraceabilityMatrix</a></li><li><a href="global.html#generateTraceabilityReport">generateTraceabilityReport</a></li><li><a href="global.html#generateTrustAcronym">generateTrustAcronym</a></li><li><a href="global.html#generateVariationTranscript">generateVariationTranscript</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getAllPrompts">getAllPrompts</a></li><li><a href="global.html#getAuditInteractions">getAuditInteractions</a></li><li><a href="global.html#getAuditInteractionsForTest">getAuditInteractionsForTest</a></li><li><a href="global.html#getAuditResultsForTest">getAuditResultsForTest</a></li><li><a href="global.html#getAuditStatistics">getAuditStatistics</a></li><li><a href="global.html#getAuditTest">getAuditTest</a></li><li><a href="global.html#getAuditTests">getAuditTests</a></li><li><a href="global.html#getElementMapping">getElementMapping</a></li><li><a href="global.html#getGuidanceForThreshold">getGuidanceForThreshold</a></li><li><a href="global.html#getIdToken">getIdToken</a></li><li><a href="global.html#getIndexStats">getIndexStats</a></li><li><a href="global.html#getIngestionStatus">getIngestionStatus</a></li><li><a href="global.html#getInteractionStatistics">getInteractionStatistics</a></li><li><a href="global.html#getMaximumValue">getMaximumValue</a></li><li><a href="global.html#getMinimumValue">getMinimumValue</a></li><li><a href="global.html#getNextLLMProvider">getNextLLMProvider</a></li><li><a href="global.html#getPromptText">getPromptText</a></li><li><a href="global.html#getRelevanceCategory">getRelevanceCategory</a></li><li><a href="global.html#getShortHospitalTrust">getShortHospitalTrust</a></li><li><a href="global.html#getTraceabilityChain">getTraceabilityChain</a></li><li><a href="global.html#getTraceabilityMatrix">getTraceabilityMatrix</a></li><li><a href="global.html#getValueAboveThreshold">getValueAboveThreshold</a></li><li><a href="global.html#getValueBelowThreshold">getValueBelowThreshold</a></li><li><a href="global.html#hideSelectionButtons">hideSelectionButtons</a></li><li><a href="global.html#highlightTextInEditor">highlightTextInEditor</a></li><li><a href="global.html#ingestFromFirestore">ingestFromFirestore</a></li><li><a href="global.html#initializeConnectivityMonitoring">initializeConnectivityMonitoring</a></li><li><a href="global.html#initializeMarked">initializeMarked</a></li><li><a href="global.html#initializeMobileDetection">initializeMobileDetection</a></li><li><a href="global.html#initializeMobileSettingsOverlay">initializeMobileSettingsOverlay</a></li><li><a href="global.html#initializePinecone">initializePinecone</a></li><li><a href="global.html#initializeSuggestionWizard">initializeSuggestionWizard</a></li><li><a href="global.html#injectParameterModification">injectParameterModification</a></li><li><a href="global.html#isOnline">isOnline</a></li><li><a href="global.html#isVectorDBAvailable">isVectorDBAvailable</a></li><li><a href="global.html#linkAuditResult">linkAuditResult</a></li><li><a href="global.html#loadHospitalTrustMappings">loadHospitalTrustMappings</a></li><li><a href="global.html#loadVersionNumber">loadVersionNumber</a></li><li><a href="global.html#logAIInteraction">logAIInteraction</a></li><li><a href="global.html#logAuditInteraction">logAuditInteraction</a></li><li><a href="global.html#logStatusChange">logStatusChange</a></li><li><a href="global.html#mapElementsToGuideline">mapElementsToGuideline</a></li><li><a href="global.html#modifyScenarioParameter">modifyScenarioParameter</a></li><li><a href="global.html#openMobileSettingsOverlay">openMobileSettingsOverlay</a></li><li><a href="global.html#parseCitationsToLinks">parseCitationsToLinks</a></li><li><a href="global.html#parseJSONSafely">parseJSONSafely</a></li><li><a href="global.html#parseThresholdValue">parseThresholdValue</a></li><li><a href="global.html#postAuthenticated">postAuthenticated</a></li><li><a href="global.html#processAllGuidelines">processAllGuidelines</a></li><li><a href="global.html#processBatchGeneration">processBatchGeneration</a></li><li><a href="global.html#processFirestoreGuideline">processFirestoreGuideline</a></li><li><a href="global.html#processGuidelineFile">processGuidelineFile</a></li><li><a href="global.html#processJob">processJob</a></li><li><a href="global.html#processJobQueue">processJobQueue</a></li><li><a href="global.html#queryDocuments">queryDocuments</a></li><li><a href="global.html#queueJob">queueJob</a></li><li><a href="global.html#registerJobHandler">registerJobHandler</a></li><li><a href="global.html#reingestGuideline">reingestGuideline</a></li><li><a href="global.html#removeScenarioParameter">removeScenarioParameter</a></li><li><a href="global.html#repairGuidelineContent">repairGuidelineContent</a></li><li><a href="global.html#repairJSON">repairJSON</a></li><li><a href="global.html#scrollTextIntoView">scrollTextIntoView</a></li><li><a href="global.html#setButtonLoading">setButtonLoading</a></li><li><a href="global.html#showMainContent">showMainContent</a></li><li><a href="global.html#showPIIReviewInterface">showPIIReviewInterface</a></li><li><a href="global.html#showSelectionButtons">showSelectionButtons</a></li><li><a href="global.html#storeAuditInteraction">storeAuditInteraction</a></li><li><a href="global.html#storeAuditResult">storeAuditResult</a></li><li><a href="global.html#storeAuditTest">storeAuditTest</a></li><li><a href="global.html#storeAuditTrace">storeAuditTrace</a></li><li><a href="global.html#storeElementMapping">storeElementMapping</a></li><li><a href="global.html#storeTraceabilityMatrix">storeTraceabilityMatrix</a></li><li><a href="global.html#switchMobileView">switchMobileView</a></li><li><a href="global.html#syncGuidelinesInBatches">syncGuidelinesInBatches</a></li><li><a href="global.html#trackRiskResolution">trackRiskResolution</a></li><li><a href="global.html#updateAnalyseAndResetButtons">updateAnalyseAndResetButtons</a></li><li><a href="global.html#updateAuditTestStatus">updateAuditTestStatus</a></li><li><a href="global.html#updateClearFormattingButton">updateClearFormattingButton</a></li><li><a href="global.html#updatePromptsCache">updatePromptsCache</a></li><li><a href="global.html#updateUser">updateUser</a></li><li><a href="global.html#upsertDocuments">upsertDocuments</a></li><li><a href="global.html#validateScenario">validateScenario</a></li><li><a href="global.html#validateTraceability">validateTraceability</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
