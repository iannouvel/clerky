<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: modules/audit-reporting.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: modules/audit-reporting.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// ISO 13485-compliant audit report generation system
// Generates test plans, execution records, and approval workflows

/**
 * Generates ISO 13485-compliant audit report
 * @param {Object} reportData - Report data
 * @returns {Promise&lt;Object>} - Generated report
 */
export async function generateISOCompliantReport(reportData) {
    const {
        guidelineId,
        guidelineTitle,
        testId,
        tests,
        results,
        statistics
    } = reportData;

    const report = {
        reportId: generateReportId(),
        reportDate: new Date().toISOString(),
        version: '1.0',
        
        // ISO 13485 Compliance Header
        isoCompliance: {
            standard: 'ISO 13485:2016',
            section: '7.3 Design and Development - Verification and Validation',
            purpose: 'Clinical Guidance System Verification and Validation Report'
        },
        
        // Document Control
        documentControl: {
            documentType: 'Verification and Validation Report',
            documentStatus: 'Draft',
            revision: '1.0',
            effectiveDate: new Date().toISOString(),
            approvedBy: null,
            approvedDate: null
        },
        
        // Test Plan
        testPlan: {
            objective: 'Systematic evaluation of clinical guidance provision for guideline compliance',
            scope: {
                guidelineId,
                guidelineTitle,
                testCoverage: calculateTestCoverage(tests),
                elementsTested: extractElementCount(tests)
            },
            testStrategy: {
                approach: 'Systematic scenario variation testing',
                testTypes: [
                    'Baseline scenario validation',
                    'Threshold variation testing',
                    'Variable omission testing',
                    'Edge case validation'
                ]
            },
            acceptanceCriteria: {
                minimumAccuracyScore: 75,
                minimumCompletenessScore: 70,
                minimumContextualScore: 70,
                minimumPrecisionScore: 65,
                overallMinimumScore: 75
            }
        },
        
        // Test Execution Records
        testExecution: {
            executionDate: new Date().toISOString(),
            executedBy: reportData.generatedBy || 'System',
            testEnvironment: 'Production-like environment',
            testResults: formatTestResults(tests, results),
            totalTestsExecuted: tests.length,
            passed: countPassedTests(results),
            failed: countFailedTests(results),
            passRate: calculatePassRate(results)
        },
        
        // Results Analysis
        resultsAnalysis: {
            summary: statistics || {},
            detailedFindings: generateDetailedFindings(results),
            issuesIdentified: extractIssues(results),
            recommendations: generateRecommendations(results),
            riskAssessment: assessRisks(results)
        },
        
        // Traceability
        traceability: {
            guidelineId,
            testIds: tests.map(t => t.testId || t.id),
            elementCoverage: generateElementCoverage(tests),
            testCoverage: calculateTestCoveragePercentage(tests, results)
        },
        
        // Quality Records
        qualityRecords: {
            testPlans: tests.map(t => ({
                testId: t.testId || t.id,
                testDate: t.generatedAt || t.createdAt,
                testPlan: 'Systematic scenario variation testing'
            })),
            executionRecords: formatExecutionRecords(tests, results),
            reviewRecords: []
        },
        
        // Approval Workflow
        approvalWorkflow: {
            status: 'Draft',
            reviews: [],
            approvals: [],
            nextReviewDate: calculateNextReviewDate()
        }
    };
    
    return report;
}

/**
 * Formats test results for ISO report
 */
function formatTestResults(tests, results) {
    const formatted = [];
    
    for (const test of tests) {
        const testResults = results.filter(r => r.testId === (test.testId || test.id));
        
        for (const result of testResults) {
            formatted.push({
                testId: test.testId || test.id,
                elementId: result.elementId,
                scenarioId: result.scenarioId,
                evaluation: result.evaluation,
                status: determineTestStatus(result.evaluation),
                timestamp: result.timestamp
            });
        }
    }
    
    return formatted;
}

/**
 * Determines test status from evaluation
 */
function determineTestStatus(evaluation) {
    if (!evaluation || !evaluation.overallScore) {
        return 'UNKNOWN';
    }
    
    const score = evaluation.overallScore;
    if (score >= 90) return 'EXCELLENT';
    if (score >= 75) return 'PASS';
    if (score >= 60) return 'NEEDS_IMPROVEMENT';
    return 'FAIL';
}

/**
 * Counts passed tests
 */
function countPassedTests(results) {
    return results.filter(r => {
        const status = determineTestStatus(r.evaluation);
        return status === 'PASS' || status === 'EXCELLENT';
    }).length;
}

/**
 * Counts failed tests
 */
function countFailedTests(results) {
    return results.filter(r => {
        const status = determineTestStatus(r.evaluation);
        return status === 'FAIL';
    }).length;
}

/**
 * Calculates pass rate
 */
function calculatePassRate(results) {
    if (results.length === 0) return 0;
    const passed = countPassedTests(results);
    return Math.round((passed / results.length) * 100);
}

/**
 * Generates detailed findings
 */
function generateDetailedFindings(results) {
    const findings = {
        strengths: [],
        weaknesses: [],
        criticalIssues: []
    };
    
    for (const result of results) {
        if (result.evaluation) {
            if (result.evaluation.strengths) {
                findings.strengths.push(...result.evaluation.strengths);
            }
            if (result.evaluation.issues) {
                const criticalIssues = result.evaluation.issues.filter(i => 
                    i.toLowerCase().includes('critical') || 
                    i.toLowerCase().includes('safety') ||
                    i.toLowerCase().includes('serious')
                );
                findings.criticalIssues.push(...criticalIssues);
                findings.weaknesses.push(...result.evaluation.issues.filter(i => !criticalIssues.includes(i)));
            }
        }
    }
    
    return findings;
}

/**
 * Extracts issues from results
 */
function extractIssues(results) {
    const issues = [];
    
    for (const result of results) {
        if (result.evaluation &amp;&amp; result.evaluation.issues) {
            issues.push({
                elementId: result.elementId,
                scenarioId: result.scenarioId,
                issues: result.evaluation.issues,
                severity: determineSeverity(result.evaluation)
            });
        }
    }
    
    return issues;
}

/**
 * Determines issue severity
 */
function determineSeverity(evaluation) {
    if (!evaluation || !evaluation.overallScore) {
        return 'UNKNOWN';
    }
    
    const score = evaluation.overallScore;
    if (score &lt; 60) return 'HIGH';
    if (score &lt; 75) return 'MEDIUM';
    return 'LOW';
}

/**
 * Generates recommendations
 */
function generateRecommendations(results) {
    const recommendations = [];
    
    // Analyze common issues
    const issueFrequency = {};
    for (const result of results) {
        if (result.evaluation &amp;&amp; result.evaluation.recommendations) {
            for (const rec of result.evaluation.recommendations) {
                issueFrequency[rec] = (issueFrequency[rec] || 0) + 1;
            }
        }
    }
    
    // Sort by frequency
    const sortedRecs = Object.entries(issueFrequency)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([rec, count]) => ({
            recommendation: rec,
            frequency: count,
            priority: count > results.length * 0.5 ? 'HIGH' : 'MEDIUM'
        }));
    
    return sortedRecs;
}

/**
 * Assesses risks from results
 */
function assessRisks(results) {
    const risks = {
        high: [],
        medium: [],
        low: []
    };
    
    for (const result of results) {
        if (result.evaluation) {
            const severity = determineSeverity(result.evaluation);
            const risk = {
                elementId: result.elementId,
                scenarioId: result.scenarioId,
                score: result.evaluation.overallScore,
                issues: result.evaluation.issues || [],
                impact: 'Clinical guidance accuracy and patient safety'
            };
            
            if (severity === 'HIGH') {
                risks.high.push(risk);
            } else if (severity === 'MEDIUM') {
                risks.medium.push(risk);
            } else {
                risks.low.push(risk);
            }
        }
    }
    
    return risks;
}

/**
 * Calculates test coverage
 */
function calculateTestCoverage(tests) {
    const elements = new Set();
    const scenarios = new Set();
    
    for (const test of tests) {
        if (test.scenarios) {
            for (const scenarioGroup of test.scenarios) {
                if (scenarioGroup.elementId) {
                    elements.add(scenarioGroup.elementId);
                }
                if (scenarioGroup.variations) {
                    scenarioGroup.variations.forEach(v => scenarios.add(v.type));
                }
            }
        }
    }
    
    return {
        elementsCovered: elements.size,
        scenarioTypesCovered: scenarios.size
    };
}

/**
 * Extracts element count
 */
function extractElementCount(tests) {
    const elements = new Set();
    
    for (const test of tests) {
        if (test.scenarios) {
            for (const scenarioGroup of test.scenarios) {
                if (scenarioGroup.elementId) {
                    elements.add(scenarioGroup.elementId);
                }
            }
        }
    }
    
    return Array.from(elements);
}

/**
 * Generates element coverage
 */
function generateElementCoverage(tests) {
    const coverage = {};
    
    for (const test of tests) {
        if (test.scenarios) {
            for (const scenarioGroup of test.scenarios) {
                const elementId = scenarioGroup.elementId;
                if (elementId) {
                    if (!coverage[elementId]) {
                        coverage[elementId] = {
                            elementId,
                            elementName: scenarioGroup.elementName,
                            scenariosTested: 0,
                            variationsTested: 0
                        };
                    }
                    coverage[elementId].scenariosTested++;
                    coverage[elementId].variationsTested += scenarioGroup.totalVariations || 0;
                }
            }
        }
    }
    
    return Object.values(coverage);
}

/**
 * Calculates test coverage percentage
 */
function calculateTestCoveragePercentage(tests, results) {
    const totalElements = extractElementCount(tests).length;
    const testedElements = new Set(results.map(r => r.elementId));
    
    if (totalElements === 0) return 0;
    return Math.round((testedElements.size / totalElements) * 100);
}

/**
 * Formats execution records
 */
function formatExecutionRecords(tests, results) {
    return tests.map(test => {
        const testResults = results.filter(r => r.testId === (test.testId || test.id));
        return {
            testId: test.testId || test.id,
            executionDate: test.generatedAt || test.createdAt,
            executedBy: test.generatedBy || 'System',
            testCases: testResults.length,
            passed: countPassedTests(testResults),
            failed: countFailedTests(testResults)
        };
    });
}

/**
 * Generates report ID
 */
function generateReportId() {
    return `AUDIT-${Date.now()}-${Math.random().toString(36).substr(2, 9).toUpperCase()}`;
}

/**
 * Calculates next review date (30 days from now)
 */
function calculateNextReviewDate() {
    const date = new Date();
    date.setDate(date.getDate() + 30);
    return date.toISOString();
}

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-server_services_ai.html">server/services/ai</a></li><li><a href="module-server_services_pdf.html">server/services/pdf</a></li></ul><h3>Classes</h3><ul><li><a href="ClinicalDataAnonymiser.html">ClinicalDataAnonymiser</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Logger">Logger</a></li><li><a href="global.html#admin">admin</a></li><li><a href="global.html#analyzeNoteAgainstGuideline">analyzeNoteAgainstGuideline</a></li><li><a href="global.html#applyColoredReplacements">applyColoredReplacements</a></li><li><a href="global.html#applyMobileLayout">applyMobileLayout</a></li><li><a href="global.html#arbitrateCGPDisagreements">arbitrateCGPDisagreements</a></li><li><a href="global.html#assessClinicalImpact">assessClinicalImpact</a></li><li><a href="global.html#assessGuidanceFailureRisk">assessGuidanceFailureRisk</a></li><li><a href="global.html#assessRisks">assessRisks</a></li><li><a href="global.html#autoInitializeMobile">autoInitializeMobile</a></li><li><a href="global.html#autoInitializeVersion">autoInitializeVersion</a></li><li><a href="global.html#automatedGuidanceAssessment">automatedGuidanceAssessment</a></li><li><a href="global.html#batchAutomatedAssessment">batchAutomatedAssessment</a></li><li><a href="global.html#batchEvaluateGuidance">batchEvaluateGuidance</a></li><li><a href="global.html#calculateNextReviewDate">calculateNextReviewDate</a></li><li><a href="global.html#calculateOverallScore">calculateOverallScore</a></li><li><a href="global.html#calculatePassRate">calculatePassRate</a></li><li><a href="global.html#calculateRiskLevel">calculateRiskLevel</a></li><li><a href="global.html#calculateTestCoverage">calculateTestCoverage</a></li><li><a href="global.html#calculateTestCoveragePercentage">calculateTestCoveragePercentage</a></li><li><a href="global.html#categoriseByScore">categoriseByScore</a></li><li><a href="global.html#checkDisclaimerAcceptance">checkDisclaimerAcceptance</a></li><li><a href="global.html#chunkText">chunkText</a></li><li><a href="global.html#clearHighlightInEditor">clearHighlightInEditor</a></li><li><a href="global.html#clearJobQueue">clearJobQueue</a></li><li><a href="global.html#closeMobileSettingsOverlay">closeMobileSettingsOverlay</a></li><li><a href="global.html#countFailedTests">countFailedTests</a></li><li><a href="global.html#countPassedTests">countPassedTests</a></li><li><a href="global.html#createVariationPrompt">createVariationPrompt</a></li><li><a href="global.html#crossValidateClinicalGuidancePoints">crossValidateClinicalGuidancePoints</a></li><li><a href="global.html#deleteDocuments">deleteDocuments</a></li><li><a href="global.html#deleteGuidelineChunks">deleteGuidelineChunks</a></li><li><a href="global.html#detectMobile">detectMobile</a></li><li><a href="global.html#determineFailureProbability">determineFailureProbability</a></li><li><a href="global.html#determineFailureSeverity">determineFailureSeverity</a></li><li><a href="global.html#determinePriority">determinePriority</a></li><li><a href="global.html#determineSeverity">determineSeverity</a></li><li><a href="global.html#determineTestStatus">determineTestStatus</a></li><li><a href="global.html#ensureAnonymisedForOutbound">ensureAnonymisedForOutbound</a></li><li><a href="global.html#evaluateAccuracy">evaluateAccuracy</a></li><li><a href="global.html#evaluateCompleteness">evaluateCompleteness</a></li><li><a href="global.html#evaluateContextualAppropriateness">evaluateContextualAppropriateness</a></li><li><a href="global.html#evaluateGuidance">evaluateGuidance</a></li><li><a href="global.html#evaluatePrecision">evaluatePrecision</a></li><li><a href="global.html#extractClinicalGuidancePoints">extractClinicalGuidancePoints</a></li><li><a href="global.html#extractElementCount">extractElementCount</a></li><li><a href="global.html#extractIssues">extractIssues</a></li><li><a href="global.html#extractMetadata">extractMetadata</a></li><li><a href="global.html#extractOrganisationFromTitle">extractOrganisationFromTitle</a></li><li><a href="global.html#extractRelevanceScore">extractRelevanceScore</a></li><li><a href="global.html#fetchContent">fetchContent</a></li><li><a href="global.html#formatExecutionRecords">formatExecutionRecords</a></li><li><a href="global.html#formatRelevanceScore">formatRelevanceScore</a></li><li><a href="global.html#formatTestResults">formatTestResults</a></li><li><a href="global.html#fs">fs</a></li><li><a href="global.html#generateAuditScenarios">generateAuditScenarios</a></li><li><a href="global.html#generateBaseScenario">generateBaseScenario</a></li><li><a href="global.html#generateChunkId">generateChunkId</a></li><li><a href="global.html#generateDetailedFindings">generateDetailedFindings</a></li><li><a href="global.html#generateEdgeCaseVariations">generateEdgeCaseVariations</a></li><li><a href="global.html#generateElementCoverage">generateElementCoverage</a></li><li><a href="global.html#generateISOCompliantReport">generateISOCompliantReport</a></li><li><a href="global.html#generateMitigationStrategies">generateMitigationStrategies</a></li><li><a href="global.html#generateRecommendations">generateRecommendations</a></li><li><a href="global.html#generateReportId">generateReportId</a></li><li><a href="global.html#generateScenarioVariations">generateScenarioVariations</a></li><li><a href="global.html#generateScenariosForElements">generateScenariosForElements</a></li><li><a href="global.html#generateSimpleDisplayName">generateSimpleDisplayName</a></li><li><a href="global.html#generateTraceabilityMatrix">generateTraceabilityMatrix</a></li><li><a href="global.html#generateTraceabilityReport">generateTraceabilityReport</a></li><li><a href="global.html#generateTrustAcronym">generateTrustAcronym</a></li><li><a href="global.html#generateVariationTranscript">generateVariationTranscript</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getAllPrompts">getAllPrompts</a></li><li><a href="global.html#getAuditInteractions">getAuditInteractions</a></li><li><a href="global.html#getAuditInteractionsForTest">getAuditInteractionsForTest</a></li><li><a href="global.html#getAuditResultsForTest">getAuditResultsForTest</a></li><li><a href="global.html#getAuditStatistics">getAuditStatistics</a></li><li><a href="global.html#getAuditTest">getAuditTest</a></li><li><a href="global.html#getAuditTests">getAuditTests</a></li><li><a href="global.html#getElementMapping">getElementMapping</a></li><li><a href="global.html#getGuidanceForThreshold">getGuidanceForThreshold</a></li><li><a href="global.html#getIdToken">getIdToken</a></li><li><a href="global.html#getIndexStats">getIndexStats</a></li><li><a href="global.html#getIngestionStatus">getIngestionStatus</a></li><li><a href="global.html#getInteractionStatistics">getInteractionStatistics</a></li><li><a href="global.html#getMaximumValue">getMaximumValue</a></li><li><a href="global.html#getMinimumValue">getMinimumValue</a></li><li><a href="global.html#getNextLLMProvider">getNextLLMProvider</a></li><li><a href="global.html#getPromptText">getPromptText</a></li><li><a href="global.html#getRelevanceCategory">getRelevanceCategory</a></li><li><a href="global.html#getShortHospitalTrust">getShortHospitalTrust</a></li><li><a href="global.html#getTraceabilityChain">getTraceabilityChain</a></li><li><a href="global.html#getTraceabilityMatrix">getTraceabilityMatrix</a></li><li><a href="global.html#getValueAboveThreshold">getValueAboveThreshold</a></li><li><a href="global.html#getValueBelowThreshold">getValueBelowThreshold</a></li><li><a href="global.html#hideSelectionButtons">hideSelectionButtons</a></li><li><a href="global.html#highlightTextInEditor">highlightTextInEditor</a></li><li><a href="global.html#ingestFromFirestore">ingestFromFirestore</a></li><li><a href="global.html#initializeConnectivityMonitoring">initializeConnectivityMonitoring</a></li><li><a href="global.html#initializeMarked">initializeMarked</a></li><li><a href="global.html#initializeMobileDetection">initializeMobileDetection</a></li><li><a href="global.html#initializeMobileSettingsOverlay">initializeMobileSettingsOverlay</a></li><li><a href="global.html#initializePinecone">initializePinecone</a></li><li><a href="global.html#initializeSuggestionWizard">initializeSuggestionWizard</a></li><li><a href="global.html#injectParameterModification">injectParameterModification</a></li><li><a href="global.html#isOnline">isOnline</a></li><li><a href="global.html#isVectorDBAvailable">isVectorDBAvailable</a></li><li><a href="global.html#linkAuditResult">linkAuditResult</a></li><li><a href="global.html#loadHospitalTrustMappings">loadHospitalTrustMappings</a></li><li><a href="global.html#loadVersionNumber">loadVersionNumber</a></li><li><a href="global.html#logAIInteraction">logAIInteraction</a></li><li><a href="global.html#logAuditInteraction">logAuditInteraction</a></li><li><a href="global.html#logStatusChange">logStatusChange</a></li><li><a href="global.html#mapElementsToGuideline">mapElementsToGuideline</a></li><li><a href="global.html#modifyScenarioParameter">modifyScenarioParameter</a></li><li><a href="global.html#openMobileSettingsOverlay">openMobileSettingsOverlay</a></li><li><a href="global.html#parseCitationsToLinks">parseCitationsToLinks</a></li><li><a href="global.html#parseJSONSafely">parseJSONSafely</a></li><li><a href="global.html#parseThresholdValue">parseThresholdValue</a></li><li><a href="global.html#postAuthenticated">postAuthenticated</a></li><li><a href="global.html#processAllGuidelines">processAllGuidelines</a></li><li><a href="global.html#processBatchGeneration">processBatchGeneration</a></li><li><a href="global.html#processFirestoreGuideline">processFirestoreGuideline</a></li><li><a href="global.html#processGuidelineFile">processGuidelineFile</a></li><li><a href="global.html#processJob">processJob</a></li><li><a href="global.html#processJobQueue">processJobQueue</a></li><li><a href="global.html#queryDocuments">queryDocuments</a></li><li><a href="global.html#queueJob">queueJob</a></li><li><a href="global.html#registerJobHandler">registerJobHandler</a></li><li><a href="global.html#reingestGuideline">reingestGuideline</a></li><li><a href="global.html#removeScenarioParameter">removeScenarioParameter</a></li><li><a href="global.html#repairGuidelineContent">repairGuidelineContent</a></li><li><a href="global.html#repairJSON">repairJSON</a></li><li><a href="global.html#scrollTextIntoView">scrollTextIntoView</a></li><li><a href="global.html#setButtonLoading">setButtonLoading</a></li><li><a href="global.html#showMainContent">showMainContent</a></li><li><a href="global.html#showPIIReviewInterface">showPIIReviewInterface</a></li><li><a href="global.html#showSelectionButtons">showSelectionButtons</a></li><li><a href="global.html#storeAuditInteraction">storeAuditInteraction</a></li><li><a href="global.html#storeAuditResult">storeAuditResult</a></li><li><a href="global.html#storeAuditTest">storeAuditTest</a></li><li><a href="global.html#storeAuditTrace">storeAuditTrace</a></li><li><a href="global.html#storeElementMapping">storeElementMapping</a></li><li><a href="global.html#storeTraceabilityMatrix">storeTraceabilityMatrix</a></li><li><a href="global.html#switchMobileView">switchMobileView</a></li><li><a href="global.html#syncGuidelinesInBatches">syncGuidelinesInBatches</a></li><li><a href="global.html#trackRiskResolution">trackRiskResolution</a></li><li><a href="global.html#updateAnalyseAndResetButtons">updateAnalyseAndResetButtons</a></li><li><a href="global.html#updateAuditTestStatus">updateAuditTestStatus</a></li><li><a href="global.html#updateClearFormattingButton">updateClearFormattingButton</a></li><li><a href="global.html#updatePromptsCache">updatePromptsCache</a></li><li><a href="global.html#updateUser">updateUser</a></li><li><a href="global.html#upsertDocuments">upsertDocuments</a></li><li><a href="global.html#validateScenario">validateScenario</a></li><li><a href="global.html#validateTraceability">validateTraceability</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
