<!DOCTYPE html>
<!-- Version: three-column-layout-v2 -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clerky - AI Clinical Assistant</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <!-- Cookie consent script -->
    <script src="cookie-consent.js" defer></script>
    <!-- Load marked library before other scripts -->
    <script>
        // Load marked library and ensure it's available globally
        window.marked = null;
        const markedScript = document.createElement('script');
        markedScript.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
        markedScript.onload = function() {
            window.marked = marked;
            console.log('Marked library loaded successfully');
        };
        document.head.appendChild(markedScript);
    </script>
    <!-- Firebase scripts -->
    <script type="module" src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.14.1/firebase-analytics.js"></script>
    
    <style>
        /* Add this to your existing styles */
        .top-bar-center {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* Make the clerky logo on landing page twice as big */
        .landing-page h1 {
            transform: scale(2);
            margin: 1em 0;
        }
        
        .nav-btn {
            margin: 0 5px;
        }

        /* Set minimum height for text areas */
        #summary {
            min-height: 300px;
        }

        #suggestedGuidelines {
            min-height: 200px;
        }

        /* Add styles for model toggle */
        .model-toggle {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            margin-left: 15px;
        }

        .model-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .model-toggle.active {
            background: rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Add spinner animation for model toggle */
        .model-toggle .spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
            margin-right: 5px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .model-toggle:disabled {
            opacity: 0.7;
            cursor: wait;
        }
        
        .version-number {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            margin-left: 15px;
            font-weight: 500;
        }
        
        .model-selector {
            display: flex;
            align-items: center;
        }
        
        .model-select {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.9rem;
            font-weight: 500;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 200px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .model-select:hover {
            background: rgba(255, 255, 255, 0.3);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .model-select:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
        }
        
        .model-select option {
            color: #333;
            background: white;
        }
        
        /* Critical three-column layout fixes */
        #threeColumnView {
            display: flex !important;
            width: 100% !important;
            gap: 16px !important;
        }
        
        #historyColumn {
            display: none !important;
        }
        
        #mainContentArea {
            flex: 1 !important;
            width: 100% !important;
        }
        
        #issuesColumn {
            display: none !important;
        }
        
        /* Responsive override for mobile */
        @media (max-width: 768px) {
            #threeColumnView {
                flex-direction: column !important;
            }
        }
        
        /* Green border for user input section matching button color */
        .user-input-section {
            border: 2px solid #00b894;
            border-radius: 8px;
            padding: 6px;
            margin: 4px 0;
            background-color: rgba(0, 184, 148, 0.05);
        }
        
        /* Summary section styling without border */
        #summary1 {
            border-radius: 8px;
            padding: 6px;
            margin: 4px 0;
        }
        
        /* Make textarea fill the entire user input section */
        .user-input-section textarea {
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            border: none;
            outline: none;
            resize: vertical;
            min-height: 80px;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading-screen">
        <div class="loading-container">
            <div class="loading-logo">
                <svg class="loading-icon" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                    <!-- Medical cross icon -->
                    <rect x="28" y="8" width="8" height="48" fill="currentColor"></rect>
                    <rect x="8" y="28" width="48" height="8" fill="currentColor"></rect>
                </svg>
                <h1 class="loading-title">clerky</h1>
            </div>
            <div class="loading-progress">
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                <p class="loading-text">Loading your clinical assistant...</p>
            </div>
        </div>
    </div>
    
    <!-- Landing Page -->
    <div id="landingPage" class="landing-page hidden">
        <h1>clerky</h1>      
        <button id="googleSignInBtn">Sign in with Google</button>
    </div>
    
    <!-- Main Application -->
    <div id="mainContent" class="hidden">
        <div class="top-bar">
            <div class="top-bar-left">
                <a href="index.html" class="logo-link">
                    <div class="logo">clerky</div>
                </a>
                <span class="version-number">v<span id="appVersion">loading...</span></span>
                <div class="model-selector">
                    <span class="model-selector-icon" title="AI Model">üß†</span>
                    <select id="modelSelect" class="model-select">
                        <option value="DeepSeek">DeepSeek (deepseek-chat)</option>
                        <option value="OpenAI">OpenAI (gpt-3.5-turbo)</option>
                        <option value="Anthropic">Claude (claude-3-sonnet)</option>
                        <option value="Mistral">Mistral (mistral-large)</option>
                        <option value="Gemini">Gemini (gemini-1.5-pro)</option>
                    </select>
                </div>
            </div>
            <div class="top-bar-center">
                <button id="generateClinicalNoteBtn" class="nav-btn secondary" title="Generate Note">
                    <span id="spinner" class="spinner" style="display: none;">&#x21BB;</span>
                    <span class="btn-icon">üìù</span>
                    <span class="btn-text" id="generateText">Generate Note</span>
                </button>
                <button id="testBtn" class="nav-btn secondary" title="Test">
                    <span id="testSpinner" class="spinner" style="display: none;">&#x21BB;</span>
                    <span class="btn-icon">‚úì</span>
                    <span class="btn-text" id="testText">Test</span>
                </button>
            </div>
            <div class="right-content">
                <div id="settingsContainer" class="settings-container">
                    <button id="settingsBtn" class="nav-btn settings-btn">
                        <svg width="28" height="28" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" stroke-width="3" stroke="white" fill="none">
                            <path d="M45,14.67l-2.76,2a1,1,0,0,1-1,.11L37.65,15.3a1,1,0,0,1-.61-.76l-.66-3.77a1,1,0,0,0-1-.84H30.52a1,1,0,0,0-1,.77l-.93,3.72a1,1,0,0,1-.53.65l-3.3,1.66a1,1,0,0,1-1-.08l-3-2.13a1,1,0,0,0-1.31.12l-3.65,3.74a1,1,0,0,0-.13,1.26l1.87,2.88a1,1,0,0,1,.1.89L16.34,27a1,1,0,0,1-.68.63l-3.85,1.06a1,1,0,0,0-.74,1v4.74a1,1,0,0,0,.8,1l3.9.8a1,1,0,0,1,.72.57l1.42,3.15a1,1,0,0,1-.05.92l-2.13,3.63a1,1,0,0,0,.17,1.24L19.32,49a1,1,0,0,0,1.29.09L23.49,47a1,1,0,0,1,1-.1l3.74,1.67a1,1,0,0,1,.59.75l.66,3.79a1,1,0,0,0,1,.84h4.89a1,1,0,0,0,1-.86l.58-4a1,1,0,0,1,.58-.77l3.58-1.62a1,1,0,0,1,1,.09l3.14,2.12a1,1,0,0,0,1.3-.15L50,45.06a1,1,0,0,0,.09-1.27l-2.08-3a1,1,0,0,1-.09-1l1.48-3.43a1,1,0,0,1,.71-.59L53.77,35a1,1,0,0,0,.8-1V29.42a1,1,0,0,0-.8-1l-3.72-.78a1,1,0,0,1-.73-.62l-1.45-3.65a1,1,0,0,1,.11-.94l2.15-3.14A1,1,0,0,0,50,18l-3.71-3.25A1,1,0,0,0,45,14.67Z"/>
                            <circle cx="32.82" cy="31.94" r="9.94"/>
                        </svg>
                    </button>
                    <div id="settingsMenu" class="settings-menu hidden">
                        <button id="preferencesBtn" class="menu-item">Preferences</button>
                        <button id="directFakeTranscriptBtn" class="menu-item">
                            <span id="directFakeTranscriptSpinner" class="spinner" style="display: none;">&#x21BB;</span>
                            <span id="directFakeTranscriptText">Generate Transcript</span>
                        </button>
                        <button id="promptsBtn" class="menu-item">Prompts</button>
                        <button id="guidelinesBtn" class="menu-item">Guidelines</button>
                        <button id="hospitalTrustBtn" class="menu-item">Hospital Trust</button>
                        <button id="actionBtn" class="menu-item">
                            <span id="actionSpinner" class="spinner" style="display: none;">&#x21BB;</span>
                            <span id="actionText">Process</span>
                        </button>
                        <button id="xCheckBtn" class="menu-item">
                            <span id="xCheckSpinner" class="spinner" style="display: none;">&#x21BB;</span>
                            <span id="xCheckText">Verify</span>
                        </button>
                        <button id="auditBtn" class="menu-item">Audit</button>
                        <button id="devBtn" class="menu-item">Dev</button>
                    </div>
                </div>
                <div class="far-right">
                    <div class="user-info">
                        <span id="userLabel">User:</span>
                        <span id="userName" class="user-name hidden">User Name</span>
                    </div>
                    <button id="signOutBtn" title="Sign Out">
                        <span class="signout-icon">üö™</span>
                        <span class="signout-text">Sign Out</span>
                    </button>
                </div>
            </div>
        </div>
        <div id="mainSection" class="container">
            <!-- Workflows View (initially hidden) -->
            <div id="workflowsView" class="hidden">
                <div class="workflows-container">
                    <h2>GitHub Workflows</h2>
                    <div class="workflow-buttons">
                        <button id="processPdfBtn" class="workflow-btn">
                            <span id="processPdfSpinner" class="spinner" style="display: none;">&#x21BB;</span>
                            <span>Process PDF</span>
                        </button>
                        <button id="extractTermsBtn" class="workflow-btn">
                            <span id="extractTermsSpinner" class="spinner" style="display: none;">&#x21BB;</span>
                            <span>Extract Terms</span>
                        </button>
                        <button id="generateSummaryBtn" class="workflow-btn">
                            <span id="generateSummarySpinner" class="spinner" style="display: none;">&#x21BB;</span>
                            <span>Generate Summary</span>
                        </button>
                    </div>
                    <div id="workflowStatus" class="workflow-status"></div>
                </div>
            </div>
            <!-- Three Column View - clean version -->
            <div id="threeColumnView">
                <div id="historyColumn" class="column">
                    <div class="column-header">
                        <span>Chat History</span>
                        <button id="newChatBtn" class="add-issue-btn" title="New Chat">+</button>
                    </div>
                    <div id="historyList" class="history-list">
                        <!-- Chat history items will be dynamically inserted here -->
                    </div>
                </div>
                <div id="mainContentArea">
                    <!-- Chatbot-style single column layout -->
                    <div id="chatbotLayout" class="chatbot-layout">
                        <!-- Clinical Note Input Section -->
                        <div class="chatbot-input-section">
                            <!-- Floating buttons in top right of input area -->
                            <div class="floating-input-buttons">
                                <button id="undoBtn" class="nav-btn icon-btn" title="Undo" disabled>‚Ü∂</button>
                                <button id="redoBtn" class="nav-btn icon-btn" title="Redo" disabled>‚Ü∑</button>
                                <button id="clearFormattingBtn" class="nav-btn icon-btn" title="Clear Highlighting" style="display: none;">‚úì</button>
                                <button id="recordBtn" class="nav-btn record-btn">
                                    <span id="recordSymbol" class="record-symbol"></span>Record
                                </button>
                            </div>
                            <div id="userInput" class="expandable-input tiptap-editor"></div>
                            
                            <!-- Action Buttons (shown when input has content) -->
                            <div id="chatbotActionButtons" class="chatbot-action-buttons hidden">
                                <button id="processBtn" class="nav-btn primary" title="Dynamic Advice">
                                    <span id="processSpinner" class="spinner" style="display: none;">&#x21BB;</span>
                                    <span class="btn-icon">‚ö°</span>
                                    <span class="btn-text">Dynamic Advice</span>
                                </button>
                                <button id="askGuidelinesQuestionBtn" class="nav-btn secondary" title="Ask Guidelines A Question">
                                    <span id="askQuestionSpinner" class="spinner" style="display: none;">&#x21BB;</span>
                                    <span class="btn-icon">‚ùì</span>
                                    <span class="btn-text">Ask Guidelines A Question</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Summary Section (shown only when it has content) -->
                        <div id="summarySection" class="chatbot-summary-section hidden">
                            <div id="summary1" class="transcript-pane active">
                                <div id="summaryLoadingSpinner" class="summary-loading-spinner hidden">
                                    <div class="spinner-circle"></div>
                                    <span class="loading-text">Processing...</span>
                                </div>
                                <!-- Content will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Proforma View (initially hidden) -->
            <div id="proformaView" class="hidden">
                <div class="left-column">
                    <div class="column-header">Transcript</div>
                    <textarea rows="20" id="proformaSummary"></textarea>
                </div>
                <div class="right-column">
                    <div class="column-header">
                        <div class="proforma-header">
                            <div class="proforma-toggle">
                                <button id="obsProformaBtn" class="proforma-toggle-btn active">Obstetric</button>
                                <button id="gynProformaBtn" class="proforma-toggle-btn">Gynaecology</button>
                            </div>
                            <button id="populateProformaBtn" class="populate-btn">
                                <span id="populateSpinner" class="spinner" style="display: none;">&#x21BB;</span>
                                <span id="populateText">Populate</span>
                            </button>
                        </div>
                    </div>
                    <div id="proformaContent">
                        <!-- Obstetric Proforma (default) -->
                        <div id="obsProforma" class="proforma-template">
                            <h3>Obstetric Assessment</h3>
                            <div class="proforma-section">
                                <h4>Demographics</h4>
                                <div class="form-row">
                                    <label for="obs-name">Name:</label>
                                    <input type="text" id="obs-name" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-age">Age:</label>
                                    <input type="text" id="obs-age" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-hospital-no">Hospital No:</label>
                                    <input type="text" id="obs-hospital-no" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-date">Date:</label>
                                    <input type="date" id="obs-date" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-time">Time:</label>
                                    <input type="time" id="obs-time" class="proforma-input">
                                </div>
                            </div>
                            <div class="proforma-section">
                                <h4>Obstetric History</h4>
                                <div class="form-row">
                                    <label for="obs-gravida">Gravida:</label>
                                    <input type="text" id="obs-gravida" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-para">Para:</label>
                                    <input type="text" id="obs-para" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-edd">EDD:</label>
                                    <input type="date" id="obs-edd" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-gestation">Gestation:</label>
                                    <input type="text" id="obs-gestation" class="proforma-input">
                                    <span>weeks</span>
                                </div>
                                <div class="form-row">
                                    <label for="obs-prev-deliveries">Previous Deliveries:</label>
                                    <textarea id="obs-prev-deliveries" class="proforma-input" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="proforma-section">
                                <h4>Current Pregnancy</h4>
                                <div class="form-row">
                                    <label for="obs-antenatal-care">Antenatal Care:</label>
                                    <select id="obs-antenatal-care" class="proforma-input">
                                        <option value="">Select...</option>
                                        <option value="regular">Regular</option>
                                        <option value="irregular">Irregular</option>
                                    </select>
                                </div>
                                <div class="form-row">
                                    <label for="obs-blood-group">Blood Group:</label>
                                    <input type="text" id="obs-blood-group" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-rhesus">Rhesus:</label>
                                    <input type="text" id="obs-rhesus" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-bmi">Booking BMI:</label>
                                    <input type="text" id="obs-bmi" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-complications">Complications:</label>
                                    <textarea id="obs-complications" class="proforma-input" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="proforma-section">
                                <h4>Current Assessment</h4>
                                <div class="form-row">
                                    <label for="obs-presenting-complaint">Presenting Complaint:</label>
                                    <textarea id="obs-presenting-complaint" class="proforma-input" rows="2"></textarea>
                                </div>
                                <div class="form-row">
                                    <label for="obs-contractions">Contractions:</label>
                                    <select id="obs-contractions" class="proforma-input">
                                        <option value="">Select...</option>
                                        <option value="true">Yes</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                                <div class="form-row">
                                    <label for="obs-fetal-movements">Fetal Movements:</label>
                                    <select id="obs-fetal-movements" class="proforma-input">
                                        <option value="">Select...</option>
                                        <option value="normal">Normal</option>
                                        <option value="reduced">Reduced</option>
                                    </select>
                                </div>
                                <div class="form-row">
                                    <label for="obs-vaginal-loss">Vaginal Loss:</label>
                                    <select id="obs-vaginal-loss" class="proforma-input">
                                        <option value="">Select...</option>
                                        <option value="none">None</option>
                                        <option value="show">Show</option>
                                        <option value="liquor">Liquor</option>
                                        <option value="blood">Blood</option>
                                    </select>
                                </div>
                            </div>
                            <div class="proforma-section">
                                <h4>Examination</h4>
                                <div class="form-row">
                                    <label for="obs-bp">BP:</label>
                                    <input type="text" id="obs-bp" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-pulse">Pulse:</label>
                                    <input type="text" id="obs-pulse" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-temp">Temp:</label>
                                    <input type="text" id="obs-temp" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-fundal-height">Fundal Height:</label>
                                    <input type="text" id="obs-fundal-height" class="proforma-input">
                                    <span>cm</span>
                                </div>
                                <div class="form-row">
                                    <label for="obs-lie">Lie:</label>
                                    <input type="text" id="obs-lie" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-presentation">Presentation:</label>
                                    <input type="text" id="obs-presentation" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="obs-fh">FH:</label>
                                    <input type="text" id="obs-fh" class="proforma-input">
                                    <span>bpm</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Gynaecology Proforma (initially hidden) -->
                        <div id="gynProforma" class="proforma-template hidden">
                            <h3>Gynaecology Assessment</h3>
                            <div class="proforma-section">
                                <h4>Demographics</h4>
                                <div class="form-row">
                                    <label for="gyn-name">Name:</label>
                                    <input type="text" id="gyn-name" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="gyn-age">Age:</label>
                                    <input type="text" id="gyn-age" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="gyn-hospital-no">Hospital No:</label>
                                    <input type="text" id="gyn-hospital-no" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="gyn-date">Date:</label>
                                    <input type="date" id="gyn-date" class="proforma-input">
                                </div>
                                <div class="form-row">
                                    <label for="gyn-time">Time:</label>
                                    <input type="time" id="gyn-time" class="proforma-input">
                                </div>
                            </div>
                            <div class="proforma-section">
                                <h4>Presenting Complaint</h4>
                                <textarea class="proforma-input" rows="2"></textarea>
                            </div>
                            <div class="proforma-section">
                                <h4>Gynaecological History</h4>
                                <p>LMP: ___/___/___</p>
                                <p>Menstrual Cycle: Regular ‚ñ° Irregular ‚ñ°</p>
                                <p>Contraception: ________________</p>
                                <p>Previous Gynae Surgery:</p>
                                <textarea class="proforma-input" rows="2"></textarea>
                            </div>
                            <div class="proforma-section">
                                <h4>Obstetric History</h4>
                                <p>Gravida: _____ Para: _____</p>
                                <textarea class="proforma-input" rows="2"></textarea>
                            </div>
                            <div class="proforma-section">
                                <h4>Examination</h4>
                                <p>BP: _____ Pulse: _____ Temp: _____</p>
                                <p>Abdominal Examination:</p>
                                <textarea class="proforma-input" rows="2"></textarea>
                                <p>Vaginal Examination:</p>
                                <textarea class="proforma-input" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="promptsSection" class="container hidden">
            <div id="promptsContainer" class="prompts-container">
                <div class="prompt-group">
                    <label for="promptIssues">Prompt for issues:</label>
                    <textarea id="promptIssues">
        Please determine the significant clinical issues within this clinical scenario, ie if the patient has had as BMI of 45, return: 'Morbid obesity: BMI 45'. 
        Do not list risks, this will be done by the user. 
        Please provide the issues as a list from most clinically important to least.
                    </textarea>
                </div>
                <div class="prompt-group">
                    <label for="promptGuidelines">Prompt for guidelines:</label>
                    <textarea id="promptGuidelines">
        Please provide filenames of the 3 most relevant guidelines for the following clinical text. 
        Please only list the filenames, without prior or trailing text.
        For each guideline, please format as: "filename: relevance" (using a colon as separator)
        The significant terms are listed line-by-line as filenames followed by their associated 
        significant terms:
                    </textarea>
                </div>
                <div class="prompt-group">
                    <label for="promptNoteGenerator">Prompt for note generator:</label>
                    <textarea id="promptNoteGenerator">
        The following is a transcript from a clinical consultation.
        Please write a concise clinical note using medical terminology 
        suitable for healthcare professionals. 
        Please write the note from the perspective of the clinician.
        Please use the following structure, without actually writing the headings: Situation, Issues and Plan.
        If the clinical context is a current pregnancy, please summarise the situation as follows:
        Age, Parity - Previous mode of delivery, Gestation, BMI, Rhesus Status, for example: "36yo, P2 - previous SVD followed by EMCS, 33+2 weeks, BMI 22, Rh+ve"
        Please summarise the issues as single line items with the associated discussion regarding the context, risks etc included.
        Please try to include all the information discussed, where necessary to demonstrate concision and avoid repetition.
        Thank you.
        Here follows the transcript:
                    </textarea>
                </div>
                <button id="savePromptsBtn">Save Prompts</button>
            </div>
        </div>
        <div id="guidelinesSection" class="container hidden">
            <div id="guidelinesContainer" class="guidelines-container">
                <h2>Guidelines</h2>
                <ul id="guidelinesList"></ul>
            </div>
        </div>
        <div id="devSection" class="container hidden">
            <div id="devContainer" class="dev-container">
                <h2>Development Tools</h2>
                <div class="dev-tools">
                    <div class="tool-group">
                        <h3>GitHub Permissions</h3>
                        <div id="githubPermissions"></div>
                    </div>
                    <div class="tool-group">
                        <h3>API Tests</h3>
                        <button id="testServerBtn" class="dev-btn">Test Server Connection</button>
                        <button id="testGitHubBtn" class="dev-btn">Test GitHub Access</button>
                        <button id="testOpenAIBtn" class="dev-btn">Test OpenAI Access</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="linksSection" class="container hidden">
            <div id="linksContainer" class="links-container">
                <h2>Links</h2>
                <ul id="linksList"></ul>
            </div>
        </div>
    </div>
    
    <!-- Hospital Trust Selection Modal -->
    <div id="hospitalTrustModal" class="hospital-trust-modal hidden">
        <div class="hospital-trust-modal-content">
            <div class="hospital-trust-modal-header">
                <h2>Select Your Hospital Trust</h2>
                <button id="closeHospitalTrustModal" class="close-modal-btn">&times;</button>
            </div>
            <div class="hospital-trust-modal-body">
                <p class="hospital-trust-info">Select your hospital trust to receive contextualised guidance relevant to your working environment.</p>
                <div class="current-trust-display">
                    <strong>Current selection:</strong> <span id="currentTrustDisplay">None selected</span>
                </div>
                <div class="trust-search-container">
                    <input 
                        type="text" 
                        id="trustSearchInput" 
                        placeholder="Search for hospital trust..." 
                        class="trust-search-input"
                    />
                </div>
                <div class="trust-list-container">
                    <select id="trustSelect" class="trust-select" size="10">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="hospital-trust-modal-footer">
                    <button id="saveTrustBtn" class="save-trust-btn">Save Selection</button>
                    <button id="clearTrustBtn" class="clear-trust-btn">Clear Selection</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Guideline Scope Selection Modal -->
    <div id="guidelineScopeModal" class="guideline-scope-modal hidden">
        <div class="guideline-scope-modal-content">
            <div class="guideline-scope-modal-header">
                <h2>Select Guidelines to Apply</h2>
                <button id="closeGuidelineScopeModal" class="close-modal-btn">&times;</button>
            </div>
            <div class="guideline-scope-modal-body">
                <p class="guideline-scope-info">Choose which guidelines to apply for your clinical scenario.</p>
                
                <div class="scope-buttons-container">
                    <button id="applyNationalBtn" class="scope-btn scope-btn-national">
                        <span class="scope-btn-title">Apply National Guidelines</span>
                        <span class="scope-btn-desc">NICE, RCOG, and other national bodies</span>
                    </button>
                    <button id="applyLocalBtn" class="scope-btn scope-btn-local">
                        <span class="scope-btn-title">Apply Local Guidelines</span>
                        <span class="scope-btn-desc">Trust-specific protocols</span>
                    </button>
                    <button id="applyBothBtn" class="scope-btn scope-btn-both">
                        <span class="scope-btn-title">Apply Both</span>
                        <span class="scope-btn-desc">National + Local guidelines</span>
                    </button>
                </div>
                
                <div class="scope-trust-display">
                    <div class="scope-trust-info">
                        <strong>Current Trust Selected:</strong> 
                        <span id="scopeTrustDisplay">None selected</span>
                    </div>
                    <div class="scope-trust-actions">
                        <button id="changeTrustBtn" class="change-trust-btn hidden">Change Trust</button>
                        <button id="selectTrustBtn" class="select-trust-btn hidden">Select Trust</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Preferences Modal -->
    <div id="preferencesModal" class="preferences-modal hidden">
        <div class="preferences-modal-content">
            <div class="preferences-modal-header">
                <h2>Preferences</h2>
                <button id="closePreferencesModal" class="close-modal-btn">&times;</button>
            </div>
            <div class="preferences-modal-body">
                <!-- Hospital Trust Section -->
                <div class="preferences-section">
                    <h3>Hospital Trust</h3>
                    <p class="preferences-section-desc">Select your hospital trust to receive contextualised guidance relevant to your working environment.</p>
                    <div class="preferences-trust-display">
                        <strong>Current selection:</strong> <span id="preferencesTrustDisplay">None selected</span>
                    </div>
                    <div class="preferences-trust-actions">
                        <button id="preferencesChangeTrustBtn" class="preferences-btn">Change Trust</button>
                        <button id="preferencesSelectTrustBtn" class="preferences-btn">Select Trust</button>
                        <button id="preferencesClearTrustBtn" class="preferences-btn preferences-btn-secondary">Clear</button>
                    </div>
                </div>
                
                <!-- Dynamic Advice Preferences Section -->
                <div class="preferences-section">
                    <h3>Dynamic Advice Guidelines</h3>
                    <p class="preferences-section-desc">Choose which guidelines to apply when using Dynamic Advice. This preference will be remembered for future sessions.</p>
                    <div class="preferences-scope-display">
                        <strong>Current selection:</strong> <span id="preferencesScopeDisplay">Not set</span>
                    </div>
                    <div class="preferences-scope-buttons">
                        <button id="preferencesNationalBtn" class="preferences-scope-btn preferences-scope-btn-national">
                            <span class="preferences-scope-btn-title">National Guidelines</span>
                            <span class="preferences-scope-btn-desc">NICE, RCOG, and other national bodies</span>
                        </button>
                        <button id="preferencesLocalBtn" class="preferences-scope-btn preferences-scope-btn-local">
                            <span class="preferences-scope-btn-title">Local Guidelines</span>
                            <span class="preferences-scope-btn-desc">Trust-specific protocols</span>
                        </button>
                        <button id="preferencesBothBtn" class="preferences-scope-btn preferences-scope-btn-both">
                            <span class="preferences-scope-btn-title">Both</span>
                            <span class="preferences-scope-btn-desc">National + Local guidelines</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="preferences-modal-footer">
                <button id="preferencesSaveBtn" class="preferences-save-btn">Save Preferences</button>
            </div>
        </div>
    </div>
    
    <!-- Include Firebase initialization -->
    <script type="module" src="firebase-init.js"></script>
    
    <!-- Auto-return to requested page after sign-in -->
    <script type="module">
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
        const auth = window.auth;
        if (auth) {
            onAuthStateChanged(auth, (user) => {
                try {
                    const returnTo = localStorage.getItem('returnToPage');
                    const returnAfterLogin = localStorage.getItem('returnAfterLogin');
                    // Only redirect to a saved page if this was explicitly set during a login flow
                    if (user && returnTo && returnAfterLogin === '1') {
                        localStorage.removeItem('returnToPage');
                        localStorage.removeItem('returnAfterLogin');
                        window.location.href = returnTo;
                    } else if (returnAfterLogin !== '1' && returnTo) {
                        // Safety: clear stale returnTo without redirecting
                        localStorage.removeItem('returnToPage');
                    }
                } catch (e) {
                    // ignore
                }
            });
        }
    </script>

    <!-- Define server URL -->
    <script>
        window.SERVER_URL = 'https://clerky-uzni.onrender.com';
    </script>

    <!-- TipTap Editor - Load from CDN -->
    <script type="module">
        // Import TipTap from CDN (esm.sh ensures single shared dependency graph)
        import { Editor } from 'https://esm.sh/@tiptap/core@2.1.13';
        import StarterKit from 'https://esm.sh/@tiptap/starter-kit@2.1.13';
        import Placeholder from 'https://esm.sh/@tiptap/extension-placeholder@2.1.13';
        import TextStyle from 'https://esm.sh/@tiptap/extension-text-style@2.1.13';
        import Color from 'https://esm.sh/@tiptap/extension-color@2.1.13';
        
        // Create global editors object
        window.editors = window.editors || {};
        
        // Initialize userInput editor when DOM is ready
        function initUserInputEditor() {
            const element = document.getElementById('userInput');
            if (!element) {
                console.warn('userInput element not found');
                return;
            }
            
            try {
                const editor = new Editor({
                    element: element,
                    extensions: [
                        StarterKit.configure({
                            history: {
                                depth: 100,
                            },
                        }),
                        TextStyle,
                        Color,
                        Placeholder.configure({
                            placeholder: 'Record a transcript, enter a clinical note or ask a question here...'
                        })
                    ],
                    content: '',
                    editable: true,
                    autofocus: false,
                });
                
                // Basic editor setup
                editor.on('create', () => {
                    console.log('[TIPTAP] Editor created, ensuring editability');
                    const proseMirror = element.querySelector('.ProseMirror');
                    if (proseMirror) {
                        proseMirror.setAttribute('contenteditable', 'true');
                        proseMirror.setAttribute('tabindex', '0');
                        proseMirror.style.outline = 'none';
                        proseMirror.style.minHeight = '150px';
                        proseMirror.style.cursor = 'text';
                        console.log('[TIPTAP] Editor made editable and focusable');
                    }
                });
                
                window.editors.userInput = editor;
                console.log('[TIPTAP] userInput editor initialized successfully');
                
                // Dispatch event to notify other scripts
                window.dispatchEvent(new CustomEvent('tiptapReady'));
            } catch (error) {
                console.error('[TIPTAP] Failed to initialize editor:', error);
            }
        }
        
        // Defer initialization until after critical data loads
        // Listen for custom event from main app initialization
        window.addEventListener('criticalDataLoaded', () => {
            console.log('[TIPTAP] Critical data loaded, initializing editor...');
            initUserInputEditor();
        });
        
        // Store function globally so it can be called manually if needed
        window.initTipTapEditor = initUserInputEditor;
    </script>
    
    <!-- Anonymisation module -->
    <script type="module" src="anonymisation.js"></script>
    
    <!-- Cache Manager - Load before main script -->
    <script src="cache-manager.js"></script>
    
    <!-- Main application script -->
    <script type="module" src="script.js"></script>

    <!-- Column layout functionality -->
    <script>
        window.addEventListener('DOMContentLoaded', function() {
            const fixColumnLayout = () => {
                const threeColumnView = document.getElementById('threeColumnView');
                const historyColumn = document.getElementById('historyColumn');
                const transcriptColumn = document.getElementById('transcriptColumn');
                const issuesColumn = document.getElementById('issuesColumn');
                
                if (threeColumnView && historyColumn && transcriptColumn && issuesColumn) {
                    // Force layout recalculation in case something broke it
                    threeColumnView.style.display = 'grid';
                    const columnWidth = window.innerWidth > 768 
                        ? ['20fr', '80fr']
                        : ['1fr'];
                    
                    if (window.innerWidth > 768) {
                        threeColumnView.style.gridTemplateColumns = columnWidth.join(' ');
                        threeColumnView.style.gridTemplateAreas = '"history transcript"';
                    } else {
                        threeColumnView.style.gridTemplateColumns = columnWidth[0];
                        threeColumnView.style.gridTemplateAreas = '"transcript" "history"';
                    }
                }
            };
            
            // Apply layout fixes when page loads
            fixColumnLayout();
            
            // Also fix layout on window resize
            window.addEventListener('resize', fixColumnLayout);
        });
    </script>
</body>
</html>